{% extends "base.html" %}
{% block content %}

{# helper: пусто вместо None/nan #}
{% macro val(v) -%}
  {{ (v|default('', true) ~ '')|replace('nan','') }}
{%- endmacro %}

<h2>Preview & Edit Import</h2>

<div class="mb-2">
  <button class="btn btn-primary"
          form="import-form"
          name="save"
          value="1"
          type="submit">
    Save edits (stay in preview)
  </button>
  <a class="btn btn-secondary" href="{{ url_for('inventory.import_parts_upload') }}">Cancel</a>
</div>

<div class="mb-2">
  <button id="add-row" class="btn btn-sm btn-outline-info" type="button">
    Add blank row
  </button>
</div>

<form method="POST"
      id="import-form"
      action="{{ url_for('inventory.import_parts_upload') }}">
  <input type="hidden" name="saved_path" value="{{ saved_path }}">
  <input type="hidden" name="supplier_hint" value="{{ supplier_hint|default('') }}">

  {# ВАЖНО: эти три скрытых поля удовлетворяют _units_re (brand/model/serial) #}
  <input type="hidden" name="units[0][brand]"  value="">
  <input type="hidden" name="units[0][model]"  value="">
  <input type="hidden" name="units[0][serial]" value="">

  <div class="table-responsive">
    <table id="edit-table" class="table table-striped table-sm align-middle">
      <thead>
        <tr>
          <th>PART #</th>
          <th>DESCRIPTION</th>
          <th style="width:88px">QTY</th>
          <th style="width:120px">UNIT COST</th>
          <th style="width:120px">LOCATION</th>
          <th style="width:40px">Del</th>
        </tr>
      </thead>
      <tbody>
      {% for r in rows %}
        <tr>
          <td>
            <input class="form-control form-control-sm"
                   name="units[0][rows][{{ loop.index0 }}][part_number]"
                   value="{{ val(r.part_number) }}"
                   autocomplete="off">
          </td>
          <td>
            <input class="form-control form-control-sm"
                   name="units[0][rows][{{ loop.index0 }}][part_name]"
                   value="{{ val(r.part_name) }}"
                   autocomplete="off">
          </td>
          <td>
            <input class="form-control form-control-sm"
                   name="units[0][rows][{{ loop.index0 }}][quantity]"
                   value="{{ val(r.quantity) }}"
                   inputmode="numeric">
          </td>
          <td>
            <input class="form-control form-control-sm"
                   name="units[0][rows][{{ loop.index0 }}][unit_cost]"
                   value="{{ val(r.unit_cost) }}"
                   inputmode="decimal">
          </td>
          <td>
            <input class="form-control form-control-sm"
                   name="units[0][rows][{{ loop.index0 }}][location]"
                   value="{{ val(r.location) }}">
          </td>
          <td>
            <button class="btn btn-sm btn-outline-danger del-row" type="button" aria-label="Delete row">×</button>
          </td>
        </tr>
      {% endfor %}
      </tbody>
    </table>
  </div>

  <div class="mt-2">
    <button class="btn btn-primary" name="save"  value="1" type="submit">Save edits (stay in preview)</button>
    <button class="btn btn-success" name="apply" value="1" type="submit">Apply import</button>
    <a class="btn btn-secondary" href="{{ url_for('inventory.import_parts_upload') }}">Cancel</a>
  </div>
</form>

<script>
  // Добавить пустую строку
  document.getElementById('add-row').addEventListener('click', () => {
    const tbody = document.querySelector('#edit-table tbody');
    const idx = tbody.children.length;
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><input class="form-control form-control-sm" name="units[0][rows][${idx}][part_number]" autocomplete="off"></td>
      <td><input class="form-control form-control-sm" name="units[0][rows][${idx}][part_name]"   autocomplete="off"></td>
      <td><input class="form-control form-control-sm" name="units[0][rows][${idx}][quantity]"    value="1" inputmode="numeric"></td>
      <td><input class="form-control form-control-sm" name="units[0][rows][${idx}][unit_cost]"   inputmode="decimal"></td>
      <td><input class="form-control form-control-sm" name="units[0][rows][${idx}][location]"    value="MAIN"></td>
      <td><button class="btn btn-sm btn-outline-danger del-row" type="button">×</button></td>`;
    tbody.appendChild(tr);
    applySupplierDefaultToLocations(); // применим дефолт и к новой строке
  });

  // Удаление строки
  document.addEventListener('click', (e) => {
    if (e.target.classList.contains('del-row')) {
      e.preventDefault();
      e.target.closest('tr')?.remove();
    }
  });

  // ---- АВТО-ПРАВКА LOCATION ПО ПОСТАВЩИКУ (надёжная и деликатная) ----
  function supplierDefaultFromHint(hint) {
    const s = (hint || '').toLowerCase();
    if (s.includes('reliable')) return 'REL';
    if (s.includes('marcon'))   return 'MAR';
    if (s.includes('sears'))    return 'SEARS';
    return 'MAIN';
  }

  function looksLikeReliable(source, hint) {
    return /reliable/i.test(source || '') || /reliable/i.test(hint || '');
  }
  function looksLikeMarcone(source, hint) {
    return /marcon/i.test(source || '') || /marcon/i.test(hint || '');
  }

  function applySupplierDefaultToLocations() {
    const supplierHint = (document.querySelector('input[name="supplier_hint"]')?.value || '').trim();
    const savedPath    = (document.querySelector('input[name="saved_path"]')?.value || '').trim();
    const defLoc       = supplierDefaultFromHint(supplierHint);

    document.querySelectorAll('input[name^="units[0][rows]"][name$="[location]"]').forEach(inp => {
      const cur = (inp.value || '').trim().toUpperCase();

      // 1) если пусто — ставим дефолт
      if (!cur) {
        inp.value = defLoc;
        return;
      }

      // 2) если это "чужой" дефолт и файл/подсказка явно другого вендора — мягко исправим
      if (looksLikeReliable(savedPath, supplierHint) && cur === 'MAR') {
        inp.value = 'REL';
        return;
      }
      if (looksLikeMarcone(savedPath, supplierHint) && cur === 'REL') {
        inp.value = 'MAR';
        return;
      }
      // Иначе — не трогаем (считаем, что пользователь уже редактировал)
    });
  }

  // запустим на первом рендере
  applySupplierDefaultToLocations();
</script>
{% endblock %}
