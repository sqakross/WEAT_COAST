{% extends "base.html" %}

{% block content %}
<div class="container-fluid py-4 d-flex justify-content-center">
  <div style="width:100%; max-width:1100px;">

    <!-- sticky header / toolbar -->
    <div class="d-flex flex-wrap justify-content-between align-items-start mb-3"
         style="position:sticky; top:0; z-index:10; background:#f8f9fa; padding:.5rem 0; border-bottom:1px solid #dee2e6;">
      <div class="me-3">
        <div class="fw-semibold text-uppercase" style="font-size:1rem; letter-spacing:.03em; line-height:1.2;">
          User Management
        </div>
        <div class="text-muted" style="font-size:.8rem; line-height:1.2;">
          Add new users, assign roles, reset passwords
        </div>
      </div>

      <div class="d-flex flex-column flex-sm-row gap-2 mt-2 mt-sm-0">
        <a href="{{ url_for('inventory.dashboard') }}"
           class="btn btn-outline-secondary btn-sm shadow-sm"
           style="font-weight:500; min-width:140px; border-radius:.6rem;">
          ‚Üê Back to Dashboard
        </a>
      </div>
    </div>

    <!-- main layout: left table, right create card -->
    <div class="row g-4">

      <!-- LEFT SIDE: User list -->
      <div class="col-lg-7">

        <!-- search bar -->
        <div class="card shadow-sm border-0 mb-3"
             style="border-radius:1rem; background:linear-gradient(#ffffff,#fdfdfd);">
          <div class="card-body py-3">
            <label class="form-label fw-semibold mb-1" style="font-size:.8rem; text-transform:uppercase; letter-spacing:.05em;">
              Search Users
            </label>
            <input id="usersSearch"
                   class="form-control form-control-sm"
                   placeholder="Search by username or role‚Ä¶"
                   style="border-radius:.6rem; font-size:.9rem;">
          </div>
        </div>

        <!-- table wrapper card -->
        <div class="card shadow-sm border-0"
             style="border-radius:1rem; overflow:hidden;">
          <div class="card-header bg-white border-0"
               style="padding: .9rem 1rem .4rem 1rem; border-bottom:1px solid #dee2e6;">
            <div class="fw-semibold text-uppercase"
                 style="font-size:.8rem; letter-spacing:.05em; color:#6c757d;">
              Existing Users
            </div>
          </div>

          <div class="table-responsive">
            <table class="table align-middle mb-0" style="font-size:.9rem;">
              <thead class="table-light" style="font-size:.75rem; text-transform:uppercase; letter-spacing:.05em;">
                <tr>
                  <th style="min-width:180px;">Username</th>
                  <th style="min-width:130px;">Role</th>
                  <th class="text-end" style="min-width:200px;">Actions</th>
                </tr>
              </thead>
              <tbody id="usersTbody" style="vertical-align:middle;">
                {% for u in users %}
                {% set r=(u.role or '')|lower %}
                <tr style="border-top:1px solid #f1f1f1;">
                  <!-- username + "this is you" -->
                  <td style="font-weight:500; color:#212529;">
                    <div style="font-size:.95rem; line-height:1.2;">
                      {{ u.username }}
                    </div>
                    {% if u.id == current_user.id %}
                      <div class="text-muted" style="font-size:.7rem; line-height:1.2;">
                        This is you
                      </div>
                    {% endif %}
                  </td>

                  <!-- role badge -->
                  <td>
                    {% if r=='superadmin' %}
                      <span class="badge rounded-pill"
                            style="background:#212529; font-size:.7rem; font-weight:600; padding:.4rem .6rem;">
                        SUPERADMIN
                      </span>
                    {% elif r=='admin' %}
                      <span class="badge rounded-pill"
                            style="background:#0d6efd; font-size:.7rem; font-weight:600; padding:.4rem .6rem;">
                        ADMIN
                      </span>
                    {% elif r=='technician' %}
                      <span class="badge rounded-pill"
                            style="background:#198754; font-size:.7rem; font-weight:600; padding:.4rem .6rem;">
                        TECHNICIAN
                      </span>
                    {% elif r=='viewer' %}
                      <span class="badge rounded-pill"
                            style="background:#6c757d; font-size:.7rem; font-weight:600; padding:.4rem .6rem;">
                        VIEWER
                      </span>
                    {% else %}
                      <span class="badge rounded-pill text-dark border"
                            style="background:#f8f9fa; font-size:.7rem; font-weight:600; padding:.4rem .6rem; border-color:#ced4da !important;">
                        USER
                      </span>
                    {% endif %}
                  </td>

                  <!-- actions -->
                  <td class="text-end">
                    <div class="d-flex flex-wrap justify-content-end gap-2">

                      {% if (current_user.role or '')|lower == 'superadmin'
                            or ((current_user.role or '')|lower == 'admin' and (u.role or '')|lower in ['user','viewer','technician'])
                            or u.id == current_user.id %}

                        <!-- Edit -->
                        <a class="btn btn-light btn-sm border shadow-sm"
                           style="font-weight:500; line-height:1.2; border-radius:.6rem; min-width:70px;"
                           href="{{ url_for('inventory.edit_user', user_id=u.id) }}">
                          ‚úèÔ∏è Edit
                        </a>

                        <!-- Change Password (open modal) -->
                        <button class="btn btn-primary btn-sm shadow-sm"
                                style="font-weight:500; line-height:1.2; border-radius:.6rem; min-width:120px; box-shadow:0 .3rem .6rem rgba(13,110,253,.25)!important;"
                                data-user-id="{{ u.id }}"
                                data-username="{{ u.username }}"
                                data-need-current="{% if (current_user.role or '')|lower != 'superadmin' and current_user.id == u.id %}1{% else %}0{% endif %}"
                                onclick="openPasswordModal(this)">
                          üîê Change
                        </button>

                        {% if (current_user.role or '')|lower == 'superadmin' and u.id != current_user.id %}
                        <!-- Delete -->
                        <form method="post"
                              action="{{ url_for('inventory.delete_user', user_id=u.id) }}"
                              onsubmit="return confirm('Delete user {{u.username}}?');"
                              class="m-0 p-0">
                          <button class="btn btn-danger btn-sm shadow-sm"
                                  style="font-weight:500; line-height:1.2; border-radius:.6rem; min-width:80px; box-shadow:0 .3rem .6rem rgba(220,53,69,.3)!important;"
                                  type="submit">
                            üóëÔ∏è Delete
                          </button>
                        </form>
                        {% endif %}

                      {% else %}
                        <span class="text-muted" style="font-size:.8rem;">‚Äî</span>
                      {% endif %}

                    </div>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>

          <div class="card-footer bg-white text-muted"
               style="font-size:.7rem; line-height:1.2; border-top:1px solid #dee2e6;">
            Roles define access to inventory / issue / receiving screens.
          </div>
        </div>
      </div>

      <!-- RIGHT SIDE: Create new user -->
      <div class="col-lg-5">

        <div class="card shadow-sm border-0"
             style="border-radius:1rem; background:linear-gradient(#ffffff,#fdfdfd); box-shadow:0 .5rem 1rem rgba(0,0,0,.07)!important;">
          <div class="card-header bg-white border-0"
               style="border-radius:1rem 1rem 0 0; border-bottom:1px solid #dee2e6;">
            <div class="fw-semibold text-uppercase"
                 style="font-size:.8rem; letter-spacing:.05em; color:#6c757d;">
              Create New User
            </div>
          </div>

          <div class="card-body">

            <!-- –í–ê–ñ–ù–û: –ø–æ—Å—Ç–∏–º –Ω–∞ —Ç–æ—Ç –∂–µ —Ä–æ—É—Ç /users -->
            <form method="post" action="{{ url_for('inventory.users') }}">
              <div class="mb-3">
                <label class="form-label fw-semibold mb-1"
                       style="font-size:.8rem; text-transform:uppercase; letter-spacing:.05em;">
                  Username
                </label>
                <input name="username"
                       class="form-control form-control-sm"
                       placeholder="e.g. tech.john"
                       required
                       style="border-radius:.6rem; font-size:.9rem;">
                <div class="form-text" style="font-size:.7rem; line-height:1.2;">
                  This will be used for login.
                </div>
              </div>

              <div class="mb-3">
                <label class="form-label fw-semibold mb-1"
                       style="font-size:.8rem; text-transform:uppercase; letter-spacing:.05em;">
                  Password
                </label>
                <input type="password"
                       name="password"
                       class="form-control form-control-sm"
                       required
                       style="border-radius:.6rem; font-size:.9rem;">
                <div class="form-text" style="font-size:.7rem; line-height:1.2;">
                  You can force reset later.
                </div>
              </div>

              <div class="mb-4">
                <label class="form-label fw-semibold mb-1"
                       style="font-size:.8rem; text-transform:uppercase; letter-spacing:.05em;">
                  Role
                </label>
                <select name="role"
                        class="form-select form-select-sm"
                        style="border-radius:.6rem; font-size:.9rem;">
                  {% for value, caption in role_options %}
                    {% if value == 'superadmin' and (current_user.role or '')|lower != 'superadmin' %}
                      {# —Å–∫—Ä—ã–≤–∞–µ–º superadmin –µ—Å–ª–∏ —Ç—ã –Ω–µ —Å—É–ø–µ—Ä–∞–¥–º–∏–Ω #}
                    {% else %}
                      <option value="{{ value }}"
                              {% if value=='technician' %}selected{% endif %}>
                        {{ caption }}
                      </option>
                    {% endif %}
                  {% endfor %}
                </select>

                <div class="form-text" style="font-size:.7rem; line-height:1.2;">
                  If unsure, choose <span class="fw-semibold">Technician</span> (limited access).
                </div>
              </div>

              <div class="d-grid">
                <button class="btn btn-primary shadow-sm"
                        type="submit"
                        style="font-weight:600; border-radius:.8rem; padding:.6rem 1rem; font-size:.9rem; box-shadow:0 .5rem 1rem rgba(13,110,253,.35)!important;">
                  ‚ûï Create User
                </button>
              </div>

            </form>
          </div>

          <div class="card-footer bg-white text-muted"
               style="font-size:.7rem; line-height:1.2; border-top:1px solid #dee2e6;">
            superadmin = full access, admin = manage users & stock,
            technician = issue parts, viewer = read-only.
          </div>
        </div>
      </div>

    </div> <!-- /row -->

  </div>
</div>

<!-- PASSWORD CHANGE MODAL -->
<div class="modal fade" id="pwModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered" style="max-width:400px;">
    <div class="modal-content" style="border-radius:1rem;">
      <div class="modal-header">
        <h5 class="modal-title" id="pwModalTitle" style="font-weight:600; font-size:1rem;">
          Change Password
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <form id="pwForm">
        <div class="modal-body">

          <input type="hidden" name="__user_id" id="pwUserId">
          <div class="mb-2">
            <label class="form-label fw-semibold mb-1" style="font-size:.8rem;">
              User
            </label>
            <input class="form-control form-control-sm"
                   id="pwUsernameDisplay"
                   disabled
                   style="border-radius:.6rem; font-size:.9rem;">
          </div>

          <div class="mb-2" id="pwCurrentWrap">
            <label class="form-label fw-semibold mb-1" style="font-size:.8rem;">
              Current Password
            </label>
            <input class="form-control form-control-sm"
                   type="password"
                   name="current_password"
                   style="border-radius:.6rem; font-size:.9rem;">
            <div class="form-text" style="font-size:.7rem; line-height:1.2;">
              Required if you're changing your own password (non-superadmin).
            </div>
          </div>

          <div class="mb-2">
            <label class="form-label fw-semibold mb-1" style="font-size:.8rem;">
              New Password
            </label>
            <input class="form-control form-control-sm"
                   type="password"
                   name="password"
                   required
                   style="border-radius:.6rem; font-size:.9rem;">
          </div>

          <div class="mb-2">
            <label class="form-label fw-semibold mb-1" style="font-size:.8rem;">
              Confirm New Password
            </label>
            <input class="form-control form-control-sm"
                   type="password"
                   name="confirm_password"
                   required
                   style="border-radius:.6rem; font-size:.9rem;">
          </div>

          <div id="pwAlert" class="alert p-2 mt-3 d-none"
               style="font-size:.8rem; border-radius:.6rem;"></div>
        </div>

        <div class="modal-footer">
          <button type="button"
                  class="btn btn-outline-secondary btn-sm"
                  data-bs-dismiss="modal"
                  style="border-radius:.6rem;">
            Cancel
          </button>
          <button type="submit"
                  class="btn btn-primary btn-sm"
                  style="border-radius:.6rem; font-weight:600;">
            Save
          </button>
        </div>
      </form>

    </div>
  </div>
</div>

<!-- floating toast / inline success -->
<div id="pwToast"
     class="alert alert-success shadow-sm position-fixed d-none"
     style="right:1rem; bottom:1rem; min-width:220px; max-width:280px; font-size:.8rem; line-height:1.3; border-radius:.6rem; z-index:9999;">
  Password updated
</div>

{% endblock %}


{% block extra_js %}
<script>
  // live search in table
  (function(){
    const q = document.getElementById('usersSearch');
    const tbody = document.getElementById('usersTbody');
    if (!q || !tbody) return;
    q.addEventListener('input', ()=>{
      const needle = (q.value||'').toLowerCase();
      [...tbody.querySelectorAll('tr')].forEach(tr=>{
        const text = tr.textContent.toLowerCase();
        tr.style.display = text.includes(needle) ? '' : 'none';
      });
    });
  })();

  let pwModal;
  document.addEventListener('DOMContentLoaded', () => {
    const el = document.getElementById('pwModal');
    if (window.bootstrap && bootstrap.Modal) {
      pwModal = new bootstrap.Modal(el);
    }
  });

  // open modal, fill fields
  function openPasswordModal(btn) {
    const userId   = btn.getAttribute('data-user-id');
    const username = btn.getAttribute('data-username');
    const needCur  = btn.getAttribute('data-need-current') === '1';

    document.getElementById('pwUserId').value = userId;
    document.getElementById('pwUsernameDisplay').value = username;

    const curWrap = document.getElementById('pwCurrentWrap');
    if (needCur) {
      curWrap.classList.remove('d-none');
    } else {
      curWrap.classList.add('d-none');
    }

    // clear inputs each open
    const form = document.getElementById('pwForm');
    form.current_password && (form.current_password.value = '');
    form.password.value = '';
    form.confirm_password.value = '';
    clearPwAlert();

    pwModal && pwModal.show();
  }
  window.openPasswordModal = openPasswordModal;

  function showPwAlert(msg, isError) {
    const box = document.getElementById('pwAlert');
    box.classList.remove('d-none','alert-danger','alert-success');
    box.classList.add(isError ? 'alert-danger':'alert-success');
    box.textContent = msg;
  }

  function clearPwAlert() {
    const box = document.getElementById('pwAlert');
    box.classList.add('d-none');
    box.textContent = '';
    box.classList.remove('alert-danger','alert-success');
  }

  function showToast(msg) {
    const toast = document.getElementById('pwToast');
    toast.textContent = msg || 'Password updated';
    toast.classList.remove('d-none');
    setTimeout(()=> {
      toast.classList.add('d-none');
    }, 4000);
  }

  // submit password change via fetch
  document.getElementById('pwForm').addEventListener('submit', async (e)=>{
    e.preventDefault();

    clearPwAlert();

    const formEl  = e.target;
    const userId  = document.getElementById('pwUserId').value;

    const fd = new FormData();
    // include current_password only if field visible
    const curWrapHidden = document.getElementById('pwCurrentWrap').classList.contains('d-none');
    if (!curWrapHidden) {
      fd.append('current_password', formEl.current_password.value || '');
    }
    fd.append('password',          formEl.password.value || '');
    fd.append('confirm_password',  formEl.confirm_password.value || '');

    try {
      const resp = await fetch(`/users/change_password/${userId}`, {
        method: 'POST',
        headers: {
            'X-Requested-With': 'fetch'
        },
        body: fd
      });


      const data = await resp.json().catch(()=>null);

      if (!resp.ok || !data || !data.ok) {
        const msg = (data && data.error) ? data.error : 'Error updating password';
        showPwAlert(msg, true);
        return;
      }

      // success
      pwModal && pwModal.hide();
      showToast('Password updated for ' + document.getElementById('pwUsernameDisplay').value);

    } catch(err) {
      showPwAlert('Network / server error', true);
    }
  });
</script>
{% endblock %}
