{% extends "base.html" %}
{% block content %}

{# ----- статус батча + флаг супер-админа из контекста ----- #}
{% set is_posted = batch and (batch.status or '')|lower == 'posted' %}
{% set is_superadmin = IS_SUPERADMIN %}

<div class="container-fluid py-4 d-flex justify-content-center">
  <div style="width:100%; max-width:1100px;">

    <!-- Sticky header / toolbar -->
    <div class="d-flex flex-wrap justify-content-between align-items-start mb-3"
         style="position:sticky; top:0; z-index:10; background:#f8f9fa; padding:.5rem .75rem; border:1px solid #dee2e6; border-radius:.5rem;">
      <div class="me-3">
        <h2 class="mb-1 fw-semibold" style="font-size:1.1rem;">
          {{ 'Edit Receiving' if batch else 'New Receiving' }}
        </h2>
        <div class="text-muted" style="font-size:.8rem; line-height:1.2;">
          Enter invoice + parts, add Extra expenses (shipping etc), then Receive &amp; Post Stock.
          This will update on-hand inventory immediately.
        </div>
      </div>

      <div class="d-flex flex-wrap gap-2 mt-2 mt-sm-0">
        <a class="btn btn-outline-secondary btn-sm"
           href="{{ url_for('inventory.receiving_list') }}"
           style="min-width:90px;">
          ← Back
        </a>
      </div>
    </div>

    <!-- The actual form -->
    <form id="recvForm"
          method="post"
          action="{{ url_for('inventory.receiving_save') }}"
          class="card shadow-sm border-0">

      <div class="card-body">

        {# batch_id only if editing existing #}
        {% if batch %}
          <input type="hidden" name="batch_id" value="{{ batch.id }}">
        {% endif %}

        <!-- hidden that will carry extra_expenses number to backend -->
        <input type="hidden"
               id="extra_expenses_hidden"
               name="extra_expenses"
               value="{{ '%.2f' % (batch.extra_expenses or 0) if batch else '0.00' }}">

        <!-- Invoice / header fields -->
        <div class="row g-3 mb-3">

          <div class="col-md-4">
            <label class="form-label fw-semibold" style="font-size:.9rem;">
              Supplier <span class="text-danger">*</span>
            </label>
            <input name="supplier_name"
                   id="supplier_input"
                   class="form-control form-control-sm"
                   required
                   value="{{ batch.supplier_name if batch else '' }}"
                   {% if is_posted and not is_superadmin %}readonly{% endif %}>
          </div>

          <div class="col-md-4">
            <label class="form-label fw-semibold" style="font-size:.9rem;">
              Invoice # <span class="text-danger">*</span>
            </label>
            <input name="invoice_number"
                   class="form-control form-control-sm"
                   required
                   value="{{ batch.invoice_number if batch else '' }}"
                   {% if is_posted and not is_superadmin %}readonly{% endif %}>
          </div>

          <div class="col-md-4">
            <label class="form-label fw-semibold" style="font-size:.9rem;">Invoice Date</label>
            <input name="invoice_date"
                   type="date"
                   class="form-control form-control-sm"
                   max="{{ today }}"
                   value="{{ batch.invoice_date if batch else today }}"
                   {% if is_posted and not is_superadmin %}readonly{% endif %}>
          </div>

          <div class="col-md-2">
            <label class="form-label fw-semibold" style="font-size:.9rem;">Currency</label>
            <input name="currency"
                   class="form-control form-control-sm"
                   value="{{ batch.currency if batch else 'USD' }}"
                   {% if is_posted and not is_superadmin %}readonly{% endif %}>
          </div>

          <div class="col-md-5">
            <label class="form-label fw-semibold" style="font-size:.9rem;">
              Notes
            </label>
            <input name="notes"
                   class="form-control form-control-sm"
                   value="{{ batch.notes if batch else '' }}"
                   {% if is_posted and not is_superadmin %}readonly{% endif %}>
          </div>

          <div class="col-md-5">
            <label class="form-label fw-semibold d-flex justify-content-between align-items-center"
                   style="font-size:.9rem;">
              <span>Extra expenses ($)</span>
              <small class="text-muted" style="font-size:.7rem; font-weight:400;">
                shipping / handling / tax
              </small>
            </label>
            <input id="extra_expenses_input"
                   type="number"
                   min="0"
                   step="0.01"
                   class="form-control form-control-sm text-end"
                   value="{{ '%.2f' % (batch.extra_expenses or 0) if batch else '0.00' }}"
                   {% if is_posted %}readonly{% endif %}>
          </div>

        </div>

        <!-- Items header row -->
        <div class="d-flex flex-wrap justify-content-between align-items-center mb-2">
          <h5 class="mb-0 fw-semibold" style="font-size:1rem;">Items</h5>
          {% if not is_posted %}
          <button class="btn btn-outline-secondary btn-sm"
                  type="button"
                  onclick="addRow()"
                  style="min-width:100px;">
            + Add Row
          </button>
          {% endif %}
        </div>

        <!-- Items table -->
        <div class="table-responsive border rounded" style="max-height:60vh; overflow-y:auto;">
          <table class="table table-sm align-middle mb-0" id="rowsTable"
                 style="font-size:.85rem;">
            <thead class="table-light" style="position:sticky; top:0; z-index:5;">
              <tr>
                <th style="min-width:120px;">Part #</th>
                <th style="min-width:160px;">Part Name</th>
                <th style="width:80px;">Qty</th>
                <th style="width:120px;">Base Cost</th>
                <th style="width:120px;">Adj Cost (+fee)</th>
                <th style="min-width:120px;">Location</th>
                <th style="width:70px;"></th>
              </tr>
            </thead>
            <tbody>
            {% if batch and batch.items %}
              {% for i, it in enumerate(batch.items) %}
                <tr>
                  <td>
                    <input name="rows[{{i}}][part_number]"
                           class="form-control form-control-sm row-pn"
                           value="{{ it.part_number }}"
                           required
                           {% if is_posted %}readonly tabindex="-1"{% endif %}>
                  </td>
                  <td>
                    <input name="rows[{{i}}][part_name]"
                           class="form-control form-control-sm row-name"
                           value="{{ it.part_name or '' }}"
                           {% if is_posted %}readonly tabindex="-1"{% endif %}>
                  </td>
                  <td style="width:80px;">
                    <input name="rows[{{i}}][quantity]"
                           type="number"
                           min="0"
                           class="form-control form-control-sm text-end row-qty"
                           value="{{ it.quantity }}"
                           required
                           {% if is_posted %}readonly tabindex="-1"{% endif %}>
                  </td>
                  <td style="width:120px;">
                    <input name="rows[{{i}}][unit_cost]"
                           type="number"
                           step="0.01"
                           min="0"
                           class="form-control form-control-sm text-end row-basecost"
                           value="{{ it.unit_cost or 0 }}"
                           {% if is_posted %}readonly tabindex="-1"{% endif %}>
                  </td>
                  <td style="width:120px;">
                    <input type="text"
                           class="form-control form-control-sm text-end row-adjcost"
                           value="{{ '%.2f' % (it.unit_cost or 0) }}"
                           readonly
                           tabindex="-1"
                           style="background:#f8f9fa;">
                    <input type="hidden"
                           name="rows[{{i}}][adj_cost]"
                           class="row-adjcost-hidden"
                           value="{{ '%.2f' % (it.unit_cost or 0) }}">
                  </td>
                  <td>
                    <input name="rows[{{i}}][location]"
                           class="form-control form-control-sm row-loc"
                           value="{{ it.location or '' }}"
                           {% if is_posted %}readonly tabindex="-1"{% endif %}>
                  </td>
                  <td class="text-end" style="width:70px;">
                    {% if not is_posted %}
                    <button type="button"
                            class="btn btn-outline-danger btn-sm"
                            onclick="this.closest('tr').remove(); recalcTotals();"
                            style="font-size:.75rem; line-height:1;">
                      Delete
                    </button>
                    {% endif %}
                  </td>
                </tr>
              {% endfor %}
            {% else %}
              <tr>
                <td>
                  <input name="rows[0][part_number]"
                         class="form-control form-control-sm row-pn"
                         required>
                </td>
                <td>
                  <input name="rows[0][part_name]"
                         class="form-control form-control-sm row-name">
                </td>
                <td style="width:80px;">
                  <input name="rows[0][quantity]"
                         type="number"
                         min="0"
                         class="form-control form-control-sm text-end row-qty"
                         value="1"
                         required>
                </td>
                <td style="width:120px;">
                  <input name="rows[0][unit_cost]"
                         type="number"
                         step="0.01"
                         min="0"
                         class="form-control form-control-sm text-end row-basecost"
                         value="0">
                </td>
                <td style="width:120px;">
                  <input type="text"
                         class="form-control form-control-sm text-end row-adjcost"
                         value="0.00"
                         readonly
                         tabindex="-1"
                         style="background:#f8f9fa;">
                  <input type="hidden"
                         name="rows[0][adj_cost]"
                         class="row-adjcost-hidden"
                         value="0.00">
                </td>
                <td>
                  <input name="rows[0][location]"
                         class="form-control form-control-sm row-loc">
                </td>
                <td class="text-end" style="width:70px;">
                  <button type="button"
                          class="btn btn-outline-danger btn-sm"
                          onclick="this.closest('tr').remove(); recalcTotals();"
                          style="font-size:.75rem; line-height:1;">
                    Delete
                  </button>
                </td>
              </tr>
            {% endif %}
            </tbody>
          </table>
        </div>

        <!-- Totals summary -->
        <div class="row g-3 mt-3">
          <div class="col-md-6">
            <div class="small text-muted" style="font-size:.75rem; line-height:1.3;">
              Subtotal is sum of Qty × Base Cost.
              Extra expenses are distributed across items, so Adj Cost will be used for stock valuation.
            </div>
          </div>
          <div class="col-md-6">
            <div class="border rounded p-2"
                 style="font-size:.8rem; background:#f8f9fa;">
              <div class="d-flex justify-content-between">
                <div>Subtotal (parts):</div>
                <div>$ <span id="subtotal_span">0.00</span></div>
              </div>
              <div class="d-flex justify-content-between">
                <div>Extra expenses:</div>
                <div>$ <span id="extra_span">0.00</span></div>
              </div>
              <hr class="my-2">
              <div class="d-flex justify-content-between fw-semibold">
                <div>Grand Total:</div>
                <div>$ <span id="grand_span">0.00</span></div>
              </div>
            </div>
          </div>
        </div>

        <!-- Action buttons -->
        <div class="d-flex flex-wrap gap-2 mt-4">

          {% if not is_posted %}
            <button class="btn btn-primary"
                    type="submit"
                    name="action"
                    value="post"
                    style="min-width:180px; font-weight:500;">
              Receive &amp; Post Stock
            </button>

            <button class="btn btn-outline-secondary"
                    type="submit"
                    name="action"
                    value="draft"
                    style="min-width:140px; font-weight:500;">
              Save Draft (do not post)
            </button>
          {% else %}
            <button class="btn btn-outline-secondary"
                    type="submit"
                    name="action"
                    value="draft"
                    style="min-width:160px; font-weight:500;">
              Save Changes
            </button>
          {% endif %}

          <a class="btn btn-outline-secondary"
             href="{{ url_for('inventory.receiving_list') }}"
             style="min-width:90px; font-weight:500;">
            Cancel
          </a>
        </div>

      </div> <!-- /card-body -->
    </form>

  </div>
</div>

<script>
// ===== helper: get current supplier value =====
function getSupplierValue() {
  const supplierInput = document.getElementById('supplier_input');
  return supplierInput ? supplierInput.value.trim() : '';
}

// ===== apply supplier to all EMPTY location cells =====
function syncLocationsFromSupplier() {
  const supplier = getSupplierValue();
  if (!supplier) return;

  document.querySelectorAll('.row-loc').forEach((inp) => {
    if (!inp.value.trim()) {
      inp.value = supplier;
    }
  });
}

// ===== apply supplier to a single row (for new rows) =====
function applySupplierToRow(tr) {
  const supplier = getSupplierValue();
  if (!supplier || !tr) return;
  const locInput = tr.querySelector('.row-loc');
  if (locInput && !locInput.value.trim()) {
    locInput.value = supplier;
  }
}

function addRow() {
  const tbody = document.querySelector('#rowsTable tbody');
  const idx = tbody.querySelectorAll('tr').length;
  const tr = document.createElement('tr');
  tr.innerHTML = `
    <td>
      <input name="rows[${idx}][part_number]"
             class="form-control form-control-sm row-pn"
             required>
    </td>
    <td>
      <input name="rows[${idx}][part_name]"
             class="form-control form-control-sm row-name">
    </td>
    <td style="width:80px;">
      <input name="rows[${idx}][quantity]"
             type="number"
             min="0"
             class="form-control form-control-sm text-end row-qty"
             value="1"
             required>
    </td>
    <td style="width:120px;">
      <input name="rows[${idx}][unit_cost]"
             type="number"
             step="0.01"
             min="0"
             class="form-control form-control-sm text-end row-basecost"
             value="0">
    </td>
    <td style="width:120px;">
      <input type="text"
             class="form-control form-control-sm text-end row-adjcost"
             value="0.00"
             readonly
             tabindex="-1"
             style="background:#f8f9fa;">
      <input type="hidden"
             name="rows[${idx}][adj_cost]"
             class="row-adjcost-hidden"
             value="0.00">
    </td>
    <td>
      <input name="rows[${idx}][location]"
             class="form-control form-control-sm row-loc">
    </td>
    <td class="text-end" style="width:70px;">
      <button type="button"
              class="btn btn-outline-danger btn-sm"
              onclick="this.closest('tr').remove(); recalcTotals();"
              style="font-size:.75rem; line-height:1;">
        Delete
      </button>
    </td>
  `;
  tbody.appendChild(tr);
  hookRowInputs(tr);
  applySupplierToRow(tr);
  recalcTotals();
}

// recalcTotals: distribute extra_expenses across rows
function recalcTotals() {
  const rows = Array.from(document.querySelectorAll('#rowsTable tbody tr'));

  let subtotal = 0.0;

  rows.forEach(tr => {
    const qtyEl  = tr.querySelector('.row-qty');
    const baseEl = tr.querySelector('.row-basecost');

    const qty  = parseFloat(qtyEl?.value || '0') || 0;
    const base = parseFloat(baseEl?.value || '0') || 0;

    subtotal += qty * base;
  });

  const extraInput = document.getElementById('extra_expenses_input');
  let extraVal = parseFloat(extraInput?.value || '0') || 0;

  rows.forEach(tr => {
    const qtyEl   = tr.querySelector('.row-qty');
    const baseEl  = tr.querySelector('.row-basecost');
    const adjOut  = tr.querySelector('.row-adjcost');
    const adjHid  = tr.querySelector('.row-adjcost-hidden');

    const qty  = parseFloat(qtyEl?.value || '0') || 0;
    const base = parseFloat(baseEl?.value || '0') || 0;

    let adjPerUnit = base;

    if (subtotal > 0 && qty > 0) {
      const lineBaseTotal = qty * base;
      const share = lineBaseTotal / subtotal;
      const extraForLine = extraVal * share;
      const extraPerUnit = extraForLine / qty;
      adjPerUnit = base + extraPerUnit;
    }

    const adjStr = adjPerUnit.toFixed(2);

    if (adjOut) adjOut.value = adjStr;
    if (adjHid) adjHid.value = adjStr;
  });

  const grand = subtotal + extraVal;
  document.getElementById('subtotal_span').textContent = subtotal.toFixed(2);
  document.getElementById('extra_span').textContent    = extraVal.toFixed(2);
  document.getElementById('grand_span').textContent    = grand.toFixed(2);

  const hidden = document.getElementById('extra_expenses_hidden');
  if (hidden) {
    hidden.value = extraVal.toFixed(2);
  }
}

function hookRowInputs(scope) {
  (scope || document).querySelectorAll('.row-qty, .row-basecost').forEach(inp => {
    inp.addEventListener('input', recalcTotals);
  });
}

document.addEventListener('DOMContentLoaded', () => {
  hookRowInputs(document);
  const ee = document.getElementById('extra_expenses_input');
  if (ee) {
    ee.addEventListener('input', recalcTotals);
  }

  const supplierInput = document.getElementById('supplier_input');
  if (supplierInput) {
    supplierInput.addEventListener('change', syncLocationsFromSupplier);
    supplierInput.addEventListener('blur', syncLocationsFromSupplier);
  }

  recalcTotals();
  syncLocationsFromSupplier();
});
</script>

{% endblock %}
