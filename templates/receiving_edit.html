{% extends "base.html" %}
{% block content %}

<div class="container-fluid py-4 d-flex justify-content-center">
  <div style="width:100%; max-width:1100px;">

    <!-- Sticky header / toolbar -->
    <div class="d-flex flex-wrap justify-content-between align-items-start mb-3"
         style="position:sticky; top:0; z-index:10; background:#f8f9fa; padding:.5rem .75rem; border:1px solid #dee2e6; border-radius:.5rem;">
      <div class="me-3">
        <h2 class="mb-1 fw-semibold" style="font-size:1.1rem;">
          {{ 'Edit Receiving' if batch else 'New Receiving' }}
        </h2>
        <div class="text-muted" style="font-size:.8rem; line-height:1.2;">
          Enter invoice + parts, then Receive &amp; Post Stock. This will update on-hand inventory immediately.
        </div>
      </div>

      <div class="d-flex flex-wrap gap-2 mt-2 mt-sm-0">
        <a class="btn btn-outline-secondary btn-sm"
           href="{{ url_for('inventory.receiving_list') }}"
           style="min-width:90px;">
          ‚Üê Back
        </a>
      </div>
    </div>

    <!-- The actual form -->
    <form id="recvForm" method="post" action="{{ url_for('inventory.receiving_save') }}" class="card shadow-sm border-0">
      <div class="card-body">

        {# batch_id only if editing existing #}
        {% if batch %}
          <input type="hidden" name="batch_id" value="{{ batch.id }}">
        {% endif %}

        <!-- Invoice / header fields -->
        <div class="row g-3 mb-3">

          <div class="col-md-4">
            <label class="form-label fw-semibold" style="font-size:.9rem;">
              Supplier <span class="text-danger">*</span>
            </label>
            <input name="supplier_name"
                   class="form-control form-control-sm"
                   required
                   value="{{ batch.supplier_name if batch else '' }}">
          </div>

          <div class="col-md-4">
            <label class="form-label fw-semibold" style="font-size:.9rem;">Invoice #</label>
            <input name="invoice_number"
                   class="form-control form-control-sm"
                   value="{{ batch.invoice_number if batch else '' }}">
          </div>

          <div class="col-md-4">
            <label class="form-label fw-semibold" style="font-size:.9rem;">Invoice Date</label>
            <input name="invoice_date"
                   type="date"
                   class="form-control form-control-sm"
                   value="{{ batch.invoice_date if batch else today }}">
          </div>

          <div class="col-md-2">
            <label class="form-label fw-semibold" style="font-size:.9rem;">Currency</label>
            <input name="currency"
                   class="form-control form-control-sm"
                   value="{{ batch.currency if batch else 'USD' }}">
          </div>

          <div class="col-md-10">
            <label class="form-label fw-semibold" style="font-size:.9rem;">Notes</label>
            <input name="notes"
                   class="form-control form-control-sm"
                   value="{{ batch.notes if batch else '' }}">
          </div>

        </div>

        <!-- Items header row -->
        <div class="d-flex flex-wrap justify-content-between align-items-center mb-2">
          <h5 class="mb-0 fw-semibold" style="font-size:1rem;">Items</h5>
          <button class="btn btn-outline-secondary btn-sm"
                  type="button"
                  onclick="addRow()"
                  style="min-width:100px;">
            + Add Row
          </button>
        </div>

        <!-- Items table -->
        <div class="table-responsive border rounded" style="max-height:60vh; overflow-y:auto;">
          <table class="table table-sm align-middle mb-0" id="rowsTable"
                 style="font-size:.85rem;">
            <thead class="table-light" style="position:sticky; top:0; z-index:5;">
              <tr>
                <th style="min-width:120px;">Part #</th>
                <th style="min-width:160px;">Part Name</th>
                <th style="width:80px;">Qty</th>
                <th style="width:120px;">Unit Cost</th>
                <th style="min-width:120px;">Location</th>
                <th style="width:70px;"></th>
              </tr>
            </thead>
            <tbody>
            {% if batch and batch.items %}
              {% for i, it in enumerate(batch.items) %}
                <tr>
                  <td>
                    <input name="rows[{{i}}][part_number]"
                           class="form-control form-control-sm"
                           value="{{ it.part_number }}"
                           required>
                  </td>
                  <td>
                    <input name="rows[{{i}}][part_name]"
                           class="form-control form-control-sm"
                           value="{{ it.part_name or '' }}">
                  </td>
                  <td style="width:80px;">
                    <input name="rows[{{i}}][quantity]"
                           type="number"
                           min="0"
                           class="form-control form-control-sm text-end"
                           value="{{ it.quantity }}"
                           required>
                  </td>
                  <td style="width:120px;">
                    <input name="rows[{{i}}][unit_cost]"
                           type="number"
                           step="0.01"
                           min="0"
                           class="form-control form-control-sm text-end"
                           value="{{ it.unit_cost or 0 }}">
                  </td>
                  <td>
                    <input name="rows[{{i}}][location]"
                           class="form-control form-control-sm"
                           value="{{ it.location or '' }}">
                  </td>
                  <td class="text-end" style="width:70px;">
                    <button type="button"
                            class="btn btn-outline-danger btn-sm"
                            onclick="this.closest('tr').remove()"
                            style="font-size:.75rem; line-height:1;">
                      Delete
                    </button>
                  </td>
                </tr>
              {% endfor %}
            {% else %}
              <tr>
                <td>
                  <input name="rows[0][part_number]"
                         class="form-control form-control-sm"
                         required>
                </td>
                <td>
                  <input name="rows[0][part_name]"
                         class="form-control form-control-sm">
                </td>
                <td style="width:80px;">
                  <input name="rows[0][quantity]"
                         type="number"
                         min="0"
                         class="form-control form-control-sm text-end"
                         value="1"
                         required>
                </td>
                <td style="width:120px;">
                  <input name="rows[0][unit_cost]"
                         type="number"
                         step="0.01"
                         min="0"
                         class="form-control form-control-sm text-end"
                         value="0">
                </td>
                <td>
                  <input name="rows[0][location]"
                         class="form-control form-control-sm">
                </td>
                <td class="text-end" style="width:70px;">
                  <button type="button"
                          class="btn btn-outline-danger btn-sm"
                          onclick="this.closest('tr').remove()"
                          style="font-size:.75rem; line-height:1;">
                    Delete
                  </button>
                </td>
              </tr>
            {% endif %}
            </tbody>
          </table>
        </div>

        <!-- Action buttons -->
        <div class="d-flex flex-wrap gap-2 mt-3">

          <!-- One primary action: receive + post stock immediately -->
          <button class="btn btn-primary"
                  type="submit"
                  style="min-width:160px; font-weight:500;">
            Receive &amp; Post Stock
          </button>

          <a class="btn btn-outline-secondary"
             href="{{ url_for('inventory.receiving_list') }}"
             style="min-width:90px; font-weight:500;">
            Cancel
          </a>
        </div>

      </div> <!-- /card-body -->
    </form>

  </div>
</div>

<script>
function addRow() {
  const tbody = document.querySelector('#rowsTable tbody');
  const idx = tbody.querySelectorAll('tr').length;
  const tr = document.createElement('tr');
  tr.innerHTML = `
    <td>
      <input name="rows[${idx}][part_number]"
             class="form-control form-control-sm"
             required>
    </td>
    <td>
      <input name="rows[${idx}][part_name]"
             class="form-control form-control-sm">
    </td>
    <td style="width:80px;">
      <input name="rows[${idx}][quantity]"
             type="number"
             min="0"
             class="form-control form-control-sm text-end"
             value="1"
             required>
    </td>
    <td style="width:120px;">
      <input name="rows[${idx}][unit_cost]"
             type="number"
             step="0.01"
             min="0"
             class="form-control form-control-sm text-end"
             value="0">
    </td>
    <td>
      <input name="rows[${idx}][location]"
             class="form-control form-control-sm">
    </td>
    <td class="text-end" style="width:70px;">
      <button type="button"
              class="btn btn-outline-danger btn-sm"
              onclick="this.closest('tr').remove()"
              style="font-size:.75rem; line-height:1;">
        Delete
      </button>
    </td>
  `;
  tbody.appendChild(tr);
}
</script>

{% endblock %}

