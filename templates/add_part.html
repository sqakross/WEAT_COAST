{% extends "base.html" %}

{% block content %}
<div class="container-fluid py-4 d-flex justify-content-center">
  <div style="width:100%; max-width:1100px;">

    <!-- Header -->
    <div class="d-flex flex-wrap justify-content-between align-items-start mb-3"
         style="position:sticky; top:0; z-index:10; background:#f8f9fa; padding:.5rem 0;">
      <div>
        <h2 class="mb-0 fw-semibold" style="font-size:1.1rem;">Add / Scan Parts (Batch)</h2>
        <div class="text-muted" style="font-size:.8rem; line-height:1.2;">
          Scan barcode OR type manually → Add to list → Edit below → Commit
        </div>
      </div>
      <div class="mt-2 mt-sm-0">
        <a href="{{ url_for('inventory.dashboard') }}" class="btn btn-outline-secondary btn-sm">
          ← Back to Dashboard
        </a>
      </div>
    </div>

    <!-- Intake -->
    <div class="card shadow-sm border-0 mb-4">
      <div class="card-header bg-white py-2">
        <div class="fw-semibold" style="font-size:.9rem;">Part Intake / Scan</div>
        <div class="text-muted" style="font-size:.75rem;">
          Focus on Part #, scan, press Enter. Or fill manually and click Add to List.
        </div>
      </div>
      <div class="card-body">
        <div class="row g-3 align-items-end">

          <div class="col-md-3">
            <label class="form-label fw-semibold small text-uppercase mb-1">Part # / Barcode</label>
            <input type="text" class="form-control form-control-sm text-uppercase" id="inp_part_number"
                   placeholder="SCAN OR TYPE..." style="text-transform:uppercase; font-weight:500;" autofocus>
            <div class="form-text" style="font-size:.7rem;">Scanner: focus here, scan, Enter</div>
          </div>

          <div class="col-md-3">
            <label class="form-label fw-semibold small text-uppercase mb-1">Name</label>
            <input type="text" class="form-control form-control-sm" id="inp_name" placeholder="auto or type manually">
            <div class="form-text" id="name_hint" style="font-size:.7rem;">Autofills if part exists</div>
          </div>

          <div class="col-md-2">
            <label class="form-label fw-semibold small text-uppercase mb-1">Qty</label>
            <input type="number" class="form-control form-control-sm text-center" id="inp_qty" min="1" value="1">
          </div>

          <div class="col-md-2">
            <label class="form-label fw-semibold small text-uppercase mb-1">Cost $</label>
            <input type="number" step="0.01" class="form-control form-control-sm text-center" id="inp_cost" placeholder="0.00">
          </div>

          <div class="col-md-2">
            <label class="form-label fw-semibold small text-uppercase mb-1">Location</label>
            <input type="text" class="form-control form-control-sm text-uppercase text-center" id="inp_loc" placeholder="A2/B2">
          </div>

          <div class="col-12">
            <div class="row g-2">
              <div class="col-sm-6 col-lg-3">
                <div class="border rounded p-2 bg-light" style="font-size:.8rem;">
                  <div class="text-muted" style="font-size:.7rem;">Qty now</div>
                  <div class="fw-semibold" id="stock_qty">—</div>
                  <div class="text-muted mt-1" style="font-size:.7rem;">Loc now</div>
                  <div class="fw-semibold text-uppercase" id="stock_loc">—</div>
                </div>
              </div>
              <div class="col-sm-6 col-lg-3">
                <div class="border rounded p-2 bg-light" style="font-size:.8rem;">
                  <div class="text-muted" style="font-size:.7rem;">Cost now $</div>
                  <div class="fw-semibold" id="stock_cost">—</div>
                  <div class="text-muted mt-1" style="font-size:.7rem;">Name</div>
                  <div class="fw-semibold" id="stock_name">—</div>
                </div>
              </div>
              <div class="col-lg-6 d-flex flex-column justify-content-between" style="font-size:.75rem;">
                <div class="text-muted">
                  This info is pulled from system if the part already exists. You can still edit values below.
                </div>
                <div class="d-flex flex-wrap gap-2 mt-2">
                  <button class="btn btn-primary btn-sm" id="btn_add_item" type="button">➕ Add to List</button>
                  <button class="btn btn-outline-secondary btn-sm" id="btn_clear_fields" type="button">Clear Fields</button>
                </div>
              </div>
            </div>
          </div>

        </div>
      </div>
    </div>

    <!-- Batch -->
    <div class="card shadow-sm border-0">
      <div class="card-header bg-white py-2 d-flex justify-content-between align-items-start flex-wrap">
        <div>
          <div class="fw-semibold" style="font-size:.9rem;">Batch Items</div>
          <div class="text-muted" style="font-size:.75rem;">Edit before committing to inventory</div>
        </div>
        <button class="btn btn-outline-danger btn-sm mt-2 mt-sm-0" id="btn_clear_all" type="button">✕ Clear All</button>
      </div>

      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-bordered align-middle mb-3" style="min-width:800px; font-size:.8rem;">
            <thead class="table-light">
              <tr class="text-nowrap text-center align-middle">
                <th style="min-width:110px;">Part #</th>
                <th style="min-width:200px;">Name</th>
                <th style="width:70px;">Qty</th>
                <th style="width:90px;">Cost $</th>
                <th style="width:90px;">Location</th>
                <th style="width:90px;">Qty Now</th>
                <th style="width:60px;">Remove</th>
              </tr>
            </thead>
            <tbody id="batch_tbody"></tbody>
          </table>
        </div>

        <form method="POST" action="{{ url_for('inventory.add_part_batch') }}" id="commitForm">
          <input type="hidden" name="batch_payload" id="batch_payload">
          <div class="d-flex flex-wrap gap-2 pt-3 border-top">
            <button type="button" id="btn_commit" class="btn btn-success btn-lg" style="min-width:240px;">
              ✅ Commit Batch to Inventory
            </button>
            <a href="{{ url_for('inventory.dashboard') }}" class="btn btn-outline-secondary btn-lg">← Cancel / Back</a>
          </div>
        </form>
      </div>
    </div>

  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function () {
  // -------- DOM ----------
  const pnInput   = document.getElementById('inp_part_number');
  const nameInput = document.getElementById('inp_name');
  const qtyInput  = document.getElementById('inp_qty');
  const costInput = document.getElementById('inp_cost');
  const locInput  = document.getElementById('inp_loc');
  const nameHintEl= document.getElementById('name_hint');

  const stockQtyEl  = document.getElementById('stock_qty');
  const stockLocEl  = document.getElementById('stock_loc');
  const stockCostEl = document.getElementById('stock_cost');
  const stockNameEl = document.getElementById('stock_name');

  const addBtn      = document.getElementById('btn_add_item');
  const clearBtn    = document.getElementById('btn_clear_fields');
  const clearAllBtn = document.getElementById('btn_clear_all');

  const batchBody = document.getElementById('batch_tbody');
  const payloadEl = document.getElementById('batch_payload');
  const commitForm= document.getElementById('commitForm');
  const commitBtn = document.getElementById('btn_commit');

  // -------- DATA ----------
  // Строго единый формат строки
  // { part_number: 'STRING', name: 'STRING', qty: NUMBER, cost: NUMBER|STRING, loc: 'STRING', stock_now: 'STRING' }
  let batchItems = [];

  // Безопасные хелперы
  const s = v => (v === null || v === undefined) ? "" : String(v);
  const upper = v => s(v).trim().toUpperCase();

  function normPN(v){ return upper(v); }

  async function lookupExistingPart(pn){
    const info = {exists:false, name:"", cost:"", loc:"", stock_now:"0"};
    if(!pn) return info;
    try{
      const resp = await fetch(`/api/part/${encodeURIComponent(pn)}`);
      if(!resp.ok) return info;
      const d = await resp.json();
      info.exists    = true;
      info.name      = s(d.name);
      info.cost      = (d.unit_cost ?? "") === "" ? "" : s(d.unit_cost);
      info.loc       = s(d.location);
      info.stock_now = s(d.quantity ?? 0);
    }catch(_){}
    return info;
  }

  function updatePreview(i){
    stockQtyEl.textContent  = i.stock_now || "—";
    stockLocEl.textContent  = i.loc       || "—";
    stockCostEl.textContent = i.cost      || "—";
    stockNameEl.textContent = i.name      || "—";
  }

  function fillInputsFromInfo(i){
    if(i.exists){
      if(!nameInput.value) nameInput.value = i.name;
      if(!costInput.value) costInput.value = i.cost;
      if(!locInput.value)  locInput.value  = i.loc;
      nameHintEl.textContent = "Existing part (you can still edit)";
    }else{
      nameHintEl.textContent = "New part (please type name)";
    }
  }

  async function preloadFromPN(){
    const pn = normPN(pnInput.value);
    if(!pn) return;
    const info = await lookupExistingPart(pn);
    updatePreview(info);
    fillInputsFromInfo(info);
  }

  function clearEntryFields(){
    pnInput.value = ""; nameInput.value = ""; qtyInput.value = "1";
    costInput.value = ""; locInput.value = "";
    stockQtyEl.textContent = stockLocEl.textContent = stockCostEl.textContent = stockNameEl.textContent = "—";
    nameHintEl.textContent = "Autofills if part exists";
    pnInput.focus();
  }

  function renderTable(){
    batchBody.innerHTML = "";
    batchItems.forEach((it, idx) => {
      const tr = document.createElement("tr");
      tr.classList.add("align-middle","text-center");
      tr.innerHTML = `
        <td>
          <input type="text" class="form-control form-control-sm text-uppercase text-start"
                 style="min-width:100px; font-family:monospace;"
                 value="${s(it.part_number)}"
                 data-idx="${idx}" data-field="part_number">
        </td>
        <td style="text-align:left;">
          <input type="text" class="form-control form-control-sm" style="min-width:180px;"
                 value="${s(it.name)}"
                 data-idx="${idx}" data-field="name">
        </td>
        <td>
          <input type="number" class="form-control form-control-sm text-center" min="1" style="width:70px;"
                 value="${Number(it.qty)||1}"
                 data-idx="${idx}" data-field="qty">
        </td>
        <td>
          <input type="number" step="0.01" class="form-control form-control-sm text-center" style="width:90px;"
                 value="${s(it.cost)}"
                 data-idx="${idx}" data-field="cost">
        </td>
        <td>
          <input type="text" class="form-control form-control-sm text-uppercase text-center" style="width:90px;"
                 value="${s(it.loc)}"
                 data-idx="${idx}" data-field="loc">
        </td>
        <td>${s(it.stock_now)}</td>
        <td><button class="btn btn-outline-danger btn-sm" data-del="${idx}">✕</button></td>`;
      batchBody.appendChild(tr);
    });
  }

  // live-редактирование
  batchBody.addEventListener("input", (e)=>{
    const idx   = e.target.getAttribute("data-idx");
    const field = e.target.getAttribute("data-field");
    if(idx === null || field === null) return;

    if(field === "qty"){
      let v = parseInt(s(e.target.value), 10);
      if(isNaN(v) || v < 1) v = 1;
      batchItems[idx].qty = v;
      e.target.value = v;
      return;
    }
    if(field === "cost"){
      // храним как строку, парсим только на сабмите — меньше проблем с локалями
      batchItems[idx].cost = s(e.target.value);
      return;
    }
    if(field === "loc"){
      const v = upper(e.target.value);
      batchItems[idx].loc = v;
      e.target.value = v;
      return;
    }
    if(field === "part_number"){
      const v = upper(e.target.value);
      batchItems[idx].part_number = v;
      e.target.value = v;
      return;
    }
    if(field === "name"){
      batchItems[idx].name = s(e.target.value);
    }
  });

  // удалить строку
  batchBody.addEventListener("click", (e)=>{
    const delIdx = e.target.getAttribute("data-del");
    if(delIdx !== null){
      batchItems.splice(parseInt(delIdx,10), 1);
      renderTable();
    }
  });

  // очистить всё
  clearAllBtn.addEventListener("click", ()=>{
    if(!batchItems.length) return;
    if(!confirm("Clear entire batch?")) return;
    batchItems = [];
    renderTable();
    pnInput.focus();
  });

  // добавить текущий ввод в батч
  async function addCurrentRowToBatch(){
    const pn  = normPN(pnInput.value);
    let   nm  = s(nameInput.value).trim();
    let   qty = parseInt(s(qtyInput.value),10);
    let   cost= s(costInput.value).trim();
    let   loc = upper(locInput.value);

    if(!pn){ pnInput.focus(); return; }
    if(!qty || qty < 1) qty = 1;

    // автоподтяжка
    const info = await lookupExistingPart(pn);
    updatePreview(info);
    if(info.exists && !nm)   nm   = info.name;
    if(info.exists && !cost) cost = info.cost;
    if(info.exists && !loc)  loc  = upper(info.loc);

    nameHintEl.textContent = info.exists
      ? "Existing part (you can still edit)"
      : "New part (please type name)";

    const existing = batchItems.find(x => x.part_number === pn);
    if(existing){
      existing.qty = (parseInt(existing.qty,10) || 0) + qty;
      if(nm)   existing.name = nm;
      if(cost) existing.cost = cost;
      if(loc)  existing.loc  = loc;
    }else{
      batchItems.push({
        part_number: pn,
        name: nm,
        qty: qty,
        cost: cost,           // строка — распарсим позже
        loc: loc,
        stock_now: s(info.stock_now)
      });
    }
    renderTable();
    clearEntryFields();
  }

  addBtn.addEventListener("click", async ()=>{ await addCurrentRowToBatch(); });
  pnInput.addEventListener("keydown", async (e)=>{ if(e.key === "Enter"){ e.preventDefault(); await addCurrentRowToBatch(); }});
  pnInput.addEventListener("blur", async ()=>{ await preloadFromPN(); });
  clearBtn.addEventListener("click", ()=>{ clearEntryFields(); });

  // -------- Сериализация + сабмит ----------
  function validateAndNormalize(){
    if(!batchItems.length){
      alert("No items in batch");
      pnInput.focus();
      return null;
    }

    const normalized = [];
    for(let i=0;i<batchItems.length;i++){
      const r  = batchItems[i];

      const pn = upper(r.part_number);
      const nm = s(r.name).trim();
      const lc = upper(r.loc);

      // cost может быть числом или строкой — приводим безопасно:
      const rawCost = r.cost;
      const costNum = parseFloat(s(rawCost).replace(",", "."));
      const qtyNum  = Math.max(1, parseInt(s(r.qty),10) || 1);

      // строгая проверка
      const errs = [];
      if(!pn) errs.push("Part #");
      if(!nm) errs.push("Name");
      if(!(costNum > 0)) errs.push("Cost $ > 0");
      if(!lc) errs.push("Location");

      if(errs.length){
        alert(
          "Each row must have:\n- " + errs.join("\n- ")
          + `\n\nRow #${i+1} is invalid.`
        );
        return null;
      }

      normalized.push({
        part_number: pn,
        name: nm,
        qty: qtyNum,
        cost: costNum,   // уже число
        loc: lc
      });
    }

    return normalized;
  }

  function submitBatch(){
    const normalized = validateAndNormalize();
    if(!normalized) return;

    payloadEl.value = JSON.stringify(normalized);
    // защита от двойного клика
    commitBtn.disabled = true;
    commitBtn.classList.add('disabled');

    // нативный сабмит
    commitForm.submit();
  }

  commitBtn.addEventListener('click', submitBatch);
  // лог для понимания, что сабмит стартовал
  commitForm.addEventListener('submit', ()=>console.log("[ADD-BATCH] native submit started"));

  // глобальный ловец ошибок (на всякий)
  window.addEventListener('error', (e)=>{
    console.error("[ADD-BATCH] JS error", e.error || e.message);
    alert("Unexpected error: " + (e.message || e.error));
    try{
      commitBtn.disabled = false;
      commitBtn.classList.remove('disabled');
    }catch(_){}
  });
});
</script>
{% endblock %}
