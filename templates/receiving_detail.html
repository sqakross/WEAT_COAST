{% extends "base.html" %}
{% block content %}

<div class="d-flex align-items-center justify-content-between mb-3">
  <div>
    <h3 class="mb-1">Receiving Batch #{{ batch.id }}</h3>

    <div class="text-muted small d-flex flex-wrap align-items-center" style="gap:.5rem;">
      <span class="me-3">
        <strong>Supplier:</strong>
        {{ batch|attr('supplier_name')|default('—', true) }}
      </span>

      <span class="me-3">
        <strong>Invoice #:</strong>
        {{ batch|attr('invoice_number')|default('—', true) }}
      </span>

      <span class="me-3">
        <strong>Date:</strong>
        {{ batch|attr('invoice_date')|default('—', true) }}
      </span>

      {# статус партии (posted / draft) #}
      {% set is_posted = (batch|attr('status')|default('', true)) == 'posted' %}
      <span class="me-3">
        <strong>Status:</strong>
        {% if is_posted %}
          <span class="badge bg-success">POSTED</span>
        {% else %}
          <span class="badge bg-secondary">DRAFT</span>
        {% endif %}
      </span>

      {# наш новый индикатор состояния склада #}
      {% if stock_applied %}
        <span class="badge bg-success" style="font-size:.7rem;">
          Stock Applied
        </span>
      {% else %}
        <span class="badge bg-secondary" style="font-size:.7rem;">
          No Stock Applied
        </span>
      {% endif %}
    </div>
  </div>

  {# ----- ACTION BUTTONS (admin or superadmin) ----- #}
  {% set role = (current_user.role if current_user.is_authenticated else '')|lower %}
  {% set can_super = current_user.is_authenticated and (
    role in ['admin','superadmin']
    or (current_user.is_admin|default(false))
    or (current_user.is_superadmin|default(false))
    or (current_user.is_super_admin|default(false))
  ) %}

  <div class="text-end">
    <a class="btn btn-outline-secondary me-2" href="{{ url_for('inventory.receiving_list') }}">
      ‹ Back
    </a>

    {# Post / Unpost кнопка через toggle:
       - показываем только суперюзеру (can_super)
       - и только если can_unpost из контроллера говорит, что это безопасно
       - если партия уже частично выдана, мы дизейблим анпост
    #}

    {% if can_super and can_unpost %}
      <form action="{{ url_for('inventory.receiving_toggle', batch_id=batch.id) }}"
            method="post" class="d-inline">
        <button class="btn {{ 'btn-warning' if is_posted else 'btn-primary' }}" type="submit">
          {{ 'Unpost' if is_posted else 'Post' }}
        </button>
      </form>

    {% elif can_super and (not can_unpost) and is_posted %}
      {# батч posted, но уже потреблён техниками -> обычный unpost запрещён #}
      <button class="btn btn-warning" type="button" disabled
              title="Batch already issued to technicians. Cannot unpost.">
        Unpost
      </button>

    {% elif can_super and (not is_posted) %}
      {# DRAFT состояние: пост разрешён #}
      <form action="{{ url_for('inventory.receiving_toggle', batch_id=batch.id) }}"
            method="post" class="d-inline">
        <button class="btn btn-primary" type="submit">
          Post
        </button>
      </form>
    {% endif %}

    {# Delete:
       Правило безопасности:
       - только суперюзер (can_super)
       - НО если stock_applied == True (то есть склад ещё держит этот приход),
         то блокируем Delete (нельзя удалять батч, который всё ещё в стоке).
       Это защищает от случайного удаления без отката остатков.
    #}
    {% if can_super %}
      <form action="{{ url_for('inventory.receiving_delete', batch_id=batch.id) }}"
            method="post" class="d-inline"
            onsubmit="return confirm('Delete batch #{{ batch.id }}? This cannot be undone.');">
        <button class="btn btn-danger"
                type="submit"
                {% if stock_applied %}disabled
                   title="Unpost first to remove from stock before deleting."
                {% endif %}>
          Delete
        </button>
      </form>
    {% endif %}
  </div>
</div>

{# предупреждение, если партия уже потреблена (consumed == True) #}
{% if consumed %}
  <div class="alert alert-warning small" style="line-height:1.3;">
    This batch has already been partially issued to technicians.
    Quantities and Unpost are locked.
    To adjust counts, create a correction batch (add only the missing difference).
  </div>
{% endif %}

{# ---------- SUMMARY CARD ---------- #}
<div class="card mb-4 shadow-sm">
  <div class="card-header d-flex justify-content-between align-items-center py-2">
    <strong class="small text-uppercase text-muted">Received Items</strong>
    <span class="small text-muted">
      Currency:
      {{ batch|attr('currency')|default('USD', true) }}
    </span>
  </div>

  <div class="table-responsive">
    <table class="table table-sm align-middle mb-0">
      <thead class="table-light">
        <tr>
          <th style="width:50px;">#</th>
          <th style="width:160px;">Part #</th>
          <th>Description</th>
          <th style="width:100px;" class="text-end">Qty</th>
          <th style="width:120px;" class="text-end">Unit Cost</th>
          <th style="width:140px;" class="text-end">Line Total</th>
          <th style="width:120px;">Location</th>
        </tr>
      </thead>
      <tbody>
        {% set curr = batch|attr('currency')|default('USD', true) %}

        {# subtotal по base cost — как в Preview & Edit Import #}
        {% set subtotal_base = 0.0 %}
        {# на всякий случай считаем и “старый” grand по unit_cost — для fallback #}
        {% set grand_by_unit = 0.0 %}

        {% for it in lines %}
          {% set pn   = (it|attr('part') and (it.part|attr('number')|default('', true))) or (it|attr('part_number')|default('', true)) %}
          {% set name = (it|attr('part') and (it.part|attr('name')|default('', true)))   or (it|attr('part_name')|default('', true)) %}
          {% set qty  = (it|attr('qty')|default(it|attr('quantity'), true)|default(0, true)) | int %}

          {# базовая цена (без fee), как она была в превью.
             Если unit_cost_base нет (старые данные) — используем unit_cost / unit_cost_at_issue. #}
          {% set base_cost =
              (it|attr('unit_cost_base')|default(
                it|attr('unit_cost')|default(it|attr('unit_cost_at_issue'), true),
              true)) | float
          %}

          {# текущий unit_cost (скорректированный) — то, что реально лежит в партии #}
          {% set ucost =
              (it|attr('unit_cost')|default(it|attr('unit_cost_at_issue'), true)|default(0.0, true)) | float
          %}

          {% set line_base_total = (qty * base_cost) %}
          {% set line_total      = (qty * ucost) %}

          {% set subtotal_base = subtotal_base + line_base_total %}
          {% set grand_by_unit = grand_by_unit + line_total %}

          <tr>
            <td class="text-muted small">{{ loop.index }}</td>
            <td class="fw-semibold">{{ pn }}</td>
            <td class="text-truncate" style="max-width: 300px;">{{ name }}</td>
            <td class="text-end">{{ qty }}</td>
            <td class="text-end">{{ curr }} {{ '%.2f' % ucost }}</td>
            <td class="text-end">{{ curr }} {{ '%.2f' % line_total }}</td>
            <td>{{ it|attr('location')|default((it|attr('part') and it.part|attr('location')|default('', true)) or '', true) }}</td>
          </tr>
        {% endfor %}
      </tbody>
      <tfoot class="table-light">
        {# extra_expenses пришли из Preview & Edit Import;
           если они есть — считаем total ровно как в превью (subtotal_base + extra). #}
        {% set extra_raw = batch|attr('extra_expenses')|default(None, true) %}
        {% if extra_raw is not none %}
          {% set extra_val = extra_raw|float %}
          {% set total_to_show = subtotal_base + extra_val %}
        {% else %}
          {# fallback для старых партий без extra_expenses:
             оставляем старое поведение (batch_total / сумма по unit_cost) #}
          {% set total_to_show = (batch_total if batch_total is not none else grand_by_unit) %}
        {% endif %}
        <tr>
          <th colspan="5" class="text-end">Total:</th>
          <th class="text-end">
            {{ curr }} {{ '%.2f' % total_to_show }}
          </th>
          <th></th>
        </tr>
      </tfoot>
    </table>
  </div>

  {% if batch|attr('notes') %}
    <div class="card-footer small text-muted">
      <strong>Notes:</strong>
      {{ batch|attr('notes')|default('', true) }}
    </div>
  {% endif %}
</div>

{# ---------- EDIT CARD (Admin / Superadmin) ---------- #}

{# Вместо чистого is_posted мы используем can_edit:
   - can_edit приходит из контроллера
   - True: супер/админ и партия не consumed
   - False: либо не супер, либо партия уже потреблена
#}

{% if can_super %}
<div class="card shadow-sm">
  <div class="card-header d-flex justify-content-between align-items-center py-2">
    <div class="d-flex flex-column">
      <strong class="small text-uppercase text-muted">Edit Batch</strong>

      {% if not can_edit %}
        <span class="text-muted small">
          Quantities locked (batch posted and partially issued).
        </span>
      {% elif is_posted %}
        <span class="text-muted small">
          Batch is posted — Unpost to enable editing.
        </span>
      {% else %}
        <span class="text-muted small">
          Draft mode — you can edit and repost.
        </span>
      {% endif %}
    </div>
    <span class="badge bg-light text-dark border">
      ID: {{ batch.id }}
    </span>
  </div>

  <div class="card-body">
    <form method="post" action="{{ url_for('inventory.receiving_save') }}">
      <input type="hidden" name="batch_id" value="{{ batch.id }}">

      <div class="row g-3 mb-3">
        <div class="col-md-3">
          <label class="form-label small text-muted">Supplier</label>
          <input name="supplier_name" class="form-control form-control-sm"
                 value="{{ batch|attr('supplier_name')|default('', true) }}"
                 {% if not can_edit %}readonly disabled style="background:#eee; color:#666;"{% endif %}>
        </div>
        <div class="col-md-3">
          <label class="form-label small text-muted">Invoice #</label>
          <input name="invoice_number" class="form-control form-control-sm"
                 value="{{ batch|attr('invoice_number')|default('', true) }}"
                 {% if not can_edit %}readonly disabled style="background:#eee; color:#666;"{% endif %}>
        </div>
        <div class="col-md-3">
          <label class="form-label small text-muted">Invoice Date</label>
          <input type="date" name="invoice_date" class="form-control form-control-sm"
                 value="{{ batch.invoice_date and batch.invoice_date.strftime('%Y-%m-%d') or '' }}"
                 {% if not can_edit %}readonly disabled style="background:#eee; color:#666;"{% endif %}>
        </div>
        <div class="col-md-3">
          <label class="form-label small text-muted">Currency</label>
          <input name="currency" class="form-control form-control-sm"
                 value="{{ batch|attr('currency')|default('USD', true) }}"
                 {% if not can_edit %}readonly disabled style="background:#eee; color:#666;"{% endif %}>
        </div>
      </div>

      <div class="mb-3">
        <label class="form-label small text-muted">Notes</label>
        <textarea name="notes" class="form-control form-control-sm" rows="2"
                  {% if not can_edit %}readonly disabled style="background:#eee; color:#666;"{% endif %}>{{ batch|attr('notes')|default('', true) }}</textarea>
      </div>

      <div class="table-responsive border rounded mb-3">
        <table class="table table-sm align-middle mb-0">
          <thead class="table-light">
            <tr class="text-muted small">
              <th style="width:160px;">Part #</th>
              <th>Part Name</th>
              <th style="width:100px;">Qty</th>
              <th style="width:120px;">Unit Cost</th>
              <th style="width:140px;">Location</th>
            </tr>
          </thead>
          <tbody id="rowsTbody">
            {% for it in lines %}
            <tr>
              <td>
                <input name="rows[{{ loop.index0 }}][part_number]"
                       class="form-control form-control-sm"
                       value="{{ (it|attr('part_number')|default('', true)) }}"
                       {% if not can_edit %}readonly disabled style="background:#eee; color:#666;"{% endif %}>
              </td>
              <td>
                <input name="rows[{{ loop.index0 }}][part_name]"
                       class="form-control form-control-sm"
                       value="{{ (it|attr('part_name')|default('', true)) }}"
                       {% if not can_edit %}readonly disabled style="background:#eee; color:#666;"{% endif %}>
              </td>
              <td style="max-width:90px;">
                <input name="rows[{{ loop.index0 }}][quantity]"
                       class="form-control form-control-sm text-end"
                       value="{{ (it|attr('quantity')|default(0, true)) }}"
                       {% if not can_edit %}readonly disabled style="background:#eee; color:#666;"{% endif %}>
              </td>
              <td style="max-width:120px;">
                <input name="rows[{{ loop.index0 }}][unit_cost]"
                       class="form-control form-control-sm text-end"
                       value="{{ (it|attr('unit_cost')|default(0.0, true)) }}"
                       {% if not can_edit %}readonly disabled style="background:#eee; color:#666;"{% endif %}>
              </td>
              <td style="max-width:140px;">
                <input name="rows[{{ loop.index0 }}][location]"
                       class="form-control form-control-sm"
                       value="{{ (it|attr('location')|default('', true)) }}"
                       {% if not can_edit %}readonly disabled style="background:#eee; color:#666;"{% endif %}>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <div class="d-flex flex-wrap gap-2">
        <button class="btn btn-outline-primary btn-sm"
                type="submit" name="action" value="save"
                {% if not can_edit %}disabled{% endif %}>
          Save Draft
        </button>

        {% if not is_posted %}
          <button class="btn btn-success btn-sm"
                  type="submit" name="action" value="post">
            Post &amp; Update Stock
          </button>
        {% endif %}
      </div>
    </form>
  </div>
</div>
{% endif %}

{% endblock %}
