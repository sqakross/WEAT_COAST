{% extends "base.html" %}
{% block content %}
<h3>Receiving Batch #{{ batch.id }}</h3>

{% set lines = (batch|attr('lines')|default(batch|attr('items'), true)|default([], true)) %}
{% set curr = batch|attr('currency')|default('USD', true) %}
{% set role = current_user.role if current_user.is_authenticated else '' %}
{% set can_super = current_user.is_authenticated and (
  role == 'superadmin' or (current_user.is_superadmin|default(false)) or (current_user.is_super_admin|default(false))
) %}

<div class="row mb-3">
  <div class="col">
    <div><strong>Supplier:</strong> {{ batch|attr('supplier_name')|default('', true) }}</div>
    <div><strong>Invoice #:</strong> {{ batch|attr('invoice_number')|default('—', true) }}</div>
    <div><strong>Date:</strong> {{ batch|attr('invoice_date')|default('—', true) }}</div>
    <div>
      <strong>Status:</strong>
      {% if (batch|attr('status')|default('', true)) == 'posted' %}
        <span class="badge bg-success">posted</span>
      {% else %}
        <span class="badge bg-secondary">draft</span>
      {% endif %}
    </div>
  </div>
  <div class="col text-end">
    <a class="btn btn-outline-secondary" href="{{ url_for('inventory.receiving_list') }}">Back</a>

    {% if can_super %}
      <form action="{{ url_for('inventory.receiving_toggle', batch_id=batch.id) }}" method="post" style="display:inline;">
        <button class="btn {{ 'btn-warning' if (batch|attr('status')|default('', true)) == 'posted' else 'btn-primary' }}" type="submit">
          {{ 'Unpost' if (batch|attr('status')|default('', true)) == 'posted' else 'Post' }}
        </button>
      </form>

      <form action="{{ url_for('inventory.receiving_delete', batch_id=batch.id) }}" method="post" style="display:inline;"
            onsubmit="return confirm('Delete batch #{{ batch.id }}? This cannot be undone.');">
        <button class="btn btn-danger" type="submit">Delete</button>
      </form>
    {% endif %}
  </div>
</div>

<table class="table table-sm table-hover align-middle">
  <thead>
    <tr>
      <th style="width:60px;">#</th>
      <th style="width:160px;">Part #</th>
      <th>Description</th>
      <th style="width:120px;" class="text-end">Qty</th>
      <th style="width:140px;" class="text-end">Unit Cost</th>
      <th style="width:140px;" class="text-end">Line Total</th>
      <th style="width:120px;">Location</th>
    </tr>
  </thead>
  <tbody>
    {% set grand = 0.0 %}
    {% for it in lines %}
      {% set pn   = (it|attr('part') and (it.part|attr('number')|default('', true))) or (it|attr('part_number')|default('', true)) %}
      {% set name = (it|attr('part') and (it.part|attr('name')|default('', true)))   or (it|attr('part_name')|default('', true)) %}
      {% set qty  = (it|attr('qty')|default(it|attr('quantity'), true)|default(0, true)) | int %}
      {% set ucost = (it|attr('unit_cost')|default(it|attr('unit_cost_at_issue'), true)|default(0.0, true)) | float %}
      {% set line_total = (qty * ucost) %}
      {% set grand = grand + line_total %}
      <tr>
        <td>{{ loop.index }}</td>
        <td>{{ pn }}</td>
        <td>{{ name }}</td>
        <td class="text-end">{{ qty }}</td>
        <td class="text-end">{{ curr }} {{ '%.2f' % ucost }}</td>
        <td class="text-end">{{ curr }} {{ '%.2f' % line_total }}</td>
        <td>{{ it|attr('location')|default((it|attr('part') and it.part|attr('location')|default('', true)) or '', true) }}</td>
      </tr>
    {% endfor %}
  </tbody>
  <tfoot>
    <tr>
      <th colspan="5" class="text-end">Total:</th>
      <th class="text-end">{{ curr }} {{ '%.2f' % grand }}</th>
      <th></th>
    </tr>
  </tfoot>
</table>
{% endblock %}
