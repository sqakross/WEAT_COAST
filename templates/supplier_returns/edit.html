{% extends "base.html" %}
{% block content %}
<div class="container" style="max-width: 1100px;">
  <div class="d-flex align-items-center justify-content-between mt-4 mb-2">
    <a href="{{ url_for('supplier_returns.list_returns') }}" class="btn btn-light">&larr; Back</a>
  </div>

  <div class="card shadow-sm">
    <div class="card-header d-flex justify-content-between align-items-center">
      <div>
        <h5 class="mb-0">Supplier Return #{{ b.id }}</h5>
        <small class="text-muted">
          Status:
          {% if b.status == 'posted' %}
            <span class="badge bg-success">posted</span>
          {% else %}
            <span class="badge bg-secondary">draft</span>
          {% endif %}
        </small>
      </div>

      <!-- Header actions submit the main form as well -->
      <div class="d-flex gap-2 align-items-center">
        <!-- Print -->
        <button type="button"
                class="btn btn-outline-secondary btn-sm"
                onclick="window.print();">
          Print
        </button>

        {% if b.status == 'draft' %}
          <button id="btn-post-top" type="submit" form="editForm" name="action" value="post"
                  class="btn btn-success btn-sm"
                  data-disable-on-submit="true" data-action-label="Posting…"
                  title="Decrement stock">Post</button>
          <form method="post" action="{{ url_for('supplier_returns.delete_return', batch_id=b.id) }}"
                onsubmit="return confirm('Delete draft?');">
            <button class="btn btn-outline-danger btn-sm">Delete</button>
          </form>
        {% else %}
          <button id="btn-unpost-top" type="submit" form="editForm" name="action" value="unpost"
                  class="btn btn-warning btn-sm"
                  data-disable-on-submit="true" data-action-label="Unposting…"
                  onclick="return confirm('Unpost? This will restore stock.');">
            Unpost
          </button>
        {% endif %}
      </div>
    </div>

    <form id="editForm" method="post" action="{{ url_for('supplier_returns.edit_return', batch_id=b.id) }}">
      <!-- гарантируем, что action всегда уходит -->
      <input type="hidden" name="action" id="action-hidden" value="save"/>

      <div class="card-body">
        <div class="row g-3 mb-2">
          <div class="col-md-6">
            <label class="form-label">Supplier</label>
            <input class="form-control" name="supplier_name" value="{{ b.supplier_name or '' }}" required>
          </div>
        </div>

        <div class="d-flex justify-content-between align-items-center mb-2">
          <h6 class="mb-0">Items</h6>
          <button type="button" class="btn btn-sm btn-outline-primary" id="btn-add-row">+ Add Row</button>
        </div>

        <div class="table-responsive">
          <table class="table table-sm align-middle" id="items-table">
            <thead class="table-light">
              <tr>
                <th>Part #</th>
                <th>Part name</th>
                <th>Qty</th>
                <th>Unit Cost</th>
                <th>Location</th>
                <th>Tech / Job</th>
                <th class="text-end">Total</th>
                <th></th>
              </tr>
            </thead>
            <tbody>
              {% for it in b.items %}
              {% set bad = (loop.index0 in (errors_idx|default([]))) %}
              <tr class="{% if bad %}table-danger{% endif %}">
                <td>
                  <input class="form-control form-control-sm"
                         name="part_number[]"
                         value="{{ it.part_number }}"
                         placeholder="Scan or type Part #">
                </td>
                <td>
                  <input class="form-control form-control-sm"
                         name="part_name[]"
                         value="{{ it.part_name or '' }}">
                </td>
                <td>
                  <input class="form-control form-control-sm qty"
                         name="qty_returned[]"
                         type="number" min="1" step="1"
                         value="{{ it.qty_returned or 1 }}">
                </td>
                <td>
                  <input class="form-control form-control-sm cost"
                         name="unit_cost[]"
                         type="number" min="0" step="0.01"
                         value="{{ ('%.2f'|format(it.unit_cost or 0)) }}">
                </td>
                <td>
                  <input class="form-control form-control-sm"
                         name="location[]"
                         value="{{ it.location or '' }}"
                         placeholder="auto">
                </td>
                <td>
                  <input class="form-control form-control-sm"
                         name="tech_note[]"
                         value="{{ it.tech_note or '' }}"
                         placeholder="Tech / Job #">
                </td>
                <td class="text-end line-total">
                  ${{ '%.2f'|format(it.total_cost or 0) }}
                </td>
                <td>
                  <button type="button" class="btn btn-sm btn-outline-danger btn-del-row">Delete</button>
                </td>
              </tr>
              {% endfor %}

              {% if not b.items %}
              <tr>
                <td>
                  <input class="form-control form-control-sm"
                         name="part_number[]"
                         placeholder="Scan or type Part #">
                </td>
                <td>
                  <input class="form-control form-control-sm"
                         name="part_name[]"
                         placeholder="">
                </td>
                <td>
                  <input class="form-control form-control-sm qty"
                         name="qty_returned[]"
                         type="number" min="1" step="1"
                         value="1">
                </td>
                <td>
                  <input class="form-control form-control-sm cost"
                         name="unit_cost[]"
                         type="number" min="0" step="0.01"
                         value="0.00">
                </td>
                <td>
                  <input class="form-control form-control-sm"
                         name="location[]"
                         placeholder="auto">
                </td>
                <td>
                  <input class="form-control form-control-sm"
                         name="tech_note[]"
                         placeholder="Tech / Job #">
                </td>
                <td class="text-end line-total">$0.00</td>
                <td>
                  <button type="button" class="btn btn-sm btn-outline-danger btn-del-row">Delete</button>
                </td>
              </tr>
              {% endif %}
            </tbody>
          </table>
        </div>

        <div class="row mt-3">
          <div class="col-md-6">
            <small class="text-muted d-block">Subtotal is Qty × Unit Cost. Display only; server recalculates on save.</small>
            <small class="text-danger d-block">Red rows indicate missing or invalid Part Numbers.</small>
          </div>
          <div class="col-md-6">
            <div class="d-flex justify-content-end">
              <div style="min-width:260px;">
                <div class="d-flex justify-content-between"><div>Subtotal (items):</div><div class="fw-semibold" id="subtotal">$0.00</div></div>
                <div class="d-flex justify-content-between"><div>Grand Total:</div><div class="fw-bold" id="grandtotal">$0.00</div></div>
              </div>
            </div>
          </div>
        </div>

      </div>

      <div class="card-footer d-flex gap-2">
        <button id="btn-save-bottom" type="submit" name="action" value="save"
                class="btn btn-primary"
                data-disable-on-submit="true" data-action-label="Saving…">Save</button>
        {% if b.status == 'draft' %}
          <button id="btn-post-bottom" type="submit" name="action" value="post"
                  class="btn btn-success"
                  data-disable-on-submit="true" data-action-label="Posting…">
            Post (decrement stock)
          </button>
        {% else %}
          <button id="btn-unpost-bottom" type="submit" name="action" value="unpost"
                  class="btn btn-warning"
                  data-disable-on-submit="true" data-action-label="Unposting…"
                  onclick="return confirm('Unpost? This will restore stock.')">
            Unpost (restore stock)
          </button>
        {% endif %}
        <a href="{{ url_for('supplier_returns.list_returns') }}" class="btn btn-light">Cancel</a>

        <!-- Print внизу -->
        <button type="button"
                class="btn btn-outline-secondary ms-auto"
                onclick="window.print();">
          Print
        </button>
      </div>
    </form>
  </div>
</div>

<style>
  .flash-ok { animation: flashOk 900ms ease-out 1; }
  @keyframes flashOk { 0%{box-shadow:0 0 0 0 rgba(40,167,69,.7);} 100%{box-shadow:0 0 0 12px rgba(40,167,69,0);} }
  .cell-error input { border-color: #dc3545 !important; }
  .cell-error [title] { cursor: help; }

  /* ======== ПЕЧАТЬ: LANDSCAPE, КРУПНЫЙ ТЕКСТ, ТАБЛИЦА НА ВСЮ ШИРИНУ ======== */
  @media print {
    @page {
      size: A4 landscape;
      margin: 10mm;
    }

    body {
      margin: 0;
      background: #ffffff !important;
      font-size: 14px !important;
      -webkit-print-color-adjust: exact;
    }

    nav.navbar,
    .navbar,
    .top-navbar,
    .alert {
      display: none !important;
    }

    .card-footer,
    .btn,
    a.btn {
      display: none !important;
    }

    .container {
      max-width: 100% !important;
      width: 100% !important;
      padding: 0 !important;
      margin: 0 !important;
    }

    .card {
      width: 100% !important;
      box-shadow: none !important;
      border: 1px solid #000 !important;
      margin: 0 !important;
    }

    #items-table {
      width: 100% !important;
      table-layout: auto !important;
    }

    #items-table th,
    #items-table td {
      font-size: 13px !important;
      padding: 4px 6px !important;
      white-space: nowrap;
    }

    /* убираем любые inline-width */
    #items-table th[style],
    #items-table td[style] {
      width: auto !important;
      max-width: none !important;
    }

    /* Part name можно переносить */
    #items-table th:nth-child(2),
    #items-table td:nth-child(2) {
      white-space: normal !important;
    }

    /* инпуты как текст */
    #items-table input {
      border: none !important;
      background: transparent !important;
      padding: 0 !important;
      margin: 0 !important;
      box-shadow: none !important;
      width: 100% !important;
      font-size: 13px !important;
    }

      /* не рвём строки части между страницами */
    #items-table tr {
        page-break-inside: avoid;
        break-inside: avoid;
    }

    /* саму карточку разрешаем делить по страницам */
    .card {
        page-break-inside: auto;
        break-inside: auto;
    }

  }
</style>

<script>
(function(){
  const API_LOOKUP = "{{ url_for('supplier_returns.api_part_lookup') }}";

  // ---------- helpers ----------
  const fmt = n => '$' + (Math.round((+n||0)*100)/100).toFixed(2);

  function recalcRow(tr){
    const qty  = parseFloat(tr.querySelector('.qty')?.value || '0');
    const cost = parseFloat(tr.querySelector('.cost')?.value || '0');
    const total = (qty>0 && cost>=0) ? (qty*cost) : 0;
    const cell = tr.querySelector('.line-total');
    if(cell) cell.textContent = fmt(total);
    return total;
  }
  function recalcAll(){
    let sum = 0;
    document.querySelectorAll('#items-table tbody tr').forEach(tr => sum += recalcRow(tr));
    document.getElementById('subtotal').textContent   = fmt(sum);
    document.getElementById('grandtotal').textContent = fmt(sum);
  }

  function normalizeLocation(s){
    if(!s) return '';
    let v = (s || '').trim();
    if (v.toLowerCase() === 'auto') return '';
    v = v.replace(/\s*\/\s*/g, '/');
    v = v.replace(/\s+/g, ' ');
    return v;
  }

  let submitLock = false;
  function setLoading(btn, on){
    if(!btn) return;
    if(on){
      btn.dataset._oldText = btn.textContent;
      btn.disabled = true;
      if(btn.dataset.actionLabel) btn.textContent = btn.dataset.actionLabel;
    } else {
      btn.disabled = false;
      if(btn.dataset._oldText) btn.textContent = btn.dataset._oldText;
      delete btn.dataset._oldText;
    }
  }
  function disableAllSubmitButtons(){
    document.querySelectorAll('[data-disable-on-submit="true"]').forEach(
      b => setLoading(b, true)
    );
  }
  function enableAllSubmitButtons(){
    document.querySelectorAll('[data-disable-on-submit="true"]').forEach(
      b => setLoading(b, false)
    );
  }

  function markCellError(input, msg){
    const td = input?.closest('td');
    if(!td) return;
    td.classList.add('cell-error');
    if(msg) input.setAttribute('title', msg);
  }
  function clearRowClientErrors(tr){
    tr.querySelectorAll('.cell-error').forEach(td=>td.classList.remove('cell-error'));
    tr.querySelectorAll('[title]').forEach(el=>{
      if (el.classList.contains('qty') || el.classList.contains('cost') || el.name === 'part_number[]') {
        el.removeAttribute('title');
      }
    });
  }

  function validateBeforePost(){
    let ok = true;
    let firstBadInput = null;

    document.querySelectorAll('#items-table tbody tr').forEach(tr=>{
      clearRowClientErrors(tr);
      const pn   = tr.querySelector('input[name="part_number[]"]');
      const qty  = tr.querySelector('.qty');
      const cost = tr.querySelector('.cost');

      if (!pn || !pn.value.trim()) return;

      if (qty && !(parseInt(qty.value,10) > 0)) {
        ok = false; markCellError(qty, 'Quantity must be > 0'); if(!firstBadInput) firstBadInput = qty;
      }
      if (cost && !(parseFloat(cost.value) >= 0)) {
        ok = false; markCellError(cost, 'Unit cost cannot be negative'); if(!firstBadInput) firstBadInput = cost;
      }
    });

    if(!ok && firstBadInput){
      firstBadInput.focus({preventScroll:false});
      firstBadInput.scrollIntoView({behavior:'smooth', block:'center'});
    }
    return ok;
  }

  async function lookupAndFill(inputEl){
    const tr = inputEl.closest('tr');
    const pn = (inputEl.value || '').trim();
    if(!tr) return;

    if(!pn){ tr.classList.add('table-danger'); return; }

    try{
      const res = await fetch(API_LOOKUP + "?pn=" + encodeURIComponent(pn), {headers:{Accept:"application/json"}});
      if(!res.ok){ tr.classList.add('table-danger'); return; }
      const data = await res.json();
      if(!data.ok){ tr.classList.add('table-danger'); return; }

      tr.classList.remove('table-danger');

      const n = tr.querySelector('input[name="part_name[]"]');
      const c = tr.querySelector('input[name="unit_cost[]"]');
      const l = tr.querySelector('input[name="location[]"]');

      if(n && (!n.value || !n.value.trim())) {
        n.value = data.data.name || '';
        n.classList.add('flash-ok');
        setTimeout(()=>n.classList.remove('flash-ok'), 900);
      }
      if(c){
        const cur = parseFloat(c.value || '0');
        if(!(cur>0)) {
          c.value = (data.data.unit_cost || 0).toFixed(2);
          c.classList.add('flash-ok');
          setTimeout(()=>c.classList.remove('flash-ok'), 900);
        }
      }
      if(l){
        let cur = (l.value || '').trim().toLowerCase();
        if(!cur || cur === 'auto') {
          l.value = data.data.location || '';
          l.classList.add('flash-ok');
          setTimeout(()=>l.classList.remove('flash-ok'), 900);
        }
      }
      recalcRow(tr); recalcAll();
    }catch(e){
      tr.classList.add('table-danger');
    }
  }

  let debounceTimer=null;
  const table = document.getElementById('items-table');

  table.addEventListener('input', e=>{
    const t = e.target;
    if(t.name==='part_number[]'){
      clearTimeout(debounceTimer);
      debounceTimer = setTimeout(()=>lookupAndFill(t), 250);
    }
    if(t.classList.contains('qty')||t.classList.contains('cost')) recalcAll();
  });

  table.addEventListener('keydown', e=>{
    const t = e.target;
    if(t.name==='part_number[]' && e.key==='Enter'){
      e.preventDefault();
      lookupAndFill(t);
    } else if ((t.classList.contains('qty') || t.classList.contains('cost')) && e.key==='Enter'){
      e.preventDefault();
      recalcAll();
      const tr = t.closest('tr');
      const next = tr?.nextElementSibling;
      const nextPn = next?.querySelector('input[name="part_number[]"]');
      if(nextPn) nextPn.focus();
    }
  });

  table.addEventListener('click', e=>{
    if(e.target.classList.contains('btn-del-row')){
      const tr=e.target.closest('tr');
      tr.parentNode.removeChild(tr);
      recalcAll();
    }
  });

  document.getElementById('btn-add-row').addEventListener('click', ()=>{
    const tbody=document.querySelector('#items-table tbody');
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td><input class="form-control form-control-sm" name="part_number[]" placeholder="Scan or type Part #"></td>
      <td><input class="form-control form-control-sm" name="part_name[]"  placeholder=""></td>
      <td><input class="form-control form-control-sm qty"  name="qty_returned[]" type="number" min="1" step="1" value="1"></td>
      <td><input class="form-control form-control-sm cost" name="unit_cost[]" type="number" min="0" step="0.01" value="0.00"></td>
      <td><input class="form-control form-control-sm" name="location[]" placeholder="auto"></td>
      <td><input class="form-control form-control-sm" name="tech_note[]" placeholder="Tech / Job #"></td>
      <td class="text-end line-total">$0.00</td>
      <td><button type="button" class="btn btn-sm btn-outline-danger btn-del-row">Delete</button></td>`;
    tbody.appendChild(tr);
    tr.querySelector('input[name="part_number[]"]').focus();
    recalcAll();
  });

  document.addEventListener('click', (e)=>{
    const btn = e.target.closest('button[name="action"]');
    if(!btn) return;
    const hidden = document.getElementById('action-hidden');
    if(hidden) hidden.value = btn.value || 'save';
  });

  const form = document.getElementById('editForm');
  form.addEventListener('submit', (e)=>{
    if(submitLock){ e.preventDefault(); return; }

    form.querySelectorAll('input[name="location[]"]').forEach(inp=>{
      inp.value = normalizeLocation(inp.value);
    });

    const hidden = document.getElementById('action-hidden');
    const chosenAction = hidden ? (hidden.value || '') :
                        ((e.submitter && e.submitter.value) ? e.submitter.value : '');

    if (chosenAction === 'post') {
      if (!validateBeforePost()) {
        e.preventDefault();
        return;
      }
    }

    submitLock = true;
    disableAllSubmitButtons();
    setTimeout(()=>{ submitLock=false; enableAllSubmitButtons(); }, 6000);
  });

  recalcAll();
})();
</script>
{% endblock %}
