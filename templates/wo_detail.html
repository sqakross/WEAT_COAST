{% extends "base.html" %}
{% block content %}

{# ---------- header row with actions ---------- #}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h3 class="mb-0">Work Order #{{ wo.id }}</h3>

  <div class="d-flex flex-wrap gap-2">
    <a class="btn btn-sm btn-outline-secondary"
       href="{{ url_for('inventory.wo_list') }}">
      ‚Üê Back to list
    </a>

    {% set role_low = (current_user.role or '')|lower %}
    {% if role_low in ['admin','superadmin'] %}
      <a class="btn btn-sm btn-outline-primary"
         href="{{ url_for('inventory.wo_edit', wo_id=wo.id) }}">
        ‚úèÔ∏è Edit
      </a>
    {% endif %}

    {% if role_low == 'superadmin' %}
      <form method="post"
            action="{{ url_for('inventory.wo_delete', wo_id=wo.id) }}"
            class="d-inline"
            onsubmit="return confirm('Delete Work Order #{{ wo.id }}? This cannot be undone.');">
        <button class="btn btn-sm btn-outline-danger" type="submit">üóëÔ∏è Delete</button>
      </form>
    {% endif %}
  </div>
</div>

{# ---------- permissions / role helpers ---------- #}
{% set role_low = (current_user.role or '')|lower %}
{% set is_adminlike = role_low in ['admin','superadmin'] %}
{% set is_tech      = role_low in ['technician','tech'] %}
{# these two come from routes.py context: #}
{% set can_view_docs   = can_view_docs %}
{% set can_confirm_any = can_confirm_any %}
{# is_my_wo also passed from routes.py #}

{# ---------- main WO info ---------- #}
{% set u0 = (wo.units|first) %}

<div class="row g-3 mb-4 small">
  <div class="col-md-3">
    <div><strong>Technician:</strong></div>
    <div>{{ wo.technician_username or wo.technician_name or '‚Äî' }}</div>
  </div>

  <div class="col-md-4">
    <div class="d-flex align-items-start flex-wrap gap-2">
      <div>
        <div><strong>Job(s):</strong></div>
        <div>
          <span id="wo-jobs">{{ wo.job_numbers or '' }}</span>
          <button type="button"
                  class="btn btn-sm btn-outline-secondary ms-2"
                  id="copyJobs">
            Copy
          </button>
        </div>
        <div class="text-muted small">
          primary:
          <code>{{ wo.canonical_job or '‚Äî' }}</code>
        </div>
      </div>
    </div>
  </div>

  <div class="col-md-3">
    <div><strong>Brand/Model:</strong></div>
    <div>
      {{ ((u0 and u0.brand) or wo.brand or '') ~ ' ' ~ ((u0 and u0.model) or wo.model or '') }}
    </div>
  </div>

  <div class="col-md-2">
    <div><strong>Serial:</strong></div>
    <div>{{ wo.serial or (u0 and u0.serial) or '‚Äî' }}</div>
  </div>

  <div class="col-md-3">
    <div><strong>Type:</strong></div>
    <div>
      {% if wo.job_type == 'INSURANCE' %}
        <span class="badge bg-warning text-dark">INSURANCE</span>
      {% else %}
        <span class="badge bg-secondary">BASE</span>
      {% endif %}
    </div>
  </div>

  <div class="col-md-3">
    <div><strong>Status:</strong></div>
    <div>
      {% if wo.status == 'done' %}
        <span class="badge bg-success">done</span>
      {% elif wo.status == 'ordered' %}
        <span class="badge bg-info text-dark">ordered</span>
      {% else %}
        <span class="badge bg-secondary">search_ordered</span>
      {% endif %}
    </div>
  </div>

  <div class="col-md-3">
    <div><strong>Delivery / Markup:</strong></div>
    <div>
      ${{ '%.2f'|format(wo.delivery_fee or 0) }}
      /
      {{ (wo.markup_percent or 0)|round(2) }}%
    </div>
  </div>

  <div class="col-md-3">
    <div><strong>Created:</strong></div>
    <div>{{ wo.created_at|local_date if wo.created_at else '‚Äî' }}</div>
  </div>
</div>

{# =========================================================
   PARTS TABLE (plan) - blended pricing
   ========================================================= #}

{% if display_parts and (display_parts|length) > 0 %}

<style>
  .num { text-align:right; font-variant-numeric: tabular-nums; }
  .name-ordered  { color:#0d6efd; font-weight:600; }
  .name-invoiced { color:#198754; font-weight:600; }
</style>

<div class="table-responsive mb-4">
  <table class="table table-sm table-bordered align-middle">
    <thead class="table-light">
      <tr>
        <th>Part #</th>
        <th>Alt PN#</th>
        <th>Name</th>
        <th class="text-end">Qty</th>
        <th class="text-end">Unit ($)</th>
        <th class="text-end">Total ($)</th>
        <th>Supplier</th>
        <th class="text-center" title="Ordered">Ordered</th>
        <th class="text-center">Ordered on</th>
        <th title="Backorder">B/O</th>
      </tr>
    </thead>

    <tbody>
      {% for row in display_parts %}
        <tr>
          <td><code>{{ row.part_number or '' }}</code></td>
          <td>{{ row.alt_part_numbers or '‚Äî' }}</td>

          <td>
            <span class="{% if row.is_invoiced %}name-invoiced{% elif row.is_ordered %}name-ordered{% endif %}">
              {{ row.part_name or '‚Äî' }}
            </span>
          </td>

          <td class="num">{{ row.qty or 0 }}</td>

          <td class="num">
            {{ '%.2f'|format(row.unit_price_display or 0) }}
          </td>

          <td class="num">
            {{ '%.2f'|format(row.total_display or 0) }}
          </td>

          <td>{{ row.supplier or '' }}</td>

          <td class="text-center">
            <input type="checkbox"
                   class="form-check-input"
                   disabled
                   {% if row.is_ordered %}checked{% endif %}>
          </td>

          <td class="text-center">
            {% if row.ordered_date %}
              {{ row.ordered_date|local_date }}
            {% else %}
              <span class="text-muted">‚Äî</span>
            {% endif %}
          </td>

          <td class="text-center">
            {% if row.backorder_flag %}
              <span class="badge bg-warning text-dark">B/O</span>
            {% else %}
              <span class="text-muted">‚Äî</span>
            {% endif %}
          </td>
        </tr>
      {% endfor %}
    </tbody>

    <tfoot>
      <tr class="table-light">
        <th colspan="5" class="text-end">Grand total (plan):</th>
        <th class="num">{{ '%.2f'|format(grand_total_display or 0) }}</th>
        <th colspan="4"></th>
      </tr>
    </tfoot>
  </table>
</div>

{% else %}
  <p class="text-muted">No parts listed for this work order.</p>
{% endif %}

{# =========================================================
   ISSUED ITEMS (flat list for this WO)
   ========================================================= #}

<h5 class="mt-4">Issued Items (this WO)</h5>

<style>
  .row-ret   { background:#fff5f5; }
  .inv-badge { font-size:.75rem; }
  .num       { text-align:right; font-variant-numeric: tabular-nums; }
</style>

<div class="table-responsive mb-2">
  <table class="table table-sm table-bordered align-middle">
    <thead class="table-light">
      <tr>
        <th>Issued At</th>
        <th>Invoice #</th>
        <th>Part #</th>
        <th>Name</th>
        <th class="text-end">Qty</th>
        <th class="text-end">Unit ($)</th>
      </tr>
    </thead>
    <tbody>
      {% if issued_items and (issued_items|length) > 0 %}
        {% for r in issued_items %}
          {% set is_ret = (r.quantity or 0) < 0 %}
          <tr class="{% if is_ret %}row-ret{% endif %}">
            <td>{{ r.issue_date|local_dt }}</td>
            <td class="text-nowrap">
              {{ '%06d'|format(r.invoice_number) if r.invoice_number else '‚Äî' }}
            </td>
            <td>
              <code>{{ r.part.part_number if r.part else r.part_id }}</code>
            </td>
            <td>{{ r.part.name if r.part else '‚Äî' }}</td>
            <td class="num">{{ r.quantity }}</td>
            <td class="num">{{ '%.2f'|format(r.unit_cost_at_issue or 0) }}</td>
          </tr>
        {% endfor %}
      {% else %}
        <tr>
          <td colspan="6" class="text-muted">No issued items yet.</td>
        </tr>
      {% endif %}
    </tbody>
  </table>
</div>

<div class="small mb-4">
  <span class="me-3">
    <strong>Issued total:</strong>
    ${{ '%.2f'|format(issued_total or 0) }}
    <span class="text-muted">(qty {{ issued_qty or 0 }})</span>
  </span>

  <span class="me-3">
    <strong>Returned total:</strong>
    ${{ '%.2f'|format(returned_total or 0) }}
    <span class="text-muted">(qty {{ returned_qty or 0 }})</span>
  </span>

  <span>
    <strong>Grand total (Issued ‚àí Returns):</strong>
    ${{ '%.2f'|format(net_total or 0) }}
    <span class="text-muted">(qty {{ net_qty or 0 }})</span>
  </span>
</div>

{# =========================================================
   ISSUED BATCHES (Technician View)
   ========================================================= #}

<h5 class="mt-4">Issued Batches (Technician View)</h5>
<style>
  .inv-return-row  { background:#fff5f5; }
  .inv-item-neg    { color:#c92a2a; }
  .inv-item        { line-height:1.25; }
</style>

{% set col_count = 5 + (2 if can_view_docs else 0) + (1 if can_confirm_any else 0) %}

<div class="table-responsive">
  <table class="table table-sm table-hover align-middle">
    <thead class="table-light small">
      <tr>
        <th>Issued At</th>
        <th>Technician</th>
        <th>Canonical Ref</th>
        <th>Items</th>
        <th class="text-end">Invoice Total</th>

        {% if can_view_docs %}
          <th>Report #</th>
          <th>Print</th>
        {% endif %}

        {% if can_confirm_any %}
          <th class="text-center">Confirm</th>
        {% endif %}
      </tr>
    </thead>

    <tbody class="small">
    {% if batches and (batches|length) > 0 %}
      {% for b in batches %}
        {% set is_return        = b.get('is_return') %}
        {% set items            = b.get('items') %}
        {% set total_value      = b.get('total_value', 0.0) %}
        {% set tech_for_links   = b.get('technician') or wo.technician_name or '' %}
        {% set job_for_links    = b.get('reference_job') or wo.canonical_job or '' %}
        {% set invoice_num      = b.get('invoice_number') %}

        <tr class="{% if is_return %}inv-return-row{% endif %}">
          <td class="batch-issued-at">
            <span class="issued-at-text">{{ b.get('issued_at') }}</span>
            <span class="batch-badge-holder ms-2">
              {% if b.get('all_confirmed') %}
                <span class="badge bg-success inv-badge">All confirmed</span>
              {% elif b.get('any_confirmed') %}
                <span class="badge bg-info text-dark inv-badge">Partly confirmed</span>
              {% endif %}
            </span>
          </td>

          <td>{{ b.get('technician') }}</td>
          <td>{{ b.get('canonical_ref') }}</td>

          <td>
            {% if items and (items|length) > 0 %}
              <ul class="mb-0 ps-3">
                {% for it in items %}
                  <li class="inv-item {% if it.negative %}inv-item-neg{% endif %}"
                      data-item-id="{{ it.id }}">
                    <code>{{ it.pn }}</code> √ó {{ it.qty }} ‚Äî {{ it.name }}
                    {% if it.unit_price is not none %}
                      (${{ '%.2f'|format(it.unit_price) }})
                    {% endif %}

                    {# ==== ADMIN / SUPERADMIN: –¥–≤—É–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–Ω–æ (check/uncheck) ==== #}
                    {% if is_adminlike %}
                      <form method="post"
                            action="{{ url_for('inventory.issued_confirm_toggle') }}"
                            style="display:inline">
                        <input type="hidden" name="record_id" value="{{ it.id }}">
                        <input type="hidden" name="wo_id" value="{{ wo.id }}">

                        <input type="checkbox"
                               name="state"
                               value="1"
                               class="form-check-input ms-2"
                               {% if it.confirmed %}checked{% endif %}
                               onchange="this.form.submit()">

                        <span class="small text-muted ms-1 confirm-meta">
                          {% if it.confirmed %}
                            ‚úî confirmed
                            {% if it.confirmed_by %} by {{ it.confirmed_by }}{% endif %}
                            {% if it.confirmed_at %} ‚Ä¢ {{ it.confirmed_at }}{% endif %}
                          {% else %}
                            unchecked
                          {% endif %}
                        </span>
                      </form>

                    {# ==== TECHNICIAN (—Ç–æ–ª—å–∫–æ —Å–≤–æ–π WO): —Ç–æ–ª—å–∫–æ –ø–æ—Å—Ç–∞–≤–∏—Ç—å, –Ω–µ —Å–Ω–∏–º–∞—Ç—å ==== #}
                    {% elif is_tech and is_my_wo %}
                      <span class="ms-2 tech-confirm-wrapper">
                        <input type="checkbox"
                               class="form-check-input ms-2 tech-confirm"
                               data-record-id="{{ it.id }}"
                               data-woid="{{ wo.id }}"
                               {% if it.confirmed %}checked disabled{% endif %}>

                        <span class="small text-muted ms-1 confirm-meta">
                          {% if it.confirmed %}
                            ‚úî confirmed
                            {% if it.confirmed_by %} by {{ it.confirmed_by }}{% endif %}
                            {% if it.confirmed_at %} ‚Ä¢ {{ it.confirmed_at }}{% endif %}
                          {% else %}
                            unchecked
                          {% endif %}
                        </span>
                      </span>

                    {# ==== READ ONLY ==== #}
                    {% else %}
                      <span class="small text-muted ms-2 confirm-meta">
                        {% if it.confirmed %}
                          ‚úî confirmed
                          {% if it.confirmed_by %} by {{ it.confirmed_by }}{% endif %}
                          {% if it.confirmed_at %} ‚Ä¢ {{ it.confirmed_at }}{% endif %}
                        {% else %}
                          unchecked
                        {% endif %}
                      </span>
                    {% endif %}
                  </li>
                {% endfor %}
              </ul>
            {% else %}
              <span class="text-muted">‚Äî</span>
            {% endif %}
          </td>

          <td class="text-end {% if total_value < 0 %}inv-item-neg{% endif %}">
            ${{ '%.2f'|format(total_value) }}
            {% if is_return %}
              <span class="badge bg-danger inv-badge">RETURN</span>
            {% else %}
              <span class="badge bg-success inv-badge">ISSUED</span>
            {% endif %}
          </td>

          {% if can_view_docs %}
            <td class="text-nowrap">
              {% if invoice_num %}
                <a class="btn btn-sm btn-outline-secondary"
                   href="{{ url_for('inventory.reports_grouped') }}?issued_to={{ tech_for_links|urlencode }}&technician={{ tech_for_links|urlencode }}&company={{ tech_for_links|urlencode }}&tech={{ tech_for_links|urlencode }}&reference_job={{ job_for_links|urlencode }}&ref_job={{ job_for_links|urlencode }}&ref={{ job_for_links|urlencode }}&job={{ job_for_links|urlencode }}&jobs={{ job_for_links|urlencode }}"
                   target="_blank"
                   rel="noopener">
                  Open Report
                </a>
              {% else %}
                ‚Äî
              {% endif %}
            </td>

            <td>
              {% if invoice_num %}
                <a class="btn btn-sm btn-outline-primary"
                   href="{{ url_for('inventory.view_invoice_pdf') }}?invoice_number={{ invoice_num }}"
                   target="_blank"
                   rel="noopener">
                  Print
                </a>
              {% else %}
                ‚Äî
              {% endif %}
            </td>
          {% endif %}

          {% if can_confirm_any %}
            <td class="text-center align-middle batch-status-col">
              {% if b.get('all_confirmed') %}
                ‚úÖ
              {% elif b.get('any_confirmed') %}
                ‚òëÔ∏è
              {% else %}
                ‚òê
              {% endif %}
            </td>
          {% endif %}
        </tr>
      {% endfor %}
    {% else %}
      <tr>
        <td colspan="{{ col_count }}" class="text-muted text-center">
          No batches yet.
        </td>
      </tr>
    {% endif %}
    </tbody>
  </table>
</div>

{# =========================================================
   TECH STICKY FOOTER (BIG ACTION BAR FOR TABLET TECHNICIAN)
   ========================================================= #}

{# –Ω–∞–π–¥—ë–º –ø–µ—Ä–≤—ã–π invoice_number —Å—Ä–µ–¥–∏ batches, —á—Ç–æ–±—ã –¥–∞—Ç—å Print #}
{% set first_invoice = None %}
{% if batches and (batches|length) > 0 %}
  {% for bb in batches %}
    {% if bb.get('invoice_number') and not first_invoice %}
      {% set first_invoice = bb.get('invoice_number') %}
    {% endif %}
  {% endfor %}
{% endif %}

<div class="tech-sticky-footer d-none d-md-flex">
  <a class="btn-tech-action"
     href="{{ url_for('inventory.wo_list') }}">
    ‚Üê Back to Work Orders
  </a>

  {% if first_invoice %}
    <a class="btn-tech-action"
       href="{{ url_for('inventory.view_invoice_pdf') }}?invoice_number={{ first_invoice }}"
       target="_blank"
       rel="noopener">
      Print
    </a>
  {% else %}
    <button class="btn-tech-action" disabled
            style="opacity:.5; cursor:not-allowed;">
      Print
    </button>
  {% endif %}
</div>

{% endblock %}

{% block extra_js %}
<script>
// technician one-way confirm without page redirect, + live badge update
async function confirmIssuedPart(checkbox) {
  // deprecated old hook - we replaced it with the new listener below
  // left here just in case something still calls it
  console.log("[confirmIssuedPart] legacy call");
}

// NEW listener that supports:
// 1) POST via fetch
// 2) disable checkbox after success
// 3) live update 'Partly confirmed' / 'All confirmed' badge
document.addEventListener("DOMContentLoaded", () => {
  document.querySelectorAll(".tech-confirm").forEach(cb => {
    cb.addEventListener("change", async (e) => {
      const box  = e.target;
      const recId = box.dataset.recordId;
      const woId  = box.dataset.woid;

      // technician can only SET true. If they uncheck manually (shouldn't happen),
      // we just bail.
      if (!box.checked) {
        return;
      }

      const params = new URLSearchParams();
      params.set("record_id", recId);
      params.set("wo_id",    woId);
      params.set("state",    "1");

      try {
        const resp = await fetch("{{ url_for('inventory.issued_confirm_toggle') }}", {
          method: "POST",
          headers: { "Content-Type": "application/x-www-form-urlencoded" },
          body: params.toString(),
          credentials: "same-origin"
        });

        if (!resp.ok) {
          alert("Error saving confirmation: HTTP " + resp.status);
          box.checked = false;
          return;
        }

        // lock checkbox (can't undo)
        box.disabled = true;

        // update text next to this item
        const li = box.closest("li[data-item-id]");
        if (li) {
          li.querySelectorAll(".confirm-meta").forEach(metaEl => {
            metaEl.innerHTML = "‚úî confirmed";
          });
        }

        // Now recalc batch badge (per-row)
        const tr = box.closest("tr");
        if (tr) {
          const batchBadgeHolder = tr.querySelector(".batch-badge-holder");
          const batchStatusCol   = tr.querySelector(".batch-status-col");

          const techBoxes = tr.querySelectorAll(".tech-confirm");
          const confirmedCount = Array.from(techBoxes).filter(el => el.checked).length;
          const totalCount     = techBoxes.length;

          // wipe old badges in the header cell
          if (batchBadgeHolder) {
            batchBadgeHolder.innerHTML = "";
            if (totalCount > 0 && confirmedCount === totalCount) {
              batchBadgeHolder.innerHTML =
                '<span class="badge bg-success inv-badge">All confirmed</span>';
            } else if (confirmedCount > 0) {
              batchBadgeHolder.innerHTML =
                '<span class="badge bg-info text-dark inv-badge">Partly confirmed</span>';
            }
          }

          // also update rightmost status column (‚úÖ / ‚òëÔ∏è / ‚òê)
          if (batchStatusCol) {
            if (totalCount > 0 && confirmedCount === totalCount) {
              batchStatusCol.textContent = "‚úÖ";
            } else if (confirmedCount > 0) {
              batchStatusCol.textContent = "‚òëÔ∏è";
            } else {
              batchStatusCol.textContent = "‚òê";
            }
          }
        }

      } catch (err) {
        console.error("Network error while confirming part.", err);
        alert("Network error while confirming part.");
        box.checked = false;
      }
    });
  });

  // Copy job numbers
  const btnCopy = document.getElementById('copyJobs');
  if (btnCopy) {
    btnCopy.addEventListener('click', async () => {
      const el = document.getElementById('wo-jobs');
      const txt = (el?.textContent || '').trim();
      if (!txt) return;
      try {
        await navigator.clipboard.writeText(txt);
      } catch (e) {
        const ta = document.createElement('textarea');
        ta.value = txt;
        document.body.appendChild(ta);
        ta.select();
        document.execCommand('copy');
        ta.remove();
      }
    });
  }
});
</script>
{% endblock %}
