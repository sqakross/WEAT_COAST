{% extends "base.html" %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h3 class="mb-0">Work Order #{{ wo.id }}</h3>
  <div class="d-flex gap-2">
    <a class="btn btn-outline-secondary" href="{{ url_for('inventory.wo_list') }}">← Back to list</a>
    {% if current_user.role in ['admin','superadmin'] %}
      <a class="btn btn-outline-primary" href="{{ url_for('inventory.wo_edit', wo_id=wo.id) }}">✏️ Edit</a>
    {% endif %}
  </div>
</div>

<div class="row g-3 mb-3">
  <div class="col-md-3"><strong>Technician:</strong> {{ wo.technician_name }}</div>

  <div class="col-md-4">
    <strong>Job(s):</strong>
    <span id="wo-jobs">{{ wo.job_numbers }}</span>
    <button type="button" class="btn btn-sm btn-outline-secondary ms-2" id="copyJobs">Copy</button>
    <div class="text-muted small">primary: <code>{{ wo.canonical_job }}</code></div>
  </div>

  <div class="col-md-3"><strong>Brand/Model:</strong> {{ wo.brand }} {{ wo.model }}</div>
  <div class="col-md-2"><strong>Serial:</strong> {{ wo.serial }}</div>

  <div class="col-md-3">
    <strong>Type:</strong>
    {% if wo.job_type == 'INSURANCE' %}
      <span class="badge bg-warning text-dark">INSURANCE</span>
    {% else %}
      <span class="badge bg-secondary">BASE</span>
    {% endif %}
  </div>

  <div class="col-md-3">
    <strong>Status:</strong>
    {% if wo.status == 'done' %}
      <span class="badge bg-success">done</span>
    {% elif wo.status == 'ordered' %}
      <span class="badge bg-info text-dark">ordered</span>
    {% else %}
      <span class="badge bg-secondary">search_ordered</span>
    {% endif %}
  </div>

  <div class="col-md-3">
    <strong>Delivery / Markup:</strong>
    ${{ '%.2f'|format(wo.delivery_fee or 0) }} / {{ (wo.markup_percent or 0)|round(2) }}%
  </div>

  <div class="col-md-3">
    <strong>Created:</strong> {{ wo.created_at.strftime('%Y-%m-%d') if wo.created_at else '—' }}
  </div>
</div>

{% if wo.parts and avail %}
<div class="table-responsive">
  <table class="table table-sm table-bordered align-middle">
    <thead class="table-light">
      <tr>
        <th>Part #</th>
        <th>Name</th>
        <th class="text-end">Needed</th>
        <th class="text-end">On hand</th>
        <th class="text-end">Issue now</th>
        <th>Status hint</th>
      </tr>
    </thead>
    <tbody>
      {% set total_needed = 0 %}
      {% set total_issue = 0 %}
      {% for r in avail %}
      {% set total_needed = total_needed + (r.requested or 0) %}
      {% set total_issue = total_issue + (r.issue_now or 0) %}
      <tr class="{% if r.issue_now and r.issue_now > 0 %}table-success{% elif r.on_hand and r.on_hand > 0 %}table-warning{% endif %}">
        <td><code>{{ r.part_number }}</code></td>
        <td>{{ r.part_name }}</td>
        <td class="text-end">{{ r.requested }}</td>
        <td class="text-end">{{ r.on_hand }}</td>
        <td class="text-end">{{ r.issue_now }}</td>
        <td>
          {% if r.status_hint.startswith('WAIT') %}
            <span class="badge bg-warning text-dark">{{ r.status_hint }}</span>
          {% else %}
            <span class="badge bg-success">{{ r.status_hint }}</span>
          {% endif %}
        </td>
      </tr>
      {% endfor %}
    </tbody>
    <tfoot>
      <tr class="table-light">
        <th colspan="2" class="text-end">Totals:</th>
        <th class="text-end">{{ total_needed }}</th>
        <th></th>
        <th class="text-end">{{ total_issue }}</th>
        <th></th>
      </tr>
    </tfoot>
  </table>
</div>
{% else %}
<p class="text-muted">No parts listed for this work order.</p>
{% endif %}

{% if current_user.role in ['admin','superadmin'] %}
<!-- скрытая форма (будет сабмититься из модалки) -->
<form id="issueForm" method="post" action="{{ url_for('inventory.wo_issue_instock', wo_id=wo.id) }}"></form>

<div class="d-flex flex-wrap gap-2 mt-3">
  <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#issuePreviewModal">
    Preview & Issue In-Stock
  </button>

  <form method="post" action="{{ url_for('inventory.wo_set_status', wo_id=wo.id) }}">
    <input type="hidden" name="status" value="ordered">
    <button class="btn btn-outline-warning" {% if wo.status=='ordered' %}disabled{% endif %}>
      Mark as ordered
    </button>
  </form>

  <form method="post" action="{{ url_for('inventory.wo_set_status', wo_id=wo.id) }}">
    <input type="hidden" name="status" value="done">
    <button class="btn btn-outline-success" {% if wo.status=='done' %}disabled{% endif %}>
      Mark as done
    </button>
  </form>
</div>

<!-- Модалка-превью выдачи -->
<div class="modal fade" id="issuePreviewModal" tabindex="-1" aria-labelledby="issuePreviewLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="issuePreviewLabel">Issue preview (in-stock lines)</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">

        {% set issue_rows = [] %}
        {% for r in avail %}
          {% if r.issue_now and r.issue_now > 0 %}
            {% set _ = issue_rows.append(r) %}
          {% endif %}
        {% endfor %}

        {% if issue_rows %}
          <div class="table-responsive">
            <table class="table table-sm table-bordered align-middle">
              <thead class="table-light">
                <tr>
                  <th>Part #</th>
                  <th>Name</th>
                  <th class="text-end">Needed</th>
                  <th class="text-end">On hand</th>
                  <th class="text-end">Issue now</th>
                </tr>
              </thead>
              <tbody>
                {% set total_issue = 0 %}
                {% for r in issue_rows %}
                {% set total_issue = total_issue + (r.issue_now or 0) %}
                <tr>
                  <td><code>{{ r.part_number }}</code></td>
                  <td>{{ r.part_name }}</td>
                  <td class="text-end">{{ r.requested }}</td>
                  <td class="text-end">{{ r.on_hand }}</td>
                  <td class="text-end">{{ r.issue_now }}</td>
                </tr>
                {% endfor %}
              </tbody>
              <tfoot>
                <tr class="table-light">
                  <th colspan="4" class="text-end">Total lines:</th>
                  <th class="text-end">{{ total_issue }}</th>
                </tr>
              </tfoot>
            </table>
          </div>

          <div class="alert alert-info">
            After issuing, you’ll be redirected to <strong>Reports</strong> for printing the invoice.
          </div>
        {% else %}
          <div class="alert alert-warning mb-0">
            Nothing available to issue right now (all lines are WAIT).
          </div>
        {% endif %}
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Close</button>
        {% if issue_rows %}
          <button type="button" class="btn btn-primary" id="confirmIssueBtn">Issue Now</button>
        {% else %}
          <button type="button" class="btn btn-primary" id="confirmIssueBtn" disabled>Issue Now</button>
        {% endif %}
      </div>
    </div>
  </div>
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
  (function () {
    // Copy Job numbers
    const btnCopy = document.getElementById('copyJobs');
    btnCopy?.addEventListener('click', async () => {
      const txt = document.getElementById('wo-jobs')?.textContent?.trim() || '';
      if (!txt) return;
      try {
        await navigator.clipboard.writeText(txt);
        window.showToast?.('Job numbers copied');
      } catch (e) {
        const ta = document.createElement('textarea');
        ta.value = txt; document.body.appendChild(ta);
        ta.select(); document.execCommand('copy'); ta.remove();
        window.showToast?.('Job numbers copied');
      }
    });

    // Submit hidden form from modal
    const btnIssue = document.getElementById('confirmIssueBtn');
    btnIssue?.addEventListener('click', () => {
      document.getElementById('issueForm')?.submit();
    });
  })();
</script>
{% endblock %}
