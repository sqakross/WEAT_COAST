{% extends "base.html" %}
{% block content %}

<h3>Receiving Batches</h3>

<form class="row g-2 mb-3" method="get">
  <div class="col-md-4 col-sm-6">
    <input name="q"
           class="form-control"
           placeholder="Supplier / Invoice # / Part # / Part Name"
           value="{{ filters.q }}">
  </div>

  <div class="col-auto">
    <input name="date_from" type="date" class="form-control"
           value="{{ filters.date_from }}">
  </div>

  <div class="col-auto">
    <input name="date_to" type="date" class="form-control"
           value="{{ filters.date_to }}">
  </div>

  <div class="col-auto">
    <select name="status" class="form-select">
      <option value="">Any status</option>
      <option value="draft"  {{ 'selected' if filters.status=='draft'  }}>Draft</option>
      <option value="posted" {{ 'selected' if filters.status=='posted' }}>Posted</option>
    </select>
  </div>

  <div class="col-auto">
    <button class="btn btn-primary">Search</button>
    <a class="btn btn-outline-secondary"
       href="{{ url_for('inventory.receiving_new') }}">+ New Batch</a>
  </div>
</form>

{# Роль / права #}
{% set role = current_user.role if current_user.is_authenticated else '' %}
{% set can_super = current_user.is_authenticated and (
  role == 'superadmin'
  or (current_user.is_superadmin|default(false))
  or (current_user.is_super_admin|default(false))
) %}

<table class="table table-sm table-hover align-middle">
  <thead>
    <tr>
      <th style="width:60px;">ID</th>
      <th style="width:110px;">Date</th>
      <th>Supplier</th>
      <th style="width:160px;">Invoice #</th>
      <th style="width:100px;">Status</th>
      <th style="width:80px;">Stock</th>
      <th style="width:80px;" class="text-end">Qty</th>
      <th style="width:140px;" class="text-end">Total Cost</th>
      {% if can_super %}
        <th style="width:260px;">Actions</th>
      {% endif %}
    </tr>
  </thead>
  <tbody>

  {% for b in batches %}
    {% set lines = (b.lines if (b.lines is defined) else (b.items if (b.items is defined) else [])) %}
    {% set ns = namespace(qty=0, total=0.0) %}
    {% for it in lines %}
      {% set q = (it.qty|default(it.quantity, true)|default(0, true))|int %}
      {% set u = (it.unit_cost|default(it.unit_cost_at_issue, true)|default(0.0, true))|float %}
      {% set ns.qty = ns.qty + q %}
      {% set ns.total = ns.total + (q * u) %}
    {% endfor %}

    {% set is_posted = (b.status|default('', true)) == 'posted' %}
    {% set stock_applied = (stock_flags[b.id] if stock_flags is defined and b.id in stock_flags else false) %}

    <tr onclick="location.href='{{ url_for('inventory.receiving_detail', batch_id=b.id) }}'"
        style="cursor:pointer">
      <td>{{ b.id }}</td>
      <td>{{ b.invoice_date|default('—', true) }}</td>
      <td>{{ b.supplier_name|default('', true) }}</td>
      <td>{{ b.invoice_number|default('', true) }}</td>

      <td>
        {% if is_posted %}
          <span class="badge bg-success">posted</span>
        {% else %}
          <span class="badge bg-secondary">draft</span>
        {% endif %}
      </td>

      <td>
        {% if stock_applied %}
          <span class="text-success" style="font-size:.8rem; white-space:nowrap;">● stock</span>
        {% else %}
          <span class="text-muted" style="font-size:.8rem; white-space:nowrap;">● clear</span>
        {% endif %}
      </td>

      <td class="text-end">{{ ns.qty }}</td>
      <td class="text-end">
        {{ b.currency|default('USD', true) }}
        {{
          '%.2f' % (
            (totals.get(b.id) if (totals is defined and b.id in totals) else ns.total)
          )
        }}
      </td>

      {% if can_super %}
      <td onclick="event.stopPropagation();">
        <form action="{{ url_for('inventory.receiving_toggle', batch_id=b.id) }}"
              method="post" style="display:inline;">
          <button class="btn btn-sm {{ 'btn-warning' if is_posted else 'btn-primary' }}" type="submit">
            {{ 'Unpost' if is_posted else 'Post' }}
          </button>
        </form>

        <form action="{{ url_for('inventory.receiving_clear_keys', batch_id=b.id) }}"
              method="post" style="display:inline;"
              onsubmit="return confirm('Clear import keys for batch #{{ b.id }}? This allows re-import from the same file.');">
          <button class="btn btn-sm btn-outline-secondary" type="submit">Clear keys</button>
        </form>

        <form action="{{ url_for('inventory.receiving_delete', batch_id=b.id) }}"
              method="post" style="display:inline;"
              onsubmit="return confirm('Delete batch #{{ b.id }}? This will also clear its import keys.');">
          <button class="btn btn-sm btn-danger" type="submit"
                  {% if stock_applied %}disabled title="Unpost first to remove from stock before deleting."{% endif %}>
            Delete
          </button>
        </form>
      </td>
      {% endif %}
    </tr>
  {% endfor %}
  </tbody>
</table>

{% endblock %}
