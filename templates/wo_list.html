{% extends "base.html" %}
{% block content %}
<h3 class="d-flex align-items-baseline gap-3">
  <span>Work Orders</span>
  <small class="text-muted" style="font-size:.9rem;">
    {% if count_items is defined %}
      Showing {{ count_items }} result{% if count_items != 1 %}s{% endif %}
      {% if count_items >= 200 %}
        (limited to 200)
      {% endif %}
    {% endif %}
  </small>
</h3>

{% if current_user.is_authenticated and current_user.role in ['admin','superadmin'] %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <div></div>
  <a href="{{ url_for('inventory.wo_new') }}" class="btn btn-success">+ New Work Order</a>
</div>
{% endif %}

<form method="get" class="row g-2 mb-3 dashboard-filters" style="position:static;">

  {# unified free-text search #}
  <div class="col-md-4">
    <label class="form-label mb-1">Search</label>
    <input
      name="q"
      class="form-control"
      list="wo-hints"
      value="{{ args.get('q','') if args else '' }}"
      placeholder="Tech / Job # / Brand / Model / Part # / Part name"
    >
  </div>

  {# date from #}
  <div class="col-md-2">
    <label class="form-label mb-1">From</label>
    <input
      type="date"
      name="from"
      class="form-control"
      value="{{ args.get('from','') if args else '' }}"
    >
  </div>

  {# date to #}
  <div class="col-md-2">
    <label class="form-label mb-1">To</label>
    <input
      type="date"
      name="to"
      class="form-control"
      value="{{ args.get('to','') if args else '' }}"
    >
  </div>

  <div class="col-12 d-flex gap-2 mt-1">
    <button class="btn btn-primary">Search</button>
    <a class="btn btn-outline-secondary" href="{{ url_for('inventory.wo_list') }}">Reset</a>
  </div>
</form>

{# datalist for autocomplete suggestions #}
<datalist id="wo-hints">
  {% if hint_values is defined %}
    {% for h in hint_values %}
      {% if h %}
        <option value="{{ h }}">
      {% endif %}
    {% endfor %}
  {% endif %}
</datalist>

<div class="table-responsive">
  <table class="table table-sm table-hover align-middle wo-list-table">
    <thead class="table-light">
      <tr>
        <th class="col-id">ID</th>
        <th class="col-tech">Technician</th>
        <th>Jobs</th>
        <th>Brand/Model</th>
        <th class="col-type">Type</th>
        <th class="col-status">Status</th>
        <th class="col-created">Created</th>
        <th class="text-end col-actions">Actions</th>
      </tr>
    </thead>
    <tbody>
      {% if items and items|length > 0 %}
        {% for w in items %}
        <tr>
          <td>{{ w.id }}</td>

          <td>{{ w.technician_name or '—' }}</td>

          <td>
            <span class="jobs-trunc"
                  title="{{ w.job_numbers or '' }}">
              {{ w.job_numbers or '—' }}
            </span>
            {% if w.canonical_job %}
              <div class="text-muted small">
                primary:
                <code>{{ w.canonical_job }}</code>
              </div>
            {% endif %}
          </td>

          <td>
            <span class="brand-trunc"
                  title="{{ (w.brand or '') ~ ' ' ~ (w.model or '') }}">
              {{ (w.brand or '') ~ (' ' if w.brand and w.model else '') ~ (w.model or '') }}
            </span>
          </td>

          <td>
            {% if w.job_type == 'INSURANCE' %}
              <span class="badge bg-warning text-dark">INSURANCE</span>
            {% else %}
              <span class="badge bg-secondary">BASE</span>
            {% endif %}
          </td>

          <td>
            {% if w.status == 'done' %}
              <span class="badge bg-success">done</span>
            {% elif w.status == 'ordered' %}
              <span class="badge bg-info text-dark">ordered</span>
            {% else %}
              <span class="badge bg-secondary">search_ordered</span>
            {% endif %}
          </td>

          <td>
            {{ w.created_at.strftime('%Y-%m-%d') if w.created_at else '—' }}
          </td>

          <td class="text-end">
            <div class="wo-actions d-inline-flex gap-1">

              {# Open should always go to DETAIL page #}
              <a class="btn btn-outline-primary btn-sm"
                 href="{{ url_for('inventory.wo_detail', wo_id=w.id) }}">
                Open
              </a>

              {# Edit visible only to admin/superadmin #}
              {% if current_user.role in ['admin','superadmin'] %}
                <a class="btn btn-outline-secondary btn-sm"
                   href="{{ url_for('inventory.wo_edit', wo_id=w.id) }}">
                  Edit
                </a>
              {% endif %}

              {# Delete only for superadmin #}
              {% if current_user.role == 'superadmin' %}
                <form method="post"
                      action="{{ url_for('inventory.wo_delete', wo_id=w.id) }}"
                      onsubmit="return confirm('Delete Work Order #{{ w.id }}? This cannot be undone.');"
                      class="d-inline">
                  <button type="submit" class="btn btn-outline-danger btn-sm">Delete</button>
                </form>
              {% endif %}
            </div>
          </td>
        </tr>
        {% endfor %}
      {% else %}
        <tr>
          <td colspan="8" class="text-muted">No work orders found.</td>
        </tr>
      {% endif %}
    </tbody>
  </table>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', () => {
  const searchInput = document.querySelector('input[name="q"]');
  if (searchInput) {
    // автофокус только если поле пустое
    if (!searchInput.value.trim()) {
      searchInput.focus();
      searchInput.select();
    }
  }
});
</script>
{% endblock %}

