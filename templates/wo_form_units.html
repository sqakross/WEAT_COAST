{% extends "base.html" %}
{% block content %}
{# EDIT MODE only if wo AND wo.id exist #}
{% set IS_EDIT = (wo and wo.id) %}
{% set RO = readonly or False %}
{% set dis = 'disabled' if RO else '' %}
{% set ro  = 'readonly' if RO else '' %}

<style>
    .col-wh{width:58px}
  .col-inv{width:90px}
  .col-hint{width:78px}

  .col-narrow{width:90px}
  .col-money{width:90px;text-align:right}
  .col-qty{width:64px;text-align:right}
  .col-issue{width:70px;text-align:center}
  .num{text-align:right;font-variant-numeric:tabular-nums}
  .wo-form .unit-table thead th{position:static!important;pointer-events:none;}
  .wo-form .unit-table td.issue-cell{position:relative;}
  .wo-form .unit-table .issue-check{position:relative; z-index:3; pointer-events:auto!important; opacity:1!important; cursor:pointer;}
  .wo-form .unit-table td.issue-cell, .wo-form .unit-table td.issue-cell *{ pointer-events:auto!important; }
  .unit-table .ordered-col{ display:none; }

  /* ВСЕ текстовые поля формы показываем как UPPERCASE */
  .wo-form input[type="text"] {
    text-transform: uppercase;
  }

  /* ===== Parts table layout: make Part# + Part name usable ===== */
    .wo-form .unit-table{
      table-layout: fixed;
      width: 100%;
      min-width: 0;            /* ✅ no forced horizontal scroll */
    }


    /* 1) PART # (1-я колонка) */
    .wo-form .unit-table th:nth-child(1),
    .wo-form .unit-table td:nth-child(1){
      width: 140px;
    }
    .wo-form .unit-table td:nth-child(1) .pn{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-size: .88rem;
    }

    /* 2) ALT PN# (2-я колонка) */
    .wo-form .unit-table th:nth-child(2),
    .wo-form .unit-table td:nth-child(2){
      width: 110px;
    }

    /* 3) PART NAME (3-я колонка) — самая широкая */
    .wo-form .unit-table th:nth-child(3),
    .wo-form .unit-table td:nth-child(3){
      width: 320px; /* можешь поднять до 360-420 если хочется ещё шире */
    }

    /* аккуратнее поля внутри таблицы */
    .wo-form .unit-table td .form-control{
      padding: .20rem .35rem;
      font-size: .90rem;
    }

    /* чтобы длинное имя не выглядело “сломано” — показываем многоточие, но полное будет в tooltip (ниже) */
    .wo-form .unit-table td:nth-child(3) .part-name{
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }


  /* Чуть уменьшаем чекбоксы, сами поля не трогаем */
  .unit-table .form-check-input{
    transform: scale(.9);
  }

  /* ВИЗУАЛЬНАЯ ПОДСВЕТКА КАК В WORK ORDER */

  /* Выданные (issued) – зелёные */
  tr.issued-row{
    background:#e6f4ea;
  }
  tr.issued-row .pn,
  tr.issued-row .part-name,
  tr.issued-row .qty,
  tr.issued-row .unit-cost{
    color:#198754;
    font-weight:600;
  }

  /* Заказанные (ordered) – синие */
  tr.row-ordered{
    background:#e7f1ff;
  }
  tr.row-ordered .pn,
  tr.row-ordered .part-name,
  tr.row-ordered .qty,
  tr.row-ordered .unit-cost{
    color:#0d6efd;
    font-weight:600;
  }

  /* Backorder – красные */
  tr.row-backorder{
    background:#fff5f5;
  }
  tr.row-backorder .pn,
  tr.row-backorder .part-name,
  tr.row-backorder .qty,
  tr.row-backorder .unit-cost{
    color:#c92a2a;
    font-weight:600;
  }

  .wo-header-line {
    display:flex;
    flex-wrap:wrap;
    align-items:center;
    gap:.75rem;
    margin-bottom:.5rem;
  }
  .wo-header-line h3 { margin:0; }

  .inv-missing {
    outline: 2px solid #dc3545 !important;
    box-shadow: 0 0 0 .2rem rgba(220,53,69,.25) !important;
  }

  /* ================================
   P2) COMPACT MODE: fit all columns
   ================================ */

/* 1) таблица без forced min-width */
.wo-form .unit-table{
  table-layout: fixed;
  width: 100%;
  min-width: 0 !important;     /* ✅ важно: убираем принудительный скролл */
}

/* 2) делаем всё компактнее */
.wo-form .unit-table th,
.wo-form .unit-table td{
  padding: .18rem .22rem !important;
  font-size: .78rem;
  vertical-align: middle;
}

.wo-form .unit-table td .form-control{
  padding: .12rem .20rem !important;
  font-size: .78rem;
  height: 26px;
  line-height: 1.1;
}

/* 3) чекбоксы меньше */
.wo-form .unit-table .form-check-input{
  transform: scale(.85);
}

/* 4) ширины колонок по порядку (как у тебя в thead) */
.wo-form .unit-table th:nth-child(1),
.wo-form .unit-table td:nth-child(1){ width: 110px; } /* Part # */

.wo-form .unit-table th:nth-child(2),
.wo-form .unit-table td:nth-child(2){ width: 85px; }  /* Alt PN */

.wo-form .unit-table th:nth-child(3),
.wo-form .unit-table td:nth-child(3){ width: 170px; } /* Part name */

.wo-form .unit-table th:nth-child(4),
.wo-form .unit-table td:nth-child(4){ width: 48px; }  /* Qty */

.wo-form .unit-table th:nth-child(5),
.wo-form .unit-table td:nth-child(5){ width: 70px; }  /* Unit */

.wo-form .unit-table th:nth-child(6),
.wo-form .unit-table td:nth-child(6){ width: 70px; }  /* Total */

.wo-form .unit-table th:nth-child(7),
.wo-form .unit-table td:nth-child(7){ width: 46px; }  /* WH */

.wo-form .unit-table th:nth-child(8),
.wo-form .unit-table td:nth-child(8){ width: 60px; }  /* INV# */

.wo-form .unit-table th:nth-child(9),
.wo-form .unit-table td:nth-child(9){ width: 36px; }  /* B/O */

.wo-form .unit-table th:nth-child(10),
.wo-form .unit-table td:nth-child(10){ width: 36px; } /* INS */

.wo-form .unit-table th:nth-child(11),
.wo-form .unit-table td:nth-child(11){ width: 60px; } /* Sup */

.wo-form .unit-table th:nth-child(12),
.wo-form .unit-table td:nth-child(12){ width: 36px; } /* Ord */

.wo-form .unit-table th:nth-child(13),
.wo-form .unit-table td:nth-child(13){ width: 78px; } /* Stock hint */

.wo-form .unit-table th:nth-child(14),
.wo-form .unit-table td:nth-child(14){ width: 52px; } /* Issue? */

.wo-form .unit-table th:nth-child(15),
.wo-form .unit-table td:nth-child(15){ width: 42px; } /* delete */

/* 5) Part name аккуратно режем */
.wo-form .unit-table td:nth-child(3) .part-name{
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

</style>

<div class="wo-header-line">
  <h3>{{ RO and 'View' or (IS_EDIT and 'Edit' or 'New') }} Work Order (multi-appliance)</h3>

  <button type="button"
          class="btn btn-sm btn-outline-primary"
          id="btnCopyWO">
    Copy WO
  </button>
</div>

{% if IS_EDIT %}
  {% set created_name = (wo.created_by_user and wo.created_by_user.username) or (wo.created_by or wo.technician_name) or '—' %}
  {% set updated_name = (wo.updated_by_user and wo.updated_by_user.username) or (wo.updated_by or wo.technician_name) or '—' %}

  <div class="text-muted" style="margin-top:-6px; margin-bottom:10px; font-size:.85rem;">
    <span>
      <strong>Created:</strong>
      {{ created_name }}
      •
      {{ wo.created_at | local_dt("%m/%d/%Y %I:%M %p") if wo.created_at else '—' }}
    </span>
    <span class="mx-2">|</span>
    <span>
      <strong>Updated:</strong>
      {{ updated_name }}
      •
      {{ wo.updated_at | local_dt("%m/%d/%Y %I:%M %p") if wo.updated_at else '—' }}
    </span>
  </div>
{% endif %}



<form method="post" action="{{ url_for('inventory.wo_save') }}" id="woForm" class="wo-form">
  {% if IS_EDIT %}
    <input type="hidden" name="wo_id" value="{{ wo.id }}">
  {% endif %}

  <div class="row g-3 mb-3">
    <div class="col-md-3">
      <label class="form-label">Technician</label>
      {% if not RO %}
        <select name="technician_id" class="form-select" required {{ dis }}>
          <option value="">— select technician —</option>
          {% for tid, uname in (technicians or []) %}
            <option value="{{ tid }}"
              {% if (selected_tech_id and tid == selected_tech_id)
                    or (not selected_tech_id and selected_tech_username and (selected_tech_username|lower == (uname|lower))) %}selected{% endif %}>
              {{ uname }}
            </option>
          {% endfor %}
        </select>
        <input type="hidden" name="technician_name"
               value="{{ selected_tech_username or (IS_EDIT and wo.technician_name) or '' }}">
        <div class="form-text">
          This list includes only users with the <code>technician</code> role.
        </div>
      {% else %}
        <div class="form-control-plaintext">
          {{ selected_tech_username or (IS_EDIT and wo.technician_name) or '—' }}
        </div>
        <input type="hidden" name="technician_id" value="{{ selected_tech_id or '' }}">
        <input type="hidden" name="technician_name"
               value="{{ selected_tech_username or (IS_EDIT and wo.technician_name) or '' }}">
      {% endif %}
    </div>

    <div class="col-md-3">
      <label class="form-label">Job number(s) (comma separated)</label>

      {% set job_err = (errors and errors.get('job_numbers')) %}
      <input name="job_numbers"
             class="form-control {{ 'is-invalid' if job_err else '' }}"
             placeholder=""
             value="{{ (IS_EDIT and wo.job_numbers or wo.job_numbers or '')|upper }}"
             {{ ro }} {{ dis }}>

      {% if job_err %}
        <div class="invalid-feedback">{{ job_err }}</div>
      {% endif %}

      {% if not IS_EDIT %}
      <div class="form-text text-warning">
        Duplicate protection: if this job already has a Work Order,
        you'll be redirected to it instead of creating a duplicate.
      </div>
      {% endif %}
    </div>

    <div class="col-md-2">
      <label class="form-label">Job type</label>
      {% set jt = (IS_EDIT and wo.job_type or 'BASE') %}
      {% set IS_INS = (jt == 'INSURANCE') %}
      <select name="job_type" class="form-select" {{ dis }}>
        <option value="BASE" {{ 'selected' if jt=='BASE' else '' }}>BASE</option>
        <option value="INSURANCE" {{ 'selected' if jt=='INSURANCE' else '' }}>INSURANCE</option>
      </select>
    </div>

    <div class="col-md-2">
      <label class="form-label">Delivery fee ($)</label>
      <input id="deliveryFee" type="number" step="0.01" name="delivery_fee" class="form-control"
             value="{{ IS_EDIT and wo.delivery_fee is not none and ('%.2f'|format(wo.delivery_fee)) or '0.00' }}" {{ ro }} {{ dis }}>
    </div>

    <div class="col-md-2">
      <label class="form-label">Markup (%)</label>
      <input id="markupPercent" type="number" step="0.01" name="markup_percent" class="form-control"
             value="{{ IS_EDIT and wo.markup_percent is not none and ('%.2f'|format(wo.markup_percent)) or '0.00' }}" {{ ro }} {{ dis }}>
    </div>

    <div class="col-md-2">
      <label class="form-label">Status</label>
      {% set st = (IS_EDIT and wo.status or 'search_ordered') %}
      <select name="status" class="form-select" {{ dis }}>
        <option value="search_ordered" {{ 'selected' if st=='search_ordered' else '' }}>search_ordered</option>
        <option value="ordered" {{ 'selected' if st=='ordered' else '' }}>ordered</option>
        <option value="done" {{ 'selected' if st=='done' else '' }}>done</option>
      </select>
    </div>

    <div class="col-md-3" id="poWrap" style="{% if not IS_INS %}display:none{% endif %}">
      <label class="form-label">Customer PO # <span class="text-danger">*</span></label>
      <input name="customer_po"
             class="form-control"
             placeholder="PO#"
             value="{{ (IS_EDIT and wo.customer_po or '')|upper }}"
             {% if IS_INS %}required{% endif %}
             {{ ro }} {{ dis }}>
    </div>

  </div>

  <div id="unitsWrap" class="d-flex flex-column gap-4">
    {% for u in (units or []) %}
    {% set ui = loop.index0 %}
    <div class="card">
      <div class="card-header d-flex justify-content-between align-items-center">
        <strong>Appliance #{{ loop.index }}</strong>
        {% if not RO %}
          <button type="button" class="btn btn-sm btn-outline-danger del-unit">&times;</button>
        {% endif %}
      </div>

      <div class="card-body">
        <div class="row g-3 mb-3">
          <div class="col-md-4">
            <label class="form-label">Brand</label>
            <input name="units[{{ ui }}][brand]" class="form-control"
                   value="{{ (u.brand  or '')|upper }}" {{ ro }} {{ dis }}>
          </div>
          <div class="col-md-4">
            <label class="form-label">Model #</label>
            <input name="units[{{ ui }}][model]" class="form-control" maxlength="25"
                   value="{{ (u.model  or '')|upper }}" {{ ro }} {{ dis }}>
          </div>
          <div class="col-md-4">
            <label class="form-label">Serial #</label>
            <input name="units[{{ ui }}][serial]" class="form-control" maxlength="25"
                   value="{{ (u.serial or '')|upper }}" {{ ro }} {{ dis }}>
          </div>
        </div>

        <div class="table-responsive">
          <table class="table table-sm table-bordered align-middle unit-table">
            <thead>
              <tr>
                <th>Part #</th>
                <th>Alt PN#</th>
                <th>Part name</th>
                <th class="text-end col-qty">Qty</th>
                <th class="text-end col-money">Unit ($)</th>
                <th class="text-end col-money">Total ($)</th>
                <th class="col-wh">WH</th>
                <th class="col-inv">INV#</th>
                <th style="width:80px;" title="Backorder">B/O</th>

                <th class="ins-col" style="width:70px;">INS</th>
                <th class="col-narrow">Sup</th>
                <th class="ordered-col" style="width:70px;">Ord</th>
                <th style="width:140px;">Stock hint</th>
                <th class="col-issue">Issue?</th>
                <th style="width:60px;"></th>
              </tr>
            </thead>
            <tbody>
              {% for r in (u.rows or []) %}
              {% set ri = loop.index0 %}
              {% set issued_full = ((r.issued_qty or 0) >= (r.quantity or 0)) %}
              {% set rf = (r.ordered_flag if r.ordered_flag is defined else (r.ordered if r.ordered is defined else 0)) %}
              {% set is_ord = (rf in (True, 1, '1')) or
                               (r.status is defined and (r.status or '')|lower == 'ordered') or
                               (r.line_status is defined and (r.line_status or '')|lower == 'ordered') %}

              {# формируем css-классы строки #}
              {% set row_class = '' %}
              {% if issued_full %}
                {% set row_class = row_class + ' issued-row' %}
              {% elif is_ord %}
                {# если уже выдано полностью, НЕ помечаем как ordered, только зелёный #}
                {% set row_class = row_class + ' row-ordered' %}
              {% endif %}
              {% if r.backorder_flag %}
                {% set row_class = row_class + ' row-backorder' %}
              {% endif %}

              <tr class="{{ row_class|trim }}">
                <td>
                  <input class="form-control pn"
                         name="units[{{ ui }}][rows][{{ ri }}][part_number]"
                         value="{{ (r.part_number or '')|upper }}"
                         maxlength="80" {{ ro }} {{ dis }}>
                </td>
                <td>
                  <input class="form-control alt-pn"
                         name="units[{{ ui }}][rows][{{ ri }}][alt_numbers]"
                         value="{{ (r.alt_numbers or '')|upper }}"
                         {{ ro }} {{ dis }}>
                </td>
                <td>
                  <input class="form-control part-name"
                         name="units[{{ ui }}][rows][{{ ri }}][part_name]"
                         value="{{ r.part_name or '' }}"
                         maxlength="120" {{ ro }} {{ dis }}>
                </td>
                <td class="num">
                  <input class="form-control qty"
                         name="units[{{ ui }}][rows][{{ ri }}][quantity]"
                         type="number" min="0"
                         value="{{ r.quantity or 1 }}" {{ ro }} {{ dis }}>
                </td>
                <td class="num">
                  <input class="form-control unit-cost"
                         name="units[{{ ui }}][rows][{{ ri }}][unit_cost]"
                         type="number" step="0.01" min="0"
                         value="{{ r.unit_cost is not none and ('%.2f'|format(r.unit_cost)) or '0.00' }}"
                         {{ ro }} {{ dis }}>
                </td>
                <td class="num">
                  <span class="line-total ro-input" data-value="0.00">0.00</span>
                </td>
                <td>
                  <input class="form-control wh-input"
                         name="units[{{ ui }}][rows][{{ ri }}][warehouse]"
                         value="{{ (r.warehouse or r.unit_label or '')|upper }}"
                         maxlength="120" {{ ro }} {{ dis }}>
                </td>

                <td class="col-inv">
                  <input class="form-control inv-input"
                       name="units[{{ ui }}][rows][{{ ri }}][invoice_number]"
                       value="{{ (r.invoice_number or '')|upper }}"
                       data-wop-id="{{ r.id or '' }}"
                       maxlength="32"
                       placeholder="INV#"
                       {{ ro }} {{ dis }}>

                </td>


                <td class="text-center">
                  <div class="form-check d-flex justify-content-center m-0">
                    <input class="form-check-input" type="checkbox"
                           name="units[{{ ui }}][rows][{{ ri }}][backorder_flag]"
                           {% if r.backorder_flag %}checked{% endif %} {{ dis }}>
                  </div>
                </td>
                <td class="text-center ins-col">
                  <div class="form-check d-flex justify-content-center m-0">
                    <input class="form-check-input ins-check" type="checkbox"
                       name="units[{{ ui }}][rows][{{ ri }}][is_insurance_supplied]"
                       data-wop-id="{{ r.id or '' }}"
                       {% if r.is_insurance_supplied %}checked{% endif %} {{ dis }}>

                  </div>
                </td>
                <td>
                  <input class="form-control supplier-input"
                         name="units[{{ ui }}][rows][{{ ri }}][supplier]"
                         list="suppliers_datalist"
                         value="{{ (r.supplier or '')|upper }}"
                         {{ ro }} {{ dis }}>
                </td>
                <td class="text-center ordered-col">
                  <input type="hidden" class="ordered-val"
                         name="units[{{ ui }}][rows][{{ ri }}][ordered_flag]"
                         value="{{ 1 if is_ord else 0 }}">
                  <input type="checkbox" class="form-check-input ordered-check"
                         {% if is_ord %}checked{% endif %} {{ dis }}>
                </td>
                <td class="hint col-hint">—</td>
                <td class="text-center issue-cell">
                  {% if not RO %}
                    <div class="form-check d-flex justify-content-center m-0">
                      <input type="checkbox" class="form-check-input issue-check"
                       name="issue_ids" value="{{ r.id or '' }}"
                       data-wop-id="{{ r.id or '' }}"
                       {% if not r.id %}disabled title="Save WO first"{% endif %}
                       {% if issued_full %}disabled{% endif %}>

                    </div>
                  {% else %}
                    <span class="text-muted">—</span>
                  {% endif %}
                </td>
                <td class="text-center">
                  {% if not RO %}
                    <button type="button" class="btn btn-sm btn-outline-danger del-row">&times;</button>
                  {% endif %}
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

        <div class="d-flex flex-wrap justify-content-between align-items-start gap-2">
          {% if not RO %}
          <div class="d-flex flex-wrap gap-2">
            <button type="button"
                    class="btn btn-outline-secondary add-row">
              + Add part row
            </button>

            <button type="button"
                    class="btn btn-outline-primary btn-copy-appliance">
              Copy
            </button>
          </div>
          {% else %}
          <span></span>
          {% endif %}

          <div class="text-end ms-auto">
            <strong>Unit subtotal:</strong>
            <span class="unit-subtotal">0.00</span>
          </div>
        </div>

      </div>
    </div>
    {% endfor %}
  </div>

  {% if not RO %}
  <div class="my-3">
    <button type="button" class="btn btn-outline-primary" id="addUnit">+ Add appliance</button>
  </div>
  {% endif %}

  <div class="d-flex justify-content-between align-items-center my-2">
    <div></div>
    <div class="text-end"><strong>Grand total:</strong> <span id="grandTotal">0.00</span></div>
  </div>

  <datalist id="suppliers_datalist">
    {% for s in recent_suppliers or [] %}
      <option value="{{ s }}"></option>
    {% endfor %}
  </datalist>

  <div class="d-flex gap-2">
    {% if not RO %}
      <button type="submit" class="btn btn-primary">Save</button>

      <button type="button" id="selectAllInStockBtn" class="btn btn-outline-secondary">
        Select all in-stock
      </button>

      <button type="button" id="issueSelectedBtn" class="btn btn-success"
              {% if not IS_EDIT %}disabled title="Save WO first"{% endif %}>
        Issue selected
      </button>
    {% endif %}

    {% if IS_EDIT %}
      <a class="btn btn-outline-secondary" href="{{ url_for('inventory.wo_detail', wo_id=wo.id) }}">Back</a>
    {% else %}
      <a class="btn btn-outline-secondary" href="{{ url_for('inventory.wo_list') }}">Back</a>
    {% endif %}
  </div>
</form>

{% set issue_action = IS_EDIT and url_for('inventory.wo_issue_instock', wo_id=wo.id) or '#' %}
<form id="issueForm" method="post" action="{{ issue_action }}">
  <input type="hidden" name="wo_id" value="{{ IS_EDIT and wo.id or '' }}">
  <input type="hidden" name="part_ids" id="issue_part_ids">
  <input type="hidden" name="set_status" id="issue_set_status" value="">
  <!-- НОВОЕ: какие строки помечены INS прямо сейчас в форме -->
  <input type="hidden" name="ins_ids" id="issue_ins_ids">
</form>

{% endblock %}

{% block extra_js %}
<script>
(function(){
  const sel  = document.querySelector('select[name="technician_id"]');
  const hidN = document.querySelector('input[name="technician_name"]');
  if (sel && hidN) {
    const sync = () => {
      const opt = sel.options[sel.selectedIndex];
      hidN.value = opt ? (opt.text || '').trim() : '';
    };
    sel.addEventListener('change', sync);
    sync();
  }
})();
</script>

{# === NEW: авто-UPPERCASE на фронте для нужных полей === #}
<script>
(function(){
  const form = document.getElementById('woForm');
  if (!form) return;

    const upperSelectors = [
    'input[name="job_numbers"]',
    'input[name$="[brand]"]',
    'input[name$="[model]"]',
    'input[name$="[serial]"]',
    '.pn',
    '.alt-pn',
    '.part-name',      // ✅ P4 ADD THIS
    '.wh-input',
    '.supplier-input'
  ];


  function shouldUpper(el){
    return upperSelectors.some(sel => el.matches(sel));
  }

  form.addEventListener('input', (e) => {
    const el = e.target;
    if (!(el instanceof HTMLInputElement)) return;
    if (!shouldUpper(el)) return;

    const oldVal = el.value;
    const upper  = oldVal.toUpperCase();
    if (oldVal === upper) return;

    const start = el.selectionStart;
    const end   = el.selectionEnd;

    el.value = upper;

    if (start != null && end != null) {
      el.setSelectionRange(start, end);
    }
  });
})();
</script>

<script>
(function(){
  // STOCK API
  const API_STOCK = "{{ url_for('inventory.api_stock_hint') }}";
  const API_DUP   = "{{ url_for('inventory.api_job_duplicate_check') }}";
  const IS_EDIT   = {{ 'true' if IS_EDIT else 'false' }};
  const IS_RO     = {{ 'true' if RO else 'false' }};

  const form         = document.getElementById('woForm');
  const unitsWrap    = document.getElementById('unitsWrap');

    // P3) Tooltip: show full value on hover for Part# and Part name
  unitsWrap?.addEventListener('mouseover', (e)=>{
    const inp = e.target.closest('input.part-name, input.pn');
    if (!inp) return;
    const v = (inp.value || '').trim();
    if (v) inp.title = v;
  });


  const grandTotalEl = document.getElementById('grandTotal');
  const deliveryEl   = document.getElementById('deliveryFee');
  const markupEl     = document.getElementById('markupPercent');
  const issueBtn     = document.getElementById('issueSelectedBtn');
  const selectAllBtn = document.getElementById('selectAllInStockBtn');
  const statusSel    = document.querySelector('select[name="status"]');
  const addUnitBtn   = document.getElementById('addUnit');
  const jobTypeSel   = document.querySelector('select[name="job_type"]');

  // --- helpers для INS-логики ---
  function isInsuranceJob(){
    return jobTypeSel && jobTypeSel.value === 'INSURANCE';
  }

  function isRowInsuranceSupplied(tr){
    if (!tr) return false;
    const cb = tr.querySelector('.ins-check');
    return !!(cb && cb.checked);
  }


  // --- UNSAVED CHANGES GUARD ---
  let isDirty = false;
  let isSubmitting = false;

  function handleBeforeUnload(e) {
    if (!isDirty || isSubmitting || IS_RO) {
      return;
    }
    e.preventDefault();
    e.returnValue = '';
    return '';
  }

  function markDirty() {
    if (IS_RO) return;
    if (!isDirty) {
      isDirty = true;
      window.addEventListener('beforeunload', handleBeforeUnload);
    }
  }

  if (form && !IS_RO) {
    form.addEventListener('input', markDirty);
    form.addEventListener('change', markDirty);
  }
  // --- /UNSAVED CHANGES GUARD ---

  // we'll need current WO id for duplicate logic
  const currentWOInput = form.querySelector('input[name="wo_id"]');
  const CURRENT_WO_ID  = currentWOInput ? String(currentWOInput.value || '').trim() : '';

  function updateSupplierRequired(){
    const must = statusSel && statusSel.value === 'ordered';
    document.querySelectorAll('.supplier-input').forEach(inp=>{
      if(must) inp.setAttribute('required','required');
      else     inp.removeAttribute('required');
    });
  }
  statusSel?.addEventListener('change', ()=>{
    updateSupplierRequired();
    // при ручной смене статуса тоже проверим автологику
    reevaluateWOStatusFromOrd();
  });

  function toggleOrderedCols(){
    document.querySelectorAll('.unit-table .ordered-col').forEach(cell=>{
      cell.style.display = 'table-cell';
      const cb  = cell.querySelector('.ordered-check');
      if (cb && !IS_RO) {
        cb.disabled = false;
      }
    });
  }
  statusSel?.addEventListener('change', toggleOrderedCols);

  // === NEW: показ/скрытие INS-колонки в зависимости от Job type
  function updateInsColumns(){
    const show = jobTypeSel && jobTypeSel.value === 'INSURANCE';
    document.querySelectorAll('.ins-col').forEach(el=>{
      el.style.display = show ? 'table-cell' : 'none';
    });
  }
  jobTypeSel?.addEventListener('change', updateInsColumns);

    function updatePOField(){
    const wrap = document.getElementById('poWrap');
    const inp  = document.querySelector('input[name="customer_po"]');
    const show = jobTypeSel && jobTypeSel.value === 'INSURANCE';

    if (wrap) wrap.style.display = show ? '' : 'none';
    if (inp){
      inp.required = show;
      if (!show) inp.value = '';
    }
  }
  jobTypeSel?.addEventListener('change', updatePOField);


  // === NEW: есть ли хотя бы один отмеченный Ord
  function hasAnyOrderedChecked(){
    return Array.from(document.querySelectorAll('.unit-table .ordered-check'))
      .some(cb => cb.checked);
  }

  // === NEW: авто-установка статуса по чекбоксам Ord
  function reevaluateWOStatusFromOrd(){
    if (!statusSel) return;
    const cur = statusSel.value;
    if (cur === 'done') return; // done не трогаем

    if (hasAnyOrderedChecked()){
      if (cur !== 'ordered'){
        statusSel.value = 'ordered';
        toggleOrderedCols();
        updateSupplierRequired();
      }
    } else {
      if (cur !== 'search_ordered'){
        statusSel.value = 'search_ordered';
        updateSupplierRequired();
      }
    }
  }

  // helper: sync ordered_flag hidden inputs before final submit
  function syncOrderedFlagsBeforeSubmit(){
    document.querySelectorAll('.unit-table .ordered-col').forEach(cell=>{
      const cb  = cell.querySelector('.ordered-check');
      const hid = cell.querySelector('.ordered-val');
      if (hid) {
        hid.value = (cb && cb.checked) ? '1' : '0';
      }
    });
  }

  // DUPLICATE CHECK LOGIC ...
  async function handleDuplicateCheckBeforeSubmit(){
    if (IS_EDIT) return true;

    const jobField = form.querySelector('[name="job_numbers"]');
    if (!jobField) return true;

    const rawJobs = (jobField.value || '').trim();
    if (!rawJobs) return true;

    const params = new URLSearchParams();
    params.set("job_numbers", rawJobs);

    let resp;
    try {
      resp = await fetch(API_DUP + "?" + params.toString(), {
        method: "GET",
        credentials: "same-origin",
        headers: { "Accept": "application/json" }
      });
    } catch (err) {
      return true;
    }

    if (!resp.ok) return true;

    const data = await resp.json();
    if (!data.duplicate) return true;

    if (CURRENT_WO_ID && String(data.existing_id || '') === CURRENT_WO_ID) {
      return true;
    }

    const msg = (
      "Work Order #" + data.existing_id +
      " already exists for this job (" + (data.existing_jobs || "") + ").\n\n" +
      "Open existing instead?"
    );

    const goExisting = window.confirm(msg);
    if (goExisting) {
      window.location.href =
        "{{ url_for('inventory.wo_detail', wo_id=0) }}".replace("0", data.existing_id);
      return false;
    } else {
      return false;
    }
  }

  // final guarded submit handler
  if (form) {
    form.addEventListener('submit', async (e)=>{
      e.preventDefault();

      const okToSubmit = await handleDuplicateCheckBeforeSubmit();
      if (!okToSubmit) return;

      // sync ordered_flag checkboxes into hidden vals
      syncOrderedFlagsBeforeSubmit();

      if (!IS_RO) {
        isSubmitting = true;
        isDirty = false;
        window.removeEventListener('beforeunload', handleBeforeUnload);
      }

      form.submit();
    });
  }

  const toMoney = (n)=> (Math.round((Number(n||0)+Number.EPSILON)*100)/100).toFixed(2);

  function recomputeUnitSubtotal(card){
  const markup   = parseFloat(markupEl?.value || '0') || 0;
  const delivery = parseFloat(deliveryEl?.value || '0') || 0;
  let unitSum = 0;

  card.querySelectorAll('tbody tr').forEach(tr => {
    const q        = parseFloat(tr.querySelector('.qty')?.value || '0') || 0;
    const baseCost = parseFloat(tr.querySelector('.unit-cost')?.value || '0') || 0;

    // ✅ Delivery fee ОДИН РАЗ на позицию:
    // raw = qty * unit + delivery
    // markup накручиваем на всю сумму строки
    const rawLine = (q * baseCost) + delivery;
    const line    = rawLine * (1 + markup / 100);

    const cell = tr.querySelector('.line-total');
    if (cell){
      const v = toMoney(line);
      cell.textContent = v;
      cell.dataset.value = v;
    }
    unitSum += line;
  });

  const us = card.querySelector('.unit-subtotal');
  if (us) us.textContent = toMoney(unitSum);

  recomputeGrandTotal();
}



  function recomputeGrandTotal(){
    let g = 0;
    document.querySelectorAll('.unit-subtotal').forEach(x=>{
      g += parseFloat(x.textContent||'0')||0;
    });
    grandTotalEl.textContent = toMoney(g);
  }

  ['input','change'].forEach(ev=>{
    deliveryEl?.addEventListener(ev, ()=>{
      document.querySelectorAll('#unitsWrap .card').forEach(recomputeUnitSubtotal);
    });
    markupEl?.addEventListener(ev, ()=>{
      document.querySelectorAll('#unitsWrap .card').forEach(recomputeUnitSubtotal);
    });
  });

  function setIssueEnabled(tr, enabled){
    const cb = tr.querySelector('.issue-check');
    if (!cb) return;

    // если уже выдано — всегда запрещено
    if (tr.classList.contains('issued-row')){
      cb.checked = false;
      cb.disabled = true;
      cb.setAttribute('disabled','disabled');
      return;
    }

    // INS логика
    const isINSJob =
      jobTypeSel &&
      jobTypeSel.value === 'INSURANCE';

    const insCheckbox = tr.querySelector('.ins-check');
    const isINSLine = !!(insCheckbox && insCheckbox.checked);

    // ✅ РАЗРЕШАЕМ issue если:
    // - есть STOCK
    // - ИЛИ INSURANCE + INS
    const allowIssue = enabled || (isINSJob && isINSLine);

    if (allowIssue){
      cb.disabled = !IS_EDIT;
      cb.removeAttribute('disabled');
    } else {
      cb.checked = false;
      cb.disabled = true;
      cb.setAttribute('disabled','disabled');
    }
  }


  // Рекурсивно выдёргиваем количество из любого уровня вложенности (здесь не используется, но пусть будет)
  function extractQtySmart(root){
    const keys = [
      'qty_available','available_qty','available','on_hand','onhand',
      'stock','in_stock','qty','count','quantity'
    ];

    let best = 0;

    function dfs(node, depth){
      if (!node || depth > 5) return;

      if (Array.isArray(node)){
        node.forEach(x => dfs(x, depth + 1));
        return;
      }
      if (typeof node === 'object'){
        for (const [k, v] of Object.entries(node)){
          const key = String(k || '').toLowerCase();
          if (keys.includes(key) && v !== null && v !== undefined && !isNaN(Number(v))){
            const n = Number(v);
            if (n > best) best = n;
          }
          if (v && typeof v === 'object'){
            dfs(v, depth + 1);
          }
        }
      }
    }

    dfs(root, 0);
    return best;
  }

  // Рекурсивно ищем первую непустую строку по списку вариантов ключей
  function pickDeep(root, variants){
    let result;

    function dfs(node, depth){
      if (result !== undefined || !node || depth > 5) return;

      if (Array.isArray(node)){
        node.forEach(x => dfs(x, depth + 1));
        return;
      }
      if (typeof node === 'object'){
        for (const [k, v] of Object.entries(node)){
          const key = String(k || '').toLowerCase();
          if (variants.includes(key) && v !== null && v !== undefined && String(v).trim() !== ''){
            result = v;
            return;
          }
          if (v && typeof v === 'object'){
            dfs(v, depth + 1);
            if (result !== undefined) return;
          }
        }
      }
    }

    dfs(root, 0);
    return result;
  }

  function fetchHint(tr){
    const pnInput  = tr.querySelector('.pn');
    const altInput = tr.querySelector('.alt-pn');   // Alt PN
    const qtyInput = tr.querySelector('.qty');
    const whInput  = tr.querySelector('.wh-input');
    const nameInp  = tr.querySelector('.part-name');
    const costInp  = tr.querySelector('.unit-cost');
    const hintEl   = tr.querySelector('.hint');

    const pnMain = (pnInput?.value || '').trim().toUpperCase();
    const pnAlt  = (altInput?.value || '').trim().toUpperCase();
    const pn     = pnMain || pnAlt;   // если Part # пустой – используем Alt PN

    const qty = parseInt(qtyInput?.value || '0', 10) || 0;

    if (!pn || qty <= 0) {
      if (hintEl) hintEl.textContent = '—';
      setIssueEnabled(tr, false);
      return;
    }

    // ВАЖНО: не фильтруем по WH из Work Order.
    // В колонке WH у тебя "B2", а реальная локация в инвентаре "MAR/REL/...".
    // Поэтому сюда WH НЕ отправляем, чтобы не терять наличие.
    const url = API_STOCK
      + '?pn=' + encodeURIComponent(pn)
      + '&qty=' + qty;

    fetch(url)
      .then(r => r.ok ? r.json() : Promise.reject())
      .then(j => {
        const flat = Object.assign({}, j, j.data || {}, j.result || {});

        const qa = Number(
          flat.qty_available ||
          flat.available_qty ||
          flat.available ||
          flat.qty ||
          flat.quantity ||
          0
        ) || 0;

        const okFlag  = !!flat.ok;
        let isStock   = okFlag && qa > 0;

        const label = isStock ? 'STOCK' : 'WAIT';
        if (hintEl) {
          hintEl.textContent = label + '/' + qa;
        }

        setIssueEnabled(tr, isStock);

        const nameGuess =
          flat.part_name ||
          flat.name ||
          flat.title ||
          flat.description;

        if (nameInp && (!nameInp.value || !nameInp.value.trim()) && nameGuess){
          nameInp.value = String(nameGuess).trim().slice(0,120);
        }

        const curCost = parseFloat(costInp?.value || '0') || 0;
        const costGuess =
          flat.unit_cost ||
          flat.price ||
          flat.unit_price ||
          flat.cost ||
          flat.last_price ||
          flat.avg_cost;

        if (costInp &&
            (curCost === 0 || !costInp.value) &&
            costGuess !== undefined &&
            !isNaN(Number(costGuess))) {

          const newCost = (
            Math.round((Number(costGuess)+Number.EPSILON)*100)/100
          ).toFixed(2);

          costInp.value = newCost;
          const card = tr.closest('.card');
          if (card) {
            recomputeUnitSubtotal(card);
          }
        }

        const whGuess =
          flat.warehouse ||
          flat.location ||
          flat.wh;

        if (whInput && (!whInput.value || !whInput.value.trim()) && whGuess){
          whInput.value = String(whGuess).trim().slice(0,120).toUpperCase();
        }
      })
      .catch(() => {
        if (hintEl) hintEl.textContent = '—';
        setIssueEnabled(tr, false);
      });
  }

  function rowTemplate(ui, ri){
    const ro = IS_RO ? 'disabled readonly' : '';
    const thebo = IS_RO ? 'disabled' : '';
    return `
<tr>
  <td><input class="form-control pn" name="units[${ui}][rows][${ri}][part_number]" maxlength="80" ${ro}></td>
  <td><input class="form-control alt-pn" name="units[${ui}][rows][${ri}][alt_numbers]" ${ro}></td>
  <td><input class="form-control part-name" name="units[${ui}][rows][${ri}][part_name]" maxlength="120" ${ro}></td>
  <td class="num"><input class="form-control qty" name="units[${ui}][rows][${ri}][quantity]" type="number" min="0" value="1" ${ro}></td>
  <td class="num"><input class="form-control unit-cost" name="units[${ui}][rows][${ri}][unit_cost]" type="number" step="0.01" min="0" value="0.00" ${ro}></td>
  <td class="num"><span class="line-total ro-input" data-value="0.00">0.00</span></td>
  <td><input class="form-control wh-input" name="units[${ui}][rows][${ri}][warehouse]" maxlength="120" ${ro}></td>
  <td><input class="form-control inv-input" name="units[${ui}][rows][${ri}][invoice_number]" maxlength="32" placeholder="INV#" ${ro}></td>

  <td class="text-center">
    <div class="form-check d-flex justify-content-center m-0">
      <input class="form-check-input" type="checkbox"
             name="units[${ui}][rows][${ri}][backorder_flag]" ${thebo}>
    </div>
  </td>
  <td class="text-center ins-col">
    <div class="form-check d-flex justify-content-center m-0">
      <input class="form-check-input ins-check" type="checkbox"
             name="units[${ui}][rows][${ri}][is_insurance_supplied]" ${thebo}>
    </div>
  </td>
  <td><input class="form-control supplier-input" name="units[${ui}][rows][${ri}][supplier]" list="suppliers_datalist" ${ro}></td>
  <td class="text-center ordered-col">
    <input type="hidden" class="ordered-val" name="units[${ui}][rows][${ri}][ordered_flag]" value="0">
    <input type="checkbox" class="form-check-input ordered-check" ${thebo}>
  </td>
  <td class="hint">—</td>
  <td class="text-center issue-cell">
    <div class="form-check d-flex justify-content-center m-0">
      <input type="checkbox" class="form-check-input issue-check"
             name="issue_ids" value="${ui}_${ri}" ${IS_EDIT?'':'disabled'}>
    </div>
  </td>
  <td class="text-center">
    ${IS_RO?'':'<button type="button" class="btn btn-sm btn-outline-danger del-row">&times;</button>'}
  </td>
</tr>`;
  }

  function unitTemplate(ui){
    return `
<div class="card">
  <div class="card-header d-flex justify-content-between align-items-center">
    <strong>Appliance #${ui+1}</strong>
    ${IS_RO ? '' : '<button type="button" class="btn btn-sm btn-outline-danger del-unit">&times;</button>'}
  </div>
  <div class="card-body">
    <div class="row g-3 mb-3">
      <div class="col-md-4">
        <label class="form-label">Brand</label>
        <input name="units[${ui}][brand]" class="form-control" ${IS_RO?'disabled readonly':''}>
      </div>
      <div class="col-md-4">
        <label class="form-label">Model #</label>
        <input name="units[${ui}][model]" class="form-control" maxlength="25" ${IS_RO?'disabled readonly':''}>
      </div>
      <div class="col-md-4">
        <label class="form-label">Serial #</label>
        <input name="units[${ui}][serial]" class="form-control" maxlength="25" ${IS_RO?'disabled readonly':''}>
      </div>
    </div>

    <div class="table-responsive">
      <table class="table table-sm table-bordered align-middle unit-table">
        <thead>
          <tr>
            <th>Part #</th>
            <th>Alt PN#</th>
            <th>Part name</th>
            <th class="text-end col-qty">Qty</th>
            <th class="text-end col-money">Unit ($)</th>
            <th class="text-end col-money">Total ($)</th>
            <th class="col-wh">WH</th>
            <th class="col-inv">INV#</th>
            <th style="width:80px;" title="Backorder">B/O</th>
            <th class="ins-col" style="width:70px;">INS</th>
            <th class="col-narrow">Sup</th>
            <th class="ordered-col" style="width:70px;">Ord</th>
            <th style="width:140px;">Stock hint</th>
            <th class="col-issue">Issue?</th>
            <th style="width:60px;"></th>
          </tr>
        </thead>

        <tbody>
          ${rowTemplate(ui, 0)}
        </tbody>
      </table>
    </div>

    <div class="d-flex flex-wrap justify-content-between align-items-start gap-2">
      ${IS_RO ? '<span></span>' : `
      <div class="d-flex flex-wrap gap-2">
        <button type="button"
                class="btn btn-outline-secondary add-row">
          + Add part row
        </button>

        <button type="button"
                class="btn btn-outline-primary btn-copy-appliance">
          Copy
        </button>
      </div>`}
      <div class="text-end ms-auto">
        <strong>Unit subtotal:</strong>
        <span class="unit-subtotal">0.00</span>
      </div>
    </div>
  </div>
</div>`;
  }

  unitsWrap.addEventListener('input', (e)=>{
    const tr=e.target.closest('tr');
    const card=e.target.closest('.card');
    if(!card) return;

    if(tr && (e.target.classList.contains('qty')||e.target.classList.contains('unit-cost'))){
      recomputeUnitSubtotal(card);
    }
    if(tr && (
      e.target.classList.contains('pn') ||
      e.target.classList.contains('alt-pn') ||
      e.target.classList.contains('qty') ||
      e.target.classList.contains('wh-input')
    )){
      fetchHint(tr);
    }
  });
       // Когда переключаем INS или ORD на строке – пересчитываем доступность и статус WO
  unitsWrap.addEventListener('change', (e)=>{
    const target = e.target;

    // --- INS чекбокс ---
    if (target.classList.contains('ins-check')) {
      const tr = target.closest('tr');
      if (!tr) return;

      const raw    = (tr.querySelector('.hint')?.textContent || '').trim().toUpperCase();
      const status = raw.split('/')[0];
      const isStock = (status === 'STOCK');

      // INS-строка в INSURANCE-job тоже может быть доступной (эта логика уже есть в selectAll/issueBtn),
      // здесь просто обновляем кнопку Issue.
      setIssueEnabled(tr, isStock);
    }

    // --- ORD чекбокс ---
    if (target.classList.contains('ordered-check')) {
      const cell = target.closest('.ordered-col');
      const hid  = cell && cell.querySelector('.ordered-val');

      // сразу синхронизируем скрытое поле ordered_flag
      if (hid) {
        hid.value = target.checked ? '1' : '0';
      }

      // пересчёт статуса WO и required на Sup
      reevaluateWOStatusFromOrd();
      updateSupplierRequired();
    }
  });



  unitsWrap.addEventListener('click', (e)=>{
    const btn = e.target.closest('button');
    if(!btn) return;

    // ---- УДАЛИТЬ АППЛАЙЕНС ----
    if(btn.classList.contains('del-unit')){
      const card = btn.closest('card');
      const cardReal = btn.closest('.card');
      const targetCard = cardReal || card;
      if (targetCard) {
        targetCard.remove();

        // Перенумеровка Appliance #1, #2, ...
        document.querySelectorAll('#unitsWrap .card').forEach((c, idx)=>{
          const strong=c.querySelector('.card-header strong');
          if(strong) strong.textContent = `Appliance #${idx+1}`;
        });

        recomputeGrandTotal();
      }
      return;
    }

    // ---- ДОБАВИТЬ СТРОКУ ----
    if(btn.classList.contains('add-row')){
      const card  = btn.closest('.card'); if(!card) return;
      const tbody = card.querySelector('tbody'); if(!tbody) return;
      const ui    = [...document.querySelectorAll('#unitsWrap .card')].indexOf(card);
      const ri    = tbody.querySelectorAll('tr').length;

      tbody.insertAdjacentHTML('beforeend', rowTemplate(ui, ri));
      updateSupplierRequired();
      recomputeUnitSubtotal(card);
      fetchHint(tbody.lastElementChild);
      toggleOrderedCols();
      updateInsColumns();
      updatePOField();

      // NEW: после добавления строки – пересчёт статуса
      reevaluateWOStatusFromOrd();
      return;
    }

    // ---- УДАЛИТЬ СТРОКУ ----
    if(btn.classList.contains('del-row')){
      const tr   = btn.closest('tr');
      const card = btn.closest('.card') || (tr && tr.closest('.card')) || null;
      if (tr) {
        tr.remove();
      }
      if (card) {
        recomputeUnitSubtotal(card);
      }
      // NEW: пересчёт после удаления строки
      reevaluateWOStatusFromOrd();
      return;
    }
  });

  addUnitBtn?.addEventListener('click', ()=>{
    const ui = document.querySelectorAll('#unitsWrap .card').length;
    unitsWrap.insertAdjacentHTML('beforeend', unitTemplate(ui));
    const card = unitsWrap.lastElementChild;
    updateSupplierRequired();
    recomputeUnitSubtotal(card);
    toggleOrderedCols();
    updateInsColumns();
    // NEW: пересчёт после добавления юнита
    reevaluateWOStatusFromOrd();
  });

  selectAllBtn?.addEventListener('click', ()=>{
    const rows = [...document.querySelectorAll('#unitsWrap tbody tr')].filter(tr=>{
      if (tr.classList.contains('issued-row')) return false;

      const cb = tr.querySelector('.issue-check');
      if (!cb || cb.disabled) return false;

      const raw    = (tr.querySelector('.hint')?.textContent||'').trim().toUpperCase();
      const status = raw.split('/')[0];
      const isStock = (status === 'STOCK');

      // INS-строка в INSURANCE-job тоже считается "доступной"
      const isInsEligible = isInsuranceJob() && isRowInsuranceSupplied(tr);

      return isStock || isInsEligible;
    });

    const needCheck = rows.some(tr => !tr.querySelector('.issue-check').checked);
    rows.forEach(tr=>{
      tr.querySelector('.issue-check').checked = needCheck;
    });
  });

  issueBtn?.addEventListener('click', ()=>{
  const selected    = [];
  const insSelected = [];
  const isINSJob    = isInsuranceJob();

  // 1) collect ONLY numeric WorkOrderPart IDs
  document.querySelectorAll('#unitsWrap tbody tr').forEach((tr)=>{
    if (tr.classList.contains('issued-row')) return;

    const cb = tr.querySelector('.issue-check');
    if (!cb || !cb.checked) return;

    const wopId = (cb.getAttribute('data-wop-id') || cb.value || '').trim();
    if (!/^\d+$/.test(wopId)) return; // <-- critical: skip non-saved rows

    const raw    = (tr.querySelector('.hint')?.textContent || '').trim().toUpperCase();
    const status = raw.split('/')[0];
    const insLine = isRowInsuranceSupplied(tr);

    // allow only STOCK or (INS job + INS line)
    if (status === 'STOCK' || (isINSJob && insLine)) {
      selected.push(wopId);
      if (isINSJob && insLine) insSelected.push(wopId);
    }
  });

  if (selected.length === 0) {
    alert(isINSJob
      ? 'Select at least one in-stock or INS part (saved rows only).'
      : 'Select at least one in-stock part (saved rows only).'
    );
    return;
  }

  // 2) require INV# for selected rows
  let firstEmpty = null;
  document.querySelectorAll('#unitsWrap tbody tr').forEach((tr)=>{
    if (tr.classList.contains('issued-row')) return;

    const cb = tr.querySelector('.issue-check');
    if (!cb) return;

    const wopId = (cb.getAttribute('data-wop-id') || cb.value || '').trim();
    if (!selected.includes(wopId)) return;

    const inv = (tr.querySelector('.inv-input')?.value || '').trim();
    if (!inv && !firstEmpty) firstEmpty = tr;
  });

  if (firstEmpty){
    alert('Invoice # is required for all selected lines before issuing.');
    const inp = firstEmpty.querySelector('.inv-input');
    if (inp){
      inp.scrollIntoView({ behavior: 'smooth', block: 'center' });
      inp.focus();
      inp.classList.add('inv-missing');
      setTimeout(() => inp.classList.remove('inv-missing'), 2000);
    }
    return;
  }
    // --- FIX: copy INV# of selected lines into issueForm ---
  const issueFormEl = document.getElementById('issueForm');
  if (issueFormEl) {
    // remove old injected inv_*
    issueFormEl.querySelectorAll('input[data-invcopy="1"]').forEach(x => x.remove());

    document.querySelectorAll('#unitsWrap tbody tr').forEach((tr)=>{
      if (tr.classList.contains('issued-row')) return;

      const cb = tr.querySelector('.issue-check');
      if (!cb) return;

      const wopId = (cb.getAttribute('data-wop-id') || cb.value || '').trim();
      if (!selected.includes(wopId)) return;

      let invVal = (tr.querySelector('.inv-input')?.value || '').trim().toUpperCase();
      invVal = invVal.replace(/\s+/g, ''); // убираем пробелы внутри


      const h = document.createElement('input');
      h.type = 'hidden';
      h.name = `inv_${wopId}`;
      h.value = invVal;
      h.setAttribute('data-invcopy', '1');
      issueFormEl.appendChild(h);
    });
  }
  // --- /FIX ---


  // 3) submit
  if (statusSel) statusSel.value = 'done';

  document.getElementById('issue_set_status').value = 'done';
  document.getElementById('issue_part_ids').value  = selected.join(',');
  document.getElementById('issue_ins_ids').value   = insSelected.join(',');
  document.getElementById('issueForm').submit();
});





  // initial calc / hints
  document.querySelectorAll('#unitsWrap .card').forEach(recomputeUnitSubtotal);
  document.querySelectorAll('#unitsWrap tbody tr').forEach(fetchHint);
  updateSupplierRequired();
  toggleOrderedCols();
  updateInsColumns();
  // NEW: первичный пересчёт статуса по уже отмеченным Ord
  reevaluateWOStatusFromOrd();
})();
</script>

<script>
function wccrToast(msg) {
  const t = document.createElement('div');
  t.textContent = msg;
  Object.assign(t.style, {
    position: 'fixed',
    bottom: '20px',
    right: '20px',
    background: '#0d6efd',
    color: '#fff',
    padding: '6px 12px',
    borderRadius: '8px',
    fontSize: '.85rem',
    boxShadow: '0 2px 8px rgba(0,0,0,.3)',
    zIndex: 9999
  });
  document.body.appendChild(t);
  setTimeout(() => t.remove(), 2000);
}

(function(){
  const btnWO = document.getElementById('btnCopyWO');
  if (!btnWO) return;

  btnWO.addEventListener('click', async () => {
    const techInput = document.querySelector('input[name="technician_name"]');
    const jobsInput = document.querySelector('input[name="job_numbers"]');

    const techVal = (techInput?.value || '').trim();
    const jobsVal = (jobsInput?.value || '').trim();

    const jobsFlat = jobsVal
      .replace(/[,;]/g,' ')
      .replace(/\s+/g,' ')
      .trim();

    const finalText = `${techVal} ${jobsFlat}`.trim();
    if (!finalText) return;

    try {
      await navigator.clipboard.writeText(finalText);
    } catch (e) {
      const ta = document.createElement('textarea');
      ta.value = finalText;
      document.body.appendChild(ta);
      ta.select();
      document.execCommand('copy');
      ta.remove();
    }

    wccrToast('Work order info copied');
  });
})();
</script>

<script>
(function(){
  const unitsWrap = document.getElementById('unitsWrap');
  if (!unitsWrap) return;

  unitsWrap.addEventListener('click', async (e) => {
    const btn = e.target.closest('.btn-copy-appliance');
    if (!btn) return;

    const card = btn.closest('.card');
    if (!card) return;

    const rows = card.querySelectorAll('tbody tr');
    let lines = [];

    rows.forEach(tr => {
      const pn   = tr.querySelector('.pn')?.value?.trim();
      const name = tr.querySelector('.part-name')?.value?.trim();
      const qty  = tr.querySelector('.qty')?.value?.trim();

      const totalSpan = tr.querySelector('.line-total');
      const totalValRaw = totalSpan
        ? (totalSpan.getAttribute('data-value') || totalSpan.textContent || '').trim()
        : '';

      if (pn || name) {
        const q        = qty || '1';
        const totalVal = totalValRaw || '0.00';
        lines.push(`${pn || ''} ${name || ''} x${q} $${totalVal}`.trim());
      }
    });

    const finalBlock = lines.join('\n');
    if (!finalBlock) return;

    try {
      await navigator.clipboard.writeText(finalBlock);
    } catch (e2) {
      const ta = document.createElement('textarea');
      ta.value = finalBlock;
      document.body.appendChild(ta);
      ta.select();
      document.execCommand('copy');
      ta.remove();
    }

    wccrToast('Appliance parts copied');
  });
})();
</script>
{% endblock %}
