{% extends "base.html" %}
{% block content %}
{% set RO = readonly or False %}
{% set dis = 'disabled' if RO else '' %}
{% set ro  = 'readonly' if RO else '' %}
{% set IS_EDIT = wo is not none %}

<style>
  .col-narrow{width:90px}
  .col-money{width:90px;text-align:right}
  .col-qty{width:64px;text-align:right}
  .col-issue{width:70px;text-align:center}
  .num{text-align:right;font-variant-numeric:tabular-nums}
  .wo-form .unit-table thead th{position:static!important;pointer-events:none;}
  .wo-form .unit-table td.issue-cell{position:relative;}
  .wo-form .unit-table .issue-check{position:relative; z-index:3; pointer-events:auto!important; opacity:1!important; cursor:pointer;}
  .wo-form .unit-table td.issue-cell, .wo-form .unit-table td.issue-cell *{ pointer-events:auto!important; }
</style>

<h3>{{ RO and 'View' or (wo and 'Edit' or 'New') }} Work Order (multi-appliance)</h3>

<form method="post" action="{{ url_for('inventory.wo_save') }}" id="woForm" class="wo-form">
  {% if IS_EDIT %}<input type="hidden" name="wo_id" value="{{ wo.id }}">{% endif %}

  <div class="row g-3 mb-3">
    <div class="col-md-3">
      <label class="form-label">Technician</label>
      <input id="technicianInput" name="technician_name" class="form-control" required list="technicianList"
             value="{{ wo.technician_name if IS_EDIT else '' }}" {{ ro }} {{ dis }}>
      <datalist id="technicianList"></datalist>
    </div>
    <div class="col-md-3">
      <label class="form-label">Job number(s) (comma separated)</label>
      <input name="job_numbers" class="form-control" placeholder="98356, 98256"
             value="{{ wo.job_numbers if IS_EDIT else '' }}" {{ ro }} {{ dis }}>
    </div>
    <div class="col-md-2">
      <label class="form-label">Job type</label>
      {% set jt = (wo.job_type if IS_EDIT else 'BASE') %}
      <select name="job_type" class="form-select" {{ dis }}>
        <option value="BASE" {{ 'selected' if jt=='BASE' else '' }}>BASE</option>
        <option value="INSURANCE" {{ 'selected' if jt=='INSURANCE' else '' }}>INSURANCE</option>
      </select>
    </div>
    <div class="col-md-2">
      <label class="form-label">Delivery fee ($)</label>
      <input id="deliveryFee" type="number" step="0.01" name="delivery_fee" class="form-control"
             value="{{ '%.2f'|format(wo.delivery_fee) if IS_EDIT and wo.delivery_fee is not none else '0.00' }}" {{ ro }} {{ dis }}>
    </div>
    <div class="col-md-2">
      <label class="form-label">Markup (%)</label>
      <input id="markupPercent" type="number" step="0.01" name="markup_percent" class="form-control"
             value="{{ '%.2f'|format(wo.markup_percent) if IS_EDIT and wo.markup_percent is not none else '0.00' }}" {{ ro }} {{ dis }}>
    </div>
    <div class="col-md-2">
      <label class="form-label">Status</label>
      {% set st = (wo.status if IS_EDIT else 'search_ordered') %}
      <select name="status" class="form-select" {{ dis }}>
        <option value="search_ordered" {{ 'selected' if st=='search_ordered' else '' }}>search_ordered</option>
        <option value="ordered" {{ 'selected' if st=='ordered' else '' }}>ordered</option>
        <option value="done" {{ 'selected' if st=='done' else '' }}>done</option>
      </select>
    </div>
  </div>

  <div id="unitsWrap" class="d-flex flex-column gap-4">
    {% for u in (units or []) %}
    {% set ui = loop.index0 %}
    <div class="card">
      <div class="card-header d-flex justify-content-between align-items-center">
        <strong>Appliance #{{ loop.index }}</strong>
        {% if not RO %}<button type="button" class="btn btn-sm btn-outline-danger del-unit">&times;</button>{% endif %}
      </div>

      <div class="card-body">
        <div class="row g-3 mb-3">
          <div class="col-md-4">
            <label class="form-label">Brand</label>
            <input name="units[{{ ui }}][brand]" class="form-control" value="{{ u.brand or '' }}" {{ ro }} {{ dis }}>
          </div>
          <div class="col-md-4">
            <label class="form-label">Model #</label>
            <input name="units[{{ ui }}][model]" class="form-control" maxlength="25"
                   value="{{ u.model or '' }}" {{ ro }} {{ dis }}>
          </div>
          <div class="col-md-4">
            <label class="form-label">Serial #</label>
            <input name="units[{{ ui }}][serial]" class="form-control" maxlength="25"
                   value="{{ u.serial or '' }}" {{ ro }} {{ dis }}>
          </div>
        </div>

        <div class="table-responsive">
          <table class="table table-sm table-bordered align-middle unit-table">
            <thead>
              <tr>
                <th>Part #</th>
                <th>Alt PN#</th>
                <th>Part name</th>
                <th class="text-end col-qty">Qty</th>
                <th class="text-end col-money">Unit ($)</th>
                <th class="text-end col-money">Total ($)</th>
                <th class="col-narrow">WH</th>
                <th class="col-narrow">Sup</th>
                <th style="width:80px;" title="Backorder">B/O</th>
                <th style="width:140px;">Stock hint</th>
                <th class="col-issue">Issue?</th>
                <th style="width:60px;"></th>
              </tr>
            </thead>
            <tbody>
              {% for r in (u.rows or []) %}
              {% set ri = loop.index0 %}
              <tr>
                <td><input class="form-control pn" name="units[{{ ui }}][rows][{{ ri }}][part_number]" value="{{ r.part_number or '' }}" maxlength="80" {{ ro }} {{ dis }}></td>
                <td><input class="form-control" name="units[{{ ui }}][rows][{{ ri }}][alt_numbers]" value="{{ r.alt_numbers or '' }}" {{ ro }} {{ dis }}></td>
                <td><input class="form-control" name="units[{{ ui }}][rows][{{ ri }}][part_name]" value="{{ r.part_name or '' }}" maxlength="120" {{ ro }} {{ dis }}></td>
                <td class="num"><input class="form-control qty" name="units[{{ ui }}][rows][{{ ri }}][quantity]" type="number" min="0" value="{{ r.quantity or 1 }}" {{ ro }} {{ dis }}></td>
                <td class="num"><input class="form-control unit-cost" name="units[{{ ui }}][rows][{{ ri }}][unit_cost]" type="number" step="0.01" min="0" value="{{ '%.2f'|format(r.unit_cost) if r.unit_cost is defined and r.unit_cost is not none else '0.00' }}" {{ ro }} {{ dis }}></td>
                <td class="num"><span class="line-total ro-input" data-value="0.00">0.00</span></td>
                <td><input class="form-control" name="units[{{ ui }}][rows][{{ ri }}][warehouse]" value="{{ r.warehouse or r.unit_label or '' }}" maxlength="120" {{ ro }} {{ dis }}></td>
                <td><input class="form-control supplier-input" name="units[{{ ui }}][rows][{{ ri }}][supplier]" list="suppliers_datalist" value="{{ r.supplier or '' }}" required {{ ro }} {{ dis }}></td>
                <td class="text-center">
                  <div class="form-check d-flex justify-content-center m-0">
                    <input class="form-check-input" type="checkbox" name="units[{{ ui }}][rows][{{ ri }}][backorder_flag]" {% if r.backorder_flag %}checked{% endif %} {{ dis }}>
                  </div>
                </td>
                <td class="hint">—</td>
                <td class="text-center issue-cell">
                  {% if not RO %}
                  <div class="form-check d-flex justify-content-center m-0">
                    <input type="checkbox" class="form-check-input issue-check"
                           name="issue_ids" value="{{ r.id or (ui ~ '_' ~ ri) }}">
                  </div>
                  {% else %}
                    <span class="text-muted">—</span>
                  {% endif %}
                </td>
                <td class="text-center">{% if not RO %}<button type="button" class="btn btn-sm btn-outline-danger del-row">&times;</button>{% endif %}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

        <div class="d-flex justify-content-between align-items-center">
          {% if not RO %}<button type="button" class="btn btn-outline-secondary add-row">+ Add part row</button>{% else %}<span></span>{% endif %}
          <div class="text-end"><strong>Unit subtotal:</strong> <span class="unit-subtotal">0.00</span></div>
        </div>
      </div>
    </div>
    {% endfor %}
  </div>

  {% if not RO %}
  <div class="my-3"><button type="button" class="btn btn-outline-primary" id="addUnit">+ Add appliance</button></div>
  {% endif %}

  <div class="d-flex justify-content-between align-items-center my-2">
    <div></div>
    <div class="text-end"><strong>Grand total:</strong> <span id="grandTotal">0.00</span></div>
  </div>

  <datalist id="suppliers_datalist">
    {% for s in recent_suppliers or [] %}
      <option value="{{ s }}"></option>
    {% endfor %}
  </datalist>

  <div class="d-flex gap-2">
    {% if not RO %}
      <button type="submit" class="btn btn-primary">Save</button>
      <button type="button" id="issueSelectedBtn" class="btn btn-success" {% if not IS_EDIT %}disabled title="Save WO first"{% endif %}>Issue selected</button>
    {% endif %}
    {% if IS_EDIT %}
      <a class="btn btn-outline-secondary" href="{{ url_for('inventory.wo_detail', wo_id=wo.id) }}">Back</a>
    {% else %}
      <button type="button" class="btn btn-outline-secondary" onclick="history.back()">Back</button>
    {% endif %}
  </div>
</form>

{% set issue_action = IS_EDIT and url_for('inventory.wo_issue_instock', wo_id=wo.id) or '#' %}
<form id="issueForm" method="post" action="{{ issue_action }}">
  <input type="hidden" name="wo_id" value="{{ wo.id if IS_EDIT else '' }}">
  <input type="hidden" name="part_ids" id="issue_part_ids">
</form>
{% endblock %}

{% block extra_js %}
<script>
(function(){
  // безопасные Jinja → JS константы (НЕ внутри backticks)
  const API_STOCK = "{{ url_for('inventory.api_stock_hint') }}";
  const IS_EDIT   = {{ 'true' if IS_EDIT else 'false' }};

  const unitsWrap   = document.getElementById('unitsWrap');
  const grandTotalEl= document.getElementById('grandTotal');
  const deliveryEl  = document.getElementById('deliveryFee');
  const markupEl    = document.getElementById('markupPercent');
  const issueBtn    = document.getElementById('issueSelectedBtn');

  const toMoney = (n)=> (Math.round((Number(n||0)+Number.EPSILON)*100)/100).toFixed(2);

  /* ===== totals ===== */
  function recomputeUnitSubtotal(card){
    const markup   = parseFloat(markupEl?.value||'0')||0;
    const delivery = parseFloat(deliveryEl?.value||'0')||0;
    let unitSum = 0;
    card.querySelectorAll('tbody tr').forEach(tr=>{
      const q = parseFloat(tr.querySelector('.qty')?.value||'0')||0;
      const c = parseFloat(tr.querySelector('.unit-cost')?.value||'0')||0;
      const line = (q*c)*(1+markup/100) + delivery;
      const cell = tr.querySelector('.line-total');
      if (cell){ const v = toMoney(line); cell.textContent=v; cell.dataset.value=v; }
      unitSum += line;
    });
    const us = card.querySelector('.unit-subtotal'); if (us) us.textContent = toMoney(unitSum);
    recomputeGrandTotal();
  }
  function recomputeGrandTotal(){
    let g=0;
    document.querySelectorAll('.unit-subtotal').forEach(x=> g += parseFloat(x.textContent||'0')||0);
    grandTotalEl.textContent = toMoney(g);
  }
  ['input','change'].forEach(ev=>{
    deliveryEl?.addEventListener(ev, ()=>document.querySelectorAll('#unitsWrap .card').forEach(recomputeUnitSubtotal));
    markupEl?.addEventListener(ev,   ()=>document.querySelectorAll('#unitsWrap .card').forEach(recomputeUnitSubtotal));
  });

  /* ===== enable/disable Issue by hint ===== */
  function setIssueEnabled(tr, enabled){
    const cb = tr.querySelector('.issue-check');
    if (!cb) return;
    if (enabled){
      cb.disabled = !IS_EDIT; // Только в режиме edit можно issue
      cb.removeAttribute('disabled');
    }else{
      cb.checked = false;
      cb.disabled = true;
      cb.setAttribute('disabled','disabled');
    }
  }

  /* ===== универсальный парсер остатка ===== */
  function extractAvailableCount(j){
    const keys=['qty_available','available_qty','available','on_hand','onhand','stock','in_stock','qty','count','quantity'];
    for(const k of keys){
      const v=j&&j[k]; if(v!==undefined && v!==null && !isNaN(Number(v))) return Number(v);
    }
    for(const wrap of ['data','result']){
      const o=j&&j[wrap];
      if(o && typeof o==='object'){
        for(const k of keys){
          const v=o[k]; if(v!==undefined && v!==null && !isNaN(Number(v))) return Number(v);
        }
      }
    }
    const sumArr=a=>Array.isArray(a)?a.reduce((s,x)=>s+(Number.isFinite(extractAvailableCount(x))?extractAvailableCount(x):0),0):0;
    return sumArr(j) || sumArr(j?.rows) || sumArr(j?.items) || sumArr(j?.data?.rows) || 0;
  }

  /* ===== STOCK hint с qty ===== */
  function fetchHint(tr){
    const pn  = (tr.querySelector('.pn')?.value||'').trim().toUpperCase();
    const qty = parseInt(tr.querySelector('.qty')?.value||'0',10)||0;
    const hintEl = tr.querySelector('.hint');

    if(!pn||qty<=0){
      if(hintEl) hintEl.textContent='—';
      setIssueEnabled(tr, false);
      return;
    }

    fetch(API_STOCK + '?pn=' + encodeURIComponent(pn) + '&qty=' + qty)
      .then(r=>r.ok ? r.json() : Promise.reject())
      .then(j=>{
        const t   = String(j?.hint || j?.status || '').toUpperCase();
        const qa  = extractAvailableCount(j);
        const isStock = /\b(STOCK|IN[-\s]?STOCK|ON HAND|AVAILABLE)\b/.test(t) || (qa >= qty);
        const label   = isStock ? 'STOCK' : 'WAIT';
        if (hintEl) hintEl.textContent = label + '/' + qa;
        setIssueEnabled(tr, isStock);
      })
      .catch(()=>{
        if(hintEl) hintEl.textContent='—';
        setIssueEnabled(tr, false);
      });
  }

  /* ===== handlers ===== */
  const unitsWrapEl = document.getElementById('unitsWrap');
  unitsWrapEl.addEventListener('input', (e)=>{
    const tr=e.target.closest('tr'); const card=e.target.closest('.card'); if(!card) return;
    if(tr && (e.target.classList.contains('qty')||e.target.classList.contains('unit-cost'))) recomputeUnitSubtotal(card);
    if(tr && (e.target.classList.contains('pn')||e.target.classList.contains('qty'))) fetchHint(tr);
  });

  unitsWrapEl.addEventListener('click',(e)=>{
    const card=e.target.closest('.card'); if(!card) return;
    if(e.target.classList.contains('del-unit')){ card.remove(); recomputeGrandTotal(); }
    if(e.target.classList.contains('add-row')){
      const tbody=card.querySelector('tbody');
      const ui=[...document.querySelectorAll('#unitsWrap .card')].indexOf(card);
      const ri=tbody.children.length;
      tbody.insertAdjacentHTML('beforeend', rowTemplate(ui,ri));
      recomputeUnitSubtotal(card);
    }
    if(e.target.classList.contains('del-row')){
      e.target.closest('tr')?.remove();
      recomputeUnitSubtotal(card);
    }
  });

  /* ===== Issue selected ===== */
  issueBtn?.addEventListener('click', ()=>{
    const selected = [];
    document.querySelectorAll('tbody tr').forEach((tr)=>{
      const cb = tr.querySelector('.issue-check');
      const raw = (tr.querySelector('.hint')?.textContent||'').trim().toUpperCase();
      const status = raw.split('/')[0];
      if (cb && cb.checked && status==='STOCK'){ selected.push(cb.value); }
    });
    if (selected.length===0){
      alert('Select at least one in-stock part (hint must be STOCK).');
      return;
    }
    document.getElementById('issue_part_ids').value = selected.join(',');
    document.getElementById('issueForm').submit();
  });

  /* ===== init ===== */
  document.querySelectorAll('#unitsWrap .card').forEach(recomputeUnitSubtotal);
  unitsWrapEl.querySelectorAll('tbody tr').forEach(fetchHint);

  /* ===== шаблон строки ===== */
  function rowTemplate(ui,ri){
    const ro = {{ RO and 'true' or 'false' }} ? 'disabled readonly' : '';
    const boDisabled = {{ RO and 'true' or 'false' }} ? 'disabled' : '';
    const delBtn = {{ RO and 'true' or 'false' }} ? '' : '<button type="button" class="btn btn-sm btn-outline-danger del-row">&times;</button>';
    return `
<tr>
  <td><input class="form-control pn" name="units[${ui}][rows][${ri}][part_number]" maxlength="80" ${ro}></td>
  <td><input class="form-control" name="units[${ui}][rows][${ri}][alt_numbers]" ${ro}></td>
  <td><input class="form-control" name="units[${ui}][rows][${ri}][part_name]" maxlength="120" ${ro}></td>
  <td class="num"><input class="form-control qty" name="units[${ui}][rows][${ri}][quantity]" type="number" min="0" value="1" ${ro}></td>
  <td class="num"><input class="form-control unit-cost" name="units[${ui}][rows][${ri}][unit_cost]" type="number" step="0.01" min="0" value="0.00" ${ro}></td>
  <td class="num"><span class="line-total ro-input" data-value="0.00">0.00</span></td>
  <td><input class="form-control" name="units[${ui}][rows][${ri}][warehouse]" maxlength="120" ${ro}></td>
  <td><input class="form-control supplier-input" name="units[${ui}][rows][${ri}][supplier]" list="suppliers_datalist" required ${ro}></td>
  <td class="text-center"><div class="form-check d-flex justify-content-center m-0"><input class="form-check-input" type="checkbox" name="units[${ui}][rows][${ri}][backorder_flag]" ${boDisabled}></div></td>
  <td class="hint">—</td>
  <td class="text-center issue-cell"><div class="form-check d-flex justify-content-center m-0"><input type="checkbox" class="form-check-input issue-check" name="issue_ids" value="${ui}_${ri}" disabled></div></td>
  <td class="text-center">${delBtn}</td>
</tr>`;
  }
})();
</script>
{% endblock %}

