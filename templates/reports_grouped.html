{% extends "base.html" %}

{# –°—Ç–∏–ª–∏ —É–∂–µ –≤—ã–Ω–µ—Å–µ–Ω—ã –≤ static/style.css #}

{% block content %}
<div class="reports-grouped">  {# scope: —Å—Ç–∏–ª–∏ –ø—Ä–∏–º–µ–Ω—è—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –Ω–∞ —ç—Ç–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ #}

  <div class="report-filters">
    <h2>Issued Parts Report (Grouped by Invoice)</h2>

    <form method="POST" class="mb-3">
      <div class="row g-3">
        <div class="col-auto">
          <label for="recipient">Issued To / Company / Technician:</label>
          <input type="text" id="recipient" name="recipient" class="form-control" value="{{ recipient or '' }}">
        </div>
        <div class="col-auto">
          <label for="reference_job">Reference Job:</label>
          <input type="text" id="reference_job" name="reference_job" class="form-control" value="{{ reference_job or '' }}">
        </div>
        <div class="col-auto">
          <label for="start_date">Start Date:</label>
          <input type="date" id="start_date" name="start_date" class="form-control" value="{{ start_date or '' }}">
        </div>
        <div class="col-auto">
          <label for="end_date">End Date:</label>
          <input type="date" id="end_date" name="end_date" class="form-control" value="{{ end_date or '' }}">
        </div>
        <div class="col-auto align-self-end">
          <button type="submit" class="btn btn-primary">Generate Report</button>
        </div>
      </div>
    </form>

    {% if invoices %}
      <h3>Results:</h3>
      <div class="d-flex flex-wrap gap-2 mb-3 report-buttons">
        <a href="{{ url_for('inventory.download_report_pdf',
                            start_date=start_date, end_date=end_date,
                            recipient=recipient, reference_job=reference_job) }}"
           class="btn btn-outline-secondary">üñ®Ô∏è Print Report</a>

        <a href="{{ url_for('inventory.dashboard') }}" class="btn btn-outline-primary">üè† Dashboard</a>
        <a href="{{ url_for('inventory.issue_part') }}" class="btn btn-outline-success">üßæ Issue Part</a>
      </div>
  </div> {# /report-filters #}

    {% for inv in invoices %}
    <div class="card mb-4 p-3 border">

      {# ===== –ó–∞–≥–æ–ª–æ–≤–æ–∫ –∫–∞—Ä—Ç–æ—á–∫–∏ –∏–Ω–≤–æ–π—Å–∞ ===== #}
      <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap">
        <div class="d-flex flex-wrap align-items-center gap-4" style="min-width:70%;">
          <div><strong>Issued To:</strong> {{ inv.issued_to }}</div>
          <div><strong>Reference Job:</strong> {{ inv.reference_job or 'N/A' }}</div>
          <div><strong>Issued By:</strong> {{ inv.issued_by }}</div>
          <div><strong>Issue Date:</strong> {{ inv.issue_date.strftime('%Y-%m-%d') }}</div>

          {% set is_return = (inv.reference_job and inv.reference_job.upper().startswith('RETURN'))
                             or (inv['items'] | selectattr('quantity','lt',0) | list | length > 0) %}
          <span class="badge {{ 'bg-warning text-dark' if is_return else 'bg-success' }}">
            {{ 'RETURNED' if is_return else 'ISSUED' }}
          </span>
        </div>

        {% if current_user.role in ['superadmin', 'admin'] %}
        <div class="d-flex align-items-center flex-wrap gap-2">
          <button type="submit" class="btn btn-success" form="saveform-{{ inv.id }}">Save Invoice</button>

          {% if not is_return %}
          <button type="submit" class="btn btn-warning"
                  form="retform-{{ inv.id }}"
                  onclick="return confirm('Create RETURN invoice from selected lines?');">
            Return Selected
          </button>
          {% endif %}

          {% set ALLOWED_CANCEL_ROLES = ['superadmin'] %}
          {% if current_user.role in ALLOWED_CANCEL_ROLES %}
          <button type="submit" class="btn btn-danger"
                  form="cancelform-{{ inv.id }}"
                  onclick="return confirm('Confirm cancel invoice?');">
            Cancel Invoice
          </button>
          {% endif %}

          {% if current_user.role == 'superadmin' and is_return %}
          <button type="submit" class="btn btn-outline-danger"
                  form="deleteform-{{ inv.id }}"
                  onclick="return confirm('Delete this RETURN invoice and reduce stock back?');">
            Delete Return (Superadmin)
          </button>
          {% endif %}
        </div>
        {% endif %}
      </div>

      {# ===== –°–∫—Ä—ã—Ç—ã–µ —Ñ–æ—Ä–º—ã –¥–ª—è –¥–µ–π—Å—Ç–≤–∏–π –ø–æ –∏–Ω–≤–æ–π—Å—É ===== #}
      <form id="saveform-{{ inv.id }}" class="d-none" method="POST"
            action="{{ url_for('inventory.update_invoice',
                               issued_to=inv.issued_to,
                               reference_job=inv.reference_job,
                               issued_by=inv.issued_by,
                               issue_date=inv.issue_date) }}">
        <input type="hidden" name="issue_date" value="{{ inv.issue_date.strftime('%Y-%m-%d %H:%M:%S') }}">
        <input type="hidden" name="action" value="save">
      </form>

      <form id="cancelform-{{ inv.id }}" class="d-none" method="POST"
            action="{{ url_for('inventory.cancel_invoice') }}">
        <input type="hidden" name="issued_to" value="{{ inv.issued_to }}">
        <input type="hidden" name="reference_job" value="{{ inv.reference_job }}">
        <input type="hidden" name="issued_by" value="{{ inv.issued_by }}">
        <input type="hidden" name="issue_date" value="{{ inv.issue_date.strftime('%Y-%m-%d %H:%M:%S') }}">
      </form>

      <form id="deleteform-{{ inv.id }}" class="d-none" method="POST"
            action="{{ url_for('inventory.delete_return_invoice') }}">
        <input type="hidden" name="issued_to" value="{{ inv.issued_to }}">
        <input type="hidden" name="reference_job" value="{{ inv.reference_job or '' }}">
        <input type="hidden" name="issued_by" value="{{ inv.issued_by }}">
        <input type="hidden" name="issue_date" value="{{ inv.issue_date.strftime('%Y-%m-%d %H:%M:%S') }}">
      </form>

      {# —Ñ–æ—Ä–º–∞ –¥–ª—è –≤—ã–±–æ—Ä–æ—á–Ω–æ–≥–æ –≤–æ–∑–≤—Ä–∞—Ç–∞ #}
      <form id="retform-{{ inv.id }}" method="POST" action="{{ url_for('inventory.create_return_invoice') }}"></form>
      <input type="hidden" form="retform-{{ inv.id }}" name="issued_to"     value="{{ inv.issued_to }}">
      <input type="hidden" form="retform-{{ inv.id }}" name="reference_job" value="{{ inv.reference_job or '' }}">
      <input type="hidden" form="retform-{{ inv.id }}" name="issued_by"     value="{{ inv.issued_by }}">
      <input type="hidden" form="retform-{{ inv.id }}" name="issue_date"    value="{{ inv.issue_date.strftime('%Y-%m-%d %H:%M:%S') }}">

      {# ===== –¢–∞–±–ª–∏—Ü–∞ —Å—Ç—Ä–æ–∫ –∏–Ω–≤–æ–π—Å–∞ ===== #}
      <div class="report-table-wrap">
        <table class="table table-bordered table-sm table-sticky table-compact">
          <colgroup>
            <col class="col-check">
            <col class="col-pn">
            <col class="col-name">
            <col class="col-qty">
            <col class="col-rqty">
            <col class="col-cost">
            <col class="col-total">
            <col class="col-issued">
            <col class="col-refjob">
            <col class="col-date">
            {% if current_user.role in ['superadmin', 'admin'] %}
            <col class="col-actions">
            {% endif %}
          </colgroup>

          <thead>
            <tr>
              <th class="text-center">
                {% if not is_return %}
                <input type="checkbox"
                       onclick="document.querySelectorAll('input.row-check[data-retform=\'{{ inv.id }}\']:not(:disabled)').forEach(cb=>cb.checked=this.checked)">
                {% endif %}
              </th>
              <th>Part Number</th>
              <th>Part Name</th>
              <th class="text-end">Quantity</th>
              <th class="text-end">Return Qty</th>
              <th class="text-end">Unit Cost</th>
              <th class="text-end">Total</th>
              <th>Issued To</th>
              <th>Reference Job</th>
              <th>Issue Date</th>
              {% if current_user.role in ['superadmin', 'admin'] %}
              <th>Actions</th>
              {% endif %}
            </tr>
          </thead>

          <tbody>
            {% for item in inv['items'] %}
            {% set issued_qty = item.quantity or 0 %}
            {% set max_return = issued_qty if issued_qty > 0 else 0 %}

            <tr>
              {# —á–µ–∫–±–æ–∫—Å –≤—ã–±–æ—Ä–∞ —Å—Ç—Ä–æ–∫–∏ #}
              <td class="text-center">
                {% if not is_return and max_return > 0 %}
                  <input class="row-check"
                         type="checkbox"
                         name="line_ids"
                         value="{{ item.id }}"
                         data-retform="{{ inv.id }}"
                         form="retform-{{ inv.id }}">
                {% else %}
                  <input class="row-check" type="checkbox" disabled>
                {% endif %}
              </td>

              {# Part Number ‚Äî ¬´–ø—Å–µ–≤–¥–æ-–∏–Ω–ø—É—Ç¬ª –¥–ª—è –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏—è –ø–æ –≤—ã—Å–æ—Ç–µ #}
              <td><span class="ro-input">{{ item.part.part_number }}</span></td>

              {# Part Name ‚Äî —Ç–µ–∫—Å—Ç –æ–±—Ä–µ–∑–∞–µ–º —Å —Ç—Ä–æ–µ—Ç–æ—á–∏–µ–º, —Ç–æ–∂–µ ¬´–ø—Å–µ–≤–¥–æ-–∏–Ω–ø—É—Ç¬ª #}
              <td>
                <span class="ro-input text-ellipsis" title="{{ item.part.name }}">
                  {{ item.part.name }}
                </span>
              </td>

              {# Quantity #}
              <td class="text-end {{ 'text-danger fw-bold' if item.quantity < 0 else '' }}">
                {{ item.quantity }}
              </td>

              {# Return Qty #}
              <td class="text-end">
                {% if not is_return and max_return > 0 %}
                  <input type="number"
                         name="qty_{{ item.id }}"
                         min="1" max="{{ max_return }}"
                         value="1"
                         class="form-control form-control-sm text-end"
                         form="retform-{{ inv.id }}">
                {% else %}
                  <input type="number" class="form-control form-control-sm text-end" value="0" disabled>
                {% endif %}
              </td>

              {# Unit Cost #}
              <td class="text-end">
                {% if current_user.role in ['superadmin', 'admin'] %}
                  <form method="POST"
                        action="{{ url_for('inventory.update_report_record', record_id=item.id) }}"
                        class="m-0">
                    <input type="text" name="unit_cost"
                           value="{{ '%.2f'|format(item.unit_cost_at_issue) }}"
                           class="form-control form-control-sm text-end"
                           style="max-width:90px;">
                  </form>
                {% else %}
                  ${{ '%.2f'|format(item.unit_cost_at_issue) }}
                {% endif %}
              </td>

              {# Total #}
              <td class="text-end">
                ${{ '%.2f'|format(item.quantity * item.unit_cost_at_issue) }}
              </td>

              {# Issued To #}
              <td class="col-issued">
                {% if current_user.role in ['superadmin', 'admin'] %}
                  <form method="POST"
                        action="{{ url_for('inventory.update_report_record', record_id=item.id) }}"
                        class="m-0">
                    <input type="text" name="issued_to" value="{{ item.issued_to }}"
                           class="form-control form-control-sm w-issued">
                  </form>
                {% else %}
                  <span class="ro-input w-issued">{{ item.issued_to }}</span>
                {% endif %}
              </td>

              {# Reference Job #}
              <td class="col-refjob">
                {% if current_user.role in ['superadmin', 'admin'] %}
                  <form method="POST"
                        action="{{ url_for('inventory.update_report_record', record_id=item.id) }}"
                        class="m-0">
                    <input type="text" name="reference_job" value="{{ item.reference_job or '' }}"
                           class="form-control form-control-sm w-refjob">
                  </form>
                {% else %}
                  <span class="ro-input w-refjob">{{ item.reference_job or 'N/A' }}</span>
                {% endif %}
              </td>

              {# Issue Date #}
              <td class="col-date">
                {% if current_user.role == 'superadmin' %}
                  <form method="POST"
                        action="{{ url_for('inventory.update_report_record', record_id=item.id) }}"
                        class="m-0">
                    <input type="date" name="issue_date"
                           value="{{ item.issue_date.strftime('%Y-%m-%d') }}"
                           class="form-control form-control-sm w-date">
                  </form>
                {% else %}
                  <span class="ro-input w-date">{{ item.issue_date.strftime('%Y-%m-%d') }}</span>
                {% endif %}
              </td>

              {% if current_user.role in ['superadmin', 'admin'] %}
              <td>
                <form method="POST"
                      action="{{ url_for('inventory.update_report_record', record_id=item.id) }}"
                      class="m-0">
                  <button type="submit" class="btn btn-sm btn-success">Save</button>
                </form>
              </td>
              {% endif %}
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      {% if inv['items']|length > 0 %}
        <a href="{{ url_for('inventory.view_invoice_pdf',
                      issued_to=inv.issued_to,
                      reference_job=inv.reference_job,
                      issued_by=inv.issued_by,
                      issue_date=inv.issue_date.strftime('%Y-%m-%d %H:%M:%S')) }}"
           target="_blank" class="btn btn-outline-primary mb-3">
          üñ®Ô∏è Print Invoice
        </a>
      {% endif %}

      <h5>Total Invoice Value: ${{ '%.2f'|format(inv.total_value) }}</h5>
    </div>
    {% endfor %}

    <h4>Grand Total: ${{ '%.2f'|format(total) }}</h4>
  {% else %}
    <p>No records found.</p>
  {% endif %}

</div> {# /.reports-grouped #}
{% endblock %}



