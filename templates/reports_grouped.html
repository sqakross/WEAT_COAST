{% extends "base.html" %}

{% block content %}
<style>
  /* —Ñ–∏–∫—Å–∏—Ä—É–µ–º –ø–∞–Ω–µ–ª—å —Ñ–∏–ª—å—Ç—Ä–æ–≤ –ø–æ–¥ –≤–µ—Ä—Ö–Ω–∏–º navbar (–ø–æ–¥—Å—Ç—Ä–æ–π top –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏) */
  .filters-sticky {
    position: sticky;
    top: 56px;              /* –µ—Å–ª–∏ —É —Ç–µ–±—è –¥—Ä—É–≥–æ–π navbar ‚Äî –ø–æ–ø—Ä–∞–≤—å –∑–Ω–∞—á–µ–Ω–∏–µ */
    z-index: 10;
    background: #f8f9fa;
    padding: .75rem .75rem 0 .75rem;
    border-bottom: 1px solid #dee2e6;
  }
  .invoice-toolbar {
    display: flex;
    flex-wrap: wrap;
    justify-content: space-between; /* –ª–µ–≤–æ / –ø—Ä–∞–≤–æ */
    gap: .5rem 1rem;
  }
  .toolbar-left,
  .toolbar-right {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    gap: .5rem;
  }
  .apply-scope {
    display: inline-flex;
    align-items: center;
    gap: .25rem;
    margin-right: .5rem;
  }

  /* –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –∏–Ω–≤–æ–π—Å–∞, –Ω–∞ –∫–æ—Ç–æ—Ä—ã–π –ø—Ä–∏—à–ª–∏ –ø–æ –Ω–æ–º–µ—Ä—É */
  .focused-invoice {
    box-shadow: 0 0 0 3px #0d6efd;
    position: relative;
    z-index: 5;
    animation: pulse-focus 1.4s ease-out 1;
  }
  @keyframes pulse-focus {
    0%   { box-shadow: 0 0 0 6px rgba(13,110,253,0.6); }
    100% { box-shadow: 0 0 0 0 rgba(13,110,253,0); }
  }
</style>

<div class="reports-grouped">
  <div class="report-filters filters-sticky">
    <h2 class="mb-2">Issued Parts Report (Grouped by Invoice)</h2>

    {# ------------------ Filters form ------------------ #}
    <form method="POST" class="mb-3">
      <div class="row g-3">
        <div class="col-auto">
          <label for="recipient" class="form-label">Issued To / Company / Technician:</label>
          <input type="text" id="recipient" name="recipient" class="form-control" value="{{ recipient or '' }}">
        </div>
        <div class="col-auto">
          <label for="reference_job" class="form-label">Reference Job:</label>
          <input type="text" id="reference_job" name="reference_job" class="form-control" value="{{ reference_job or '' }}">
        </div>
        <div class="col-auto">
          <label for="start_date" class="form-label">Start Date:</label>
          <input type="date" id="start_date" name="start_date" class="form-control" value="{{ start_date or '' }}">
        </div>
        <div class="col-auto">
          <label for="end_date" class="form-label">End Date:</label>
          <input type="date" id="end_date" name="end_date" class="form-control" value="{{ end_date or '' }}">
        </div>
        <div class="col-auto">
          <label for="invoice_number" class="form-label">Invoice #:</label>
          <input type="text" id="invoice_number" name="invoice_number" class="form-control" value="{{ invoice or '' }}">
        </div>
        <div class="col-auto align-self-end">
          <button type="submit" class="btn btn-primary">Generate Report</button>
        </div>
      </div>

      {% if invoices %}
        <div class="d-flex flex-wrap gap-2 my-2">
          <a
            href="{{ url_for('inventory.download_report_pdf',
                             start_date=start_date,
                             end_date=end_date,
                             recipient=recipient,
                             reference_job=reference_job,
                             invoice_number=invoice) }}"
            class="btn btn-outline-secondary">üñ®Ô∏è Print Report</a>

          <a href="{{ url_for('inventory.dashboard') }}" class="btn btn-outline-primary">üè† Dashboard</a>
          <a href="{{ url_for('inventory.issue_part') }}" class="btn btn-outline-success">üßæ Issue Part</a>
        </div>
      {% endif %}
    </form>
  </div> {# /.report-filters #}

  {% if invoices %}
    <h3 class="mt-3">Results:</h3>

    {# ------------------ Invoice cards loop ------------------ #}
    {# —Å–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ issue_date –≤ –æ–±—Ä–∞—Ç–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ, —á—Ç–æ–±—ã –Ω–æ–≤—ã–π –±—ã–ª —Å–≤–µ—Ä—Ö—É #}
    {% for inv in invoices|sort(attribute='issue_date', reverse=True) %}
      {% set lines = inv['items'] %}
      {% set inv_no_raw = inv.invoice_number %}
      {% set inv_no_str = ('%06d' % (inv_no_raw|int)) if inv_no_raw is not none else '‚Äî' %}

      {# –ø—Ä–∏–∑–Ω–∞–∫, —á—Ç–æ —ç—Ç–æ "–∞–∫—Ç–∏–≤–Ω—ã–π" –∏–Ω–≤–æ–π—Å (–ø–æ –Ω–æ–º–µ—Ä—É —Ñ–∏–ª—å—Ç—Ä–∞) #}
      {% set is_focused = invoice and inv.invoice_number and (invoice|string == inv.invoice_number|string) %}

      {# batch, –µ—Å–ª–∏ —ç—Ç–æ ¬´–Ω–æ–≤—ã–π¬ª –∏–Ω–≤–æ–π—Å: –±–µ—Ä—ë–º —É –ø–µ—Ä–≤–æ–π —Å—Ç—Ä–æ–∫–∏ #}
      {% set batch = (lines and lines[0].batch) if lines else None %}

      {# —Å—É–º–º—ã –ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞–º #}
      {% set qty_total = (lines | map(attribute='quantity') | sum) or 0 %}
      {% set used_total = (lines
                           | selectattr('consumed_qty','ne', none)
                           | map(attribute='consumed_qty')
                           | sum) or 0 %}
      {% set remaining_total = (qty_total - (used_total or 0)) if qty_total else 0 %}
      {% if remaining_total < 0 %}{% set remaining_total = 0 %}{% endif %}
      {% set pct = ( (used_total or 0) * 100 // qty_total ) if qty_total else 0 %}

      {# —Å—Ç–∞—Ç—É—Å –∫–∞—Ä—Ç–æ—á–∫–∏ + –∫–ª–∞—Å—Å—ã #}
      {% if qty_total <= 0 or (used_total or 0) <= 0 %}
        {% set status_text = 'OPEN' %}
        {% set badge_class  = 'bg-secondary' %}
        {% set card_class   = 'border-secondary-subtle' %}
        {% set card_bg      = 'background-color:#f8f9fa;' %}
        {% set progress_class = '' %}
      {% elif (used_total or 0) >= qty_total %}
        {% set status_text = 'CONSUMED' %}
        {% set badge_class  = 'bg-success' %}
        {% set card_class   = 'border-success-subtle' %}
        {% set card_bg      = 'background-color:#f1f8f4;' %}
        {% set progress_class = 'bg-success' %}
      {% else %}
        {% set status_text = 'PARTIAL ' ~ (used_total or 0) ~ '/' ~ qty_total %}
        {% set badge_class  = 'bg-warning text-dark' %}
        {% set card_class   = 'border-warning-subtle' %}
        {% set card_bg      = 'background-color:#fff8e1;' %}
        {% set progress_class = 'bg-warning' %}
      {% endif %}

      {# –ø—Ä–∏–∑–Ω–∞–∫ –≤–æ–∑–≤—Ä–∞—Ç–∞ #}
      {% set ref_up = ((inv.reference_job or '')|upper) %}
      {% set is_return = (ref_up[:6] == 'RETURN')
                         or (lines | selectattr('quantity','lt',0) | list | length > 0) %}

      {# —Å—Ç–æ–∫–æ–≤—ã–π –ª–∏ –∏–Ω–≤–æ–π—Å #}
      {% set is_stock = false %}
      {% if batch %}
        {% set is_stock = ( (batch.is_stock)
                            or (batch.reference_job and ((batch.reference_job|lower)[:5] == 'stock')) ) %}
      {% else %}
        {% set is_stock = (inv.reference_job and ((inv.reference_job|lower)[:5] == 'stock')) %}
      {% endif %}

      <div class="card mb-4 p-3 {{ card_class }} invoice-card{% if is_focused %} focused-invoice{% endif %}"
           style="{{ card_bg }}"
           id="invoice-{{ inv.invoice_number or 'no-num-' ~ loop.index }}">
        <div class="d-flex justify-content-between align-items-start flex-wrap gap-2 mb-2">
          <div class="d-flex flex-wrap align-items-center gap-2">
            <div class="d-flex flex-wrap align-items-center gap-2">
              <span><strong>Issued To:</strong> {{ inv.issued_to }}</span>
              <span>‚Ä¢</span>
              <span><strong>Ref:</strong> {{ inv.reference_job or 'N/A' }}</span>
              <span>‚Ä¢</span>
              <span><strong>Issued By:</strong> {{ inv.issued_by }}</span>
              <span>‚Ä¢</span>
              <span><strong>Date:</strong> {{ inv.issue_date.strftime('%Y-%m-%d') }}</span>
              <span>‚Ä¢</span>
              <span><strong>Invoice #:</strong> {{ inv_no_str }}</span>
            </div>

            <div class="d-flex flex-wrap align-items-center gap-2 ms-2">
              <span class="badge {{ badge_class }}">{{ status_text }}</span>
              {% if is_stock %}
                <span class="badge bg-primary">STOCK</span>
              {% endif %}
              <span class="badge {{ 'bg-warning text-dark' if is_return else 'bg-success' }}">
                {{ 'RETURNED' if is_return else 'ISSUED' }}
              </span>
            </div>
          </div>

          <div class="text-end">
            <div class="small text-muted">Totals (qty):</div>
            <div class="d-flex flex-wrap gap-2 justify-content-end">
              <span class="badge bg-light text-dark">Total: {{ qty_total }}</span>
              <span class="badge bg-light text-dark">Consumed: {{ used_total or 0 }}</span>
              <span class="badge {{ 'bg-success' if remaining_total == 0 else 'bg-info' }}">Remaining: {{ remaining_total }}</span>
            </div>
          </div>
        </div>

        {# –ü—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä #}
        <div class="mb-3">
          <div class="progress" style="height: 8px;">
            <div class="progress-bar {{ progress_class }}" role="progressbar"
                 style="width: {{ pct }}%;" aria-valuenow="{{ pct }}" aria-valuemin="0" aria-valuemax="100">
            </div>
          </div>
          <div class="d-flex justify-content-between small text-muted mt-1">
            <span>Consumed {{ used_total or 0 }} / {{ qty_total }}</span>
            <span>{{ pct }}%</span>
          </div>
        </div>

        {# ------------------ –ü–∞–Ω–µ–ª—å –¥–µ–π—Å—Ç–≤–∏–π: —Å–ª–µ–≤–∞/—Å–ø—Ä–∞–≤–∞ ------------------ #}
        {% if current_user.role in ['superadmin', 'admin', 'user'] %}
        <form id="form-{{ inv.id }}"
              method="post"
              action="{{ url_for('inventory.update_invoice') }}"
              class="mb-3 invoice-toolbar">

          <div class="toolbar-left">
            {# –ø—Ä–∏–º–µ–Ω–∏–º–æ—Å—Ç—å: –≤–µ—Å—å –∏–Ω–≤–æ–π—Å –∏–ª–∏ –≤—ã–±—Ä–∞–Ω–Ω—ã–µ —Å—Ç—Ä–æ–∫–∏ #}
            {% set has_selectable = lines | selectattr('quantity','gt',0) | list | length > 0 %}
            {% if has_selectable %}
              <div class="apply-scope" role="group" aria-label="apply-scope">
                <span class="me-1 small text-muted">Apply to:</span>

                <input type="radio" class="btn-check" name="apply_scope" id="scope_all_{{ inv.id }}" value="all" checked>
                <label class="btn btn-outline-secondary btn-sm" for="scope_all_{{ inv.id }}" title="Apply to all rows in this invoice">
                  Entire invoice
                </label>

                <input type="radio" class="btn-check" name="apply_scope" id="scope_sel_{{ inv.id }}" value="selected">
                <label class="btn btn-outline-secondary btn-sm" for="scope_sel_{{ inv.id }}" title="Apply only to checked rows">
                  Selected rows
                </label>
              </div>
            {% endif %}

            {# –ö–ù–û–ü–ö–ò –°–õ–ï–í–ê: consume / unconsume / return #}
            <button type="submit"
                    class="btn btn-outline-primary"
                    name="do_consume" value="1"
                    formaction="{{ url_for('inventory.consume_invoice') }}"
                    formmethod="post"
                    title="Increase consumed_qty for chosen scope">
              Mark Consumed
            </button>

            <button type="submit"
                    class="btn btn-outline-secondary"
                    name="do_unconsume" value="1"
                    formaction="{{ url_for('inventory.unconsume_invoice') }}"
                    formmethod="post"
                    title="Reset consumed_qty for chosen scope">
              Unconsume Selected
            </button>

            {% if not is_return and has_selectable %}
              <button type="submit" class="btn btn-warning"
                      name="do_return" value="1"
                      onclick="return confirm('Create RETURN invoice from selected rows?');">
                Return Selected
              </button>
            {% endif %}
          </div>

          <div class="toolbar-right">
            {# –°–ü–†–ê–í–ê: —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏ —É–¥–∞–ª–∏—Ç—å #}
            <button type="submit" class="btn btn-success" name="do_return" value="0">
              Save Invoice
            </button>

            {% if current_user.role == 'superadmin' and is_return %}
              <button type="submit" class="btn btn-outline-danger"
                      name="delete_return" value="1"
                      onclick="return confirm('Delete this RETURN invoice and adjust stock?');">
                Delete Return
              </button>
            {% endif %}

            {% if current_user.role == 'superadmin' and not is_return and inv.invoice_number %}
              <button type="submit" class="btn btn-outline-danger"
                      name="delete_invoice" value="{{ inv.invoice_number }}"
                      onclick="return confirm('Delete ENTIRE invoice (all rows) and adjust stock?');">
                Delete Invoice
              </button>
            {% endif %}
          </div>

          {# —Å–∫—Ä—ã—Ç—ã–µ –ø–æ–ª—è –≥—Ä—É–ø–ø—ã #}
          <input type="hidden" name="group_issued_to"     value="{{ inv.issued_to }}">
          <input type="hidden" name="group_reference_job" value="{{ inv.reference_job or '' }}">
          <input type="hidden" name="group_issued_by"     value="{{ inv.issued_by }}">
          <input type="hidden" name="group_issue_date"    value="{{ inv.issue_date.strftime('%Y-%m-%d %H:%M:%S') }}">
          <input type="hidden" name="location"            value="{{ inv.location or '' }}">
          <input type="hidden" name="issued_by"  value="{{ current_user.username }}">
          <input type="hidden" name="issue_date" value="{{ inv.issue_date.strftime('%Y-%m-%d %H:%M:%S') }}">
          <input type="hidden" name="issued_to"  value="{{ inv.issued_to }}">
          <input type="hidden" name="reference_job" value="{{ inv.reference_job or '' }}">
          {% if inv.invoice_number %}
            <input type="hidden" name="invoice_number" value="{{ inv.invoice_number }}">
          {% endif %}
        </form>
        {% endif %}

        {# ------------------ Lines table ------------------ #}
        {% if lines|length > 0 %}
          <div class="table-responsive">
            <table class="table table-sm align-middle">
              <thead>
                <tr>
                  <th style="width:52px;">
                    <input type="checkbox"
                           onclick="for (const cb of this.closest('table').querySelectorAll('.linecb:not([disabled])')) cb.checked = this.checked;">
                  </th>
                  <th>Part Number</th>
                  <th>Part Name</th>
                  <th class="text-end">Qty</th>
                  <th class="text-end">Consumed</th>
                  <th class="text-end">Remaining</th>
                  <th class="text-end">Unit Cost</th>
                  <th class="text-end">Total</th>
                  <th>Issued To</th>
                  <th>Reference Job</th>
                  <th>Issue Date</th>
                  <th>Location</th>
                </tr>
              </thead>
              <tbody>
                {% for it in lines %}
                  {% set row_is_return = (it.quantity or 0) < 0 %}
                  {% set it_qty = it.quantity or 0 %}
                  {% set it_used = it.consumed_qty or 0 %}
                  {% set it_rem = it_qty - it_used %}
                  {% if it_rem < 0 %}{% set it_rem = 0 %}{% endif %}

                  <tr class="{{ 'table-warning' if row_is_return else '' }}">
                    <td>
                      <div class="d-flex align-items-center gap-2">
                        <input class="linecb" type="checkbox" name="record_ids[]" value="{{ it.id }}" form="form-{{ inv.id }}" {% if row_is_return %}disabled{% endif %}>
                        <input type="number"
                               name="qty_{{ it.id }}"
                               class="form-control form-control-sm return-qty"
                               style="width:70px"
                               inputmode="numeric"
                               pattern="\d*"
                               step="1"
                               min="0"
                               max="{{ it_qty }}"
                               title="Qty to consume now (max {{ it_qty }})"
                               value="{{ 1 if it_qty > 0 else 0 }}"
                               form="form-{{ inv.id }}"
                               {% if row_is_return %}disabled{% endif %}>
                      </div>
                    </td>

                    <td>{{ it.part.part_number if it.part else '' }}</td>
                    <td>{{ it.part.name if it.part else '' }}</td>

                    {% if current_user.role == 'superadmin' %}
                      <td class="text-end">
                        <input type="number" step="1" class="form-control form-control-sm text-end"
                               name="edit_qty_{{ it.id }}" value="{{ it_qty }}" form="form-{{ inv.id }}">
                      </td>
                      <td class="text-end">{{ it_used }}</td>
                      <td class="text-end">{{ it_rem }}</td>
                      <td class="text-end">
                        <input type="number" step="0.01" class="form-control form-control-sm text-end"
                               name="edit_ucost_{{ it.id }}" value="{{ (it.unit_cost_at_issue or 0)|round(2) }}" form="form-{{ inv.id }}">
                      </td>
                      <td class="text-end">{{ '%.2f'|format(it_qty*(it.unit_cost_at_issue or 0)) }}</td>
                      <td>
                        <input type="text" class="form-control form-control-sm"
                               name="edit_issued_to_{{ it.id }}" value="{{ it.issued_to }}" form="form-{{ inv.id }}">
                      </td>
                      <td>
                        <input type="text" class="form-control form-control-sm"
                               name="edit_refjob_{{ it.id }}" value="{{ it.reference_job }}" form="form-{{ inv.id }}">
                      </td>
                    {% else %}
                      <td class="text-end">{{ it_qty }}</td>
                      <td class="text-end">{{ it_used }}</td>
                      <td class="text-end">{{ it_rem }}</td>
                      <td class="text-end">{{ '%.2f'|format(it.unit_cost_at_issue or 0) }}</td>
                      <td class="text-end">{{ '%.2f'|format(it_qty*(it.unit_cost_at_issue or 0)) }}</td>
                      <td>{{ it.issued_to }}</td>
                      <td>{{ it.reference_job }}</td>
                    {% endif %}

                    <td>{{ it.issue_date.strftime('%Y-%m-%d') if it.issue_date }}</td>
                    <td>{{ it.location or (it.part.location if it.part else '') }}</td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>

          {# Print invoice #}
          {% if inv.invoice_number %}
            <a href="{{ url_for('inventory.view_invoice_pdf', invoice_number=inv.invoice_number) }}"
               target="_blank" class="btn btn-outline-primary mb-3">üñ®Ô∏è Print Invoice</a>
          {% else %}
            <a href="{{ url_for('inventory.view_invoice_pdf',
                                 issued_to=inv.issued_to,
                                 reference_job=inv.reference_job,
                                 issued_by=inv.issued_by,
                                 issue_date=inv.issue_date.strftime('%Y-%m-%d %H:%M:%S')) }}"
               target="_blank" class="btn btn-outline-primary mb-3">üñ®Ô∏è Print Invoice</a>
          {% endif %}
        {% endif %}

        <div class="d-flex justify-content-between align-items-center">
          <h5 class="mb-0">Total Invoice Value: ${{ '%.2f'|format(inv.total_value) }}</h5>
          <div class="small text-muted">
            Qty totals ‚Äî Total: {{ qty_total }}, Consumed: {{ used_total or 0 }}, Remaining: {{ remaining_total }}
          </div>
        </div>
      </div>
    {% endfor %}

    <h4>Grand Total: ${{ '%.2f'|format(total) }}</h4>
  {% else %}
    <p class="mt-3">No records found.</p>
  {% endif %}
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
  // –ï—Å–ª–∏ –µ—Å—Ç—å "–∞–∫—Ç–∏–≤–Ω—ã–π" –∏–Ω–≤–æ–π—Å (–ø–æ –Ω–æ–º–µ—Ä—É –≤ —Ñ–∏–ª—å—Ç—Ä–µ) ‚Äì —Å–∫—Ä–æ–ª–ª–∏–º –∫ –Ω–µ–º—É
  const focused = document.querySelector('.focused-invoice');
  if (focused) {
    const offset = 120; // —á—Ç–æ–±—ã –Ω–µ –ø–æ–¥–ª–µ–∑ –ø–æ–¥ navbar
    const rect = focused.getBoundingClientRect();
    const top = rect.top + window.pageYOffset - offset;
    window.scrollTo({ top: top, behavior: 'smooth' });
  }
});
</script>
{% endblock %}
